<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†Ø¸ÙˆÙ…Ø© ØªÙƒÙˆÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª - ÙƒÙØ± ØµÙ‚Ø±</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
--primary:#1a5276;
--secondary:#27ae60;
--accent:#d35400;
--bg:#f4f7f9;
--text:#2c3e50;
}
body{
font-family:Segoe UI,Arial;
background:var(--bg);
margin:0;
color:var(--text);
padding-bottom:90px;
}
header{
background:var(--primary);
color:#fff;
padding:15px 5%;
display:flex;
justify-content:space-between;
align-items:center;
border-bottom:4px solid var(--accent);
}
.container{max-width:1000px;margin:30px auto;padding:0 20px;}
.card{
background:#fff;
padding:30px;
border-radius:20px;
box-shadow:0 10px 25px rgba(0,0,0,.07);
}
.page-title{text-align:center;color:var(--primary);margin-bottom:30px;}
.form-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
gap:20px;
}
.input-group{display:flex;flex-direction:column;}
.input-group label{margin-bottom:6px;font-weight:700;}
.input-group input,.input-group select{
padding:12px;border:2px solid #e0e6ed;border-radius:12px;
}
#submitBtn{
width:100%;
background:var(--secondary);
color:#fff;
padding:15px;
border:none;
border-radius:12px;
font-size:18px;
font-weight:800;
cursor:pointer;
}
.admin-content{display:none;width:95%;margin:20px auto;}
table{
width:100%;
border-collapse:collapse;
background:#fff;
border-radius:12px;
overflow:hidden;
}
th,td{
padding:10px;
border-bottom:1px solid #eee;
text-align:center;
font-size:14px;
}
th{background:#ecf0f1;}
button{cursor:pointer;border-radius:8px;padding:6px 10px;border:none;}
.engineer-footer{
background:#1c2833;color:#d5dbdb;text-align:center;
padding:10px;position:fixed;bottom:0;width:100%;
border-top:3px solid var(--accent);
}
</style>
</head>

<body>

<header>
<div>
<h2>Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±</h2>
<p>ØªØ­ÙŠØ§Øª Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</p>
</div>
<button id="loginBtn">ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
</header>

<div class="container" id="citizenPage">
<div class="card">
<h2 class="page-title">ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h2>
<div class="form-grid">
<div class="input-group">
<label>Ø§Ù„Ø§Ø³Ù…</label>
<input id="ownerName">
</div>
<div class="input-group">
<label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</label>
<input id="nationalId">
</div>
<div class="input-group">
<label>Ø§Ù„Ù‡Ø§ØªÙ</label>
<input id="phone">
</div>
<div class="input-group">
<label>Ø§Ù„Ù†ÙˆØ¹</label>
<select id="vType">
<option>ØªÙˆÙƒØªÙˆÙƒ</option>
<option>Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„</option>
<option>ØªØ±ÙˆØ³ÙŠÙƒÙ„</option>
</select>
</div>
<div class="input-group">
<label>Ø§Ù„ÙˆØµÙ</label>
<input id="vDesc">
</div>
<div class="input-group">
<label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
<input id="address">
</div>
<div class="input-group">
<label>Ø§Ù„ØµÙˆØ±</label>
<input type="file" id="multiFiles" multiple accept="image/*">
</div>
</div>
<button id="submitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
</div>
</div>

<div id="adminPage" class="admin-content">
<h2>Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
<table id="excelTable">
<thead>
<tr>
<th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
<th>Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
<th>Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ø§Ù„Ù†ÙˆØ¹</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø§Ù„ÙƒÙˆØ¯</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>
<button id="exportExcelBtn">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
</div>

<footer class="engineer-footer">
ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© <b>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ù‡Ù†Ø¯ Ø¥ÙŠÙ‡Ø§Ø¨ Ø§Ù„ØªÙ‡Ø§Ù…ÙŠ</b>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyC0GsXy-mODZ_O2uqFJMKsjmK9bNDbrU9U",
authDomain:"system-storage-bd0ed.firebaseapp.com",
projectId:"system-storage-bd0ed"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const dbRef = collection(db,"orders");

async function generateVehicleCode(type){
const prefix = type==="ØªÙˆÙƒØªÙˆÙƒ"?"TK":type==="Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„"?"MT":"TR";
const q = query(dbRef,where("vType","==",type));
const snap = await getDocs(q);
return `KS-${prefix}-${String(snap.size+1).padStart(6,"0")}`;
}

document.getElementById("submitBtn").onclick = async ()=>{
const files = multiFiles.files;
if(!files.length) return alert("Ø£Ø¶Ù ØµÙˆØ±");

await addDoc(dbRef,{
owner:ownerName.value,
nationalId:nationalId.value,
phone:phone.value,
vType:vType.value,
vDesc:vDesc.value,
address:address.value,
images:[],
timestamp:Date.now(),
status:"NEW",
vCode:""
});
alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
location.reload();
};

loginBtn.onclick = ()=>{
const u=prompt("user");const p=prompt("pass");
if(u!=="Eltohamy"||p!=="551855125500")return alert("Ø±ÙØ¶");
citizenPage.style.display="none";
adminPage.style.display="block";

onSnapshot(query(dbRef,orderBy("timestamp","desc")),snap=>{
dataTable.innerHTML="";
snap.forEach(d=>{
const i=d.data();
const tr=document.createElement("tr");
tr.innerHTML=`
<td>${i.owner}</td>
<td>${i.nationalId}</td>
<td>${i.phone}</td>
<td>${i.vType}</td>
<td>${i.status==="NEW"?"â³ Ø¬Ø¯ÙŠØ¯":"âœ… ØªÙ…"}</td>
<td>${i.vCode||"â€”"}</td>
<td><button>ÙƒÙˆØ¯</button></td>`;
tr.querySelector("button").onclick=async()=>{
if(i.vCode)return alert("Ù…ÙƒÙˆØ¯");
const code=await generateVehicleCode(i.vType);
await updateDoc(doc(db,"orders",d.id),{vCode:code,status:"APPROVED"});
};
dataTable.appendChild(tr);
});
});
};

exportExcelBtn.onclick=()=>{
const wb=XLSX.utils.table_to_book(excelTable,{sheet:"Data"});
XLSX.writeFile(wb,"kafr_saqr.xlsx");
};
</script>

</body>
</html>
