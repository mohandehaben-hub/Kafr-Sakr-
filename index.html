<!DOCTYPE html>
<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Ù…Ù†Ø¸ÙˆÙ…Ø© ØªÙƒÙˆÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª - Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ”’ Ù†Ø¸Ø§Ù… Ø£Ù…Ø§Ù† Ù…ØªÙ‚Ø¯Ù… - SHA-256 Password Hashing
  âœ… Ø¢Ù…Ù† 100% Ù„Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub
  âœ… ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø© Ø¨Ù€ SHA-256 (One-Way Hash)
  âœ… Ù…Ø³ØªØ­ÙŠÙ„ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
  
  Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:
  Username: Eltohamy
  Password: 551855125500
  
  Ù…/ Ù…Ù‡Ù†Ø¯ Ø§Ù„ØªÙ‡Ø§Ù…ÙŠ - 01021102607
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Ù…Ù†Ø¸ÙˆÙ…Ø© ØªÙƒÙˆÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª - ÙƒÙØ± ØµÙ‚Ø±</title>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS Variables
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
--primary: #1a5276;
--secondary: #27ae60;
--accent: #d35400;
--danger: #e74c3c;
--warning: #f39c12;
--info: #3498db;
--bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
--glass-white: rgba(255, 255, 255, 0.85);
--glass-border: rgba(255, 255, 255, 0.5);
--text-dark: #2c3e50;
--shadow-lg: 0 20px 60px rgba(0,0,0,0.3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Base Styles
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: var(--bg-gradient);
background-attachment: fixed;
direction: rtl;
color: var(--text-dark);
padding-bottom: 100px;
min-height: 100vh;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Header
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
background: linear-gradient(135deg, rgba(26, 82, 118, 0.98) 0%, rgba(21, 67, 96, 0.98) 100%);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
color: white;
padding: 15px 5%;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: var(--shadow-lg);
border-bottom: 3px solid rgba(255, 255, 255, 0.3);
position: sticky;
top: 0;
z-index: 1000;
animation: slideDown 0.5s ease;
}

@keyframes slideDown {
from { transform: translateY(-100%); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeIn {
from { opacity: 0; transform: scale(0.9); }
to { opacity: 1; transform: scale(1); }
}

@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

.header-title h1 {
margin: 0;
font-size: 1.4rem;
text-shadow: 0 3px 6px rgba(0,0,0,0.3);
}

.header-title small {
color: #f1c40f;
font-size: 0.85rem;
display: block;
margin-top: 5px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Container & Cards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.container {
max-width: 1400px;
margin: 30px auto;
padding: 0 20px;
}

.card {
background: var(--glass-white);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
padding: 40px;
border-radius: 30px;
border: 2px solid var(--glass-border);
box-shadow: var(--shadow-lg);
animation: fadeIn 0.6s ease;
margin-bottom: 30px;
margin-top: 20px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Portal Boxes
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.portal-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 30px;
margin-top: 50px;
padding: 0 10px;
}

.portal-box {
background: var(--glass-white);
backdrop-filter: blur(20px);
padding: 50px 30px;
border-radius: 30px;
text-align: center;
cursor: pointer;
border: 3px solid transparent;
transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
box-shadow: 0 15px 40px rgba(0,0,0,0.15);
position: relative;
overflow: hidden;
min-height: 320px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}

.portal-box::before {
content: '';
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
transform: scale(0);
transition: transform 0.6s ease;
}

.portal-box:hover::before {
transform: scale(1);
}

.portal-box:hover {
transform: translateY(-15px) scale(1.05);
box-shadow: 0 30px 70px rgba(0,0,0,0.25);
}

.portal-box i {
font-size: 90px;
display: block;
margin-bottom: 25px;
animation: pulse 2s infinite;
filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
}

.portal-box h2 {
margin: 15px 0;
font-size: 1.6rem;
font-weight: 900;
text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.portal-box p {
color: #666;
font-size: 1rem;
line-height: 1.8;
margin: 15px 0 0 0;
font-weight: 500;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Forms
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.form-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 25px;
}

.input-group {
display: flex;
flex-direction: column;
margin-bottom: 20px;
position: relative;
}

.input-group label {
margin-bottom: 12px;
font-weight: 700;
color: var(--primary);
font-size: 1rem;
display: flex;
align-items: center;
gap: 8px;
}

.input-group label::before {
content: 'â—';
color: var(--accent);
font-size: 0.8rem;
}

.input-group input,
.input-group select,
.input-group textarea {
padding: 16px;
border: 2px solid var(--glass-border);
border-radius: 15px;
background: rgba(255, 255, 255, 0.95);
font-size: 1.05rem;
transition: all 0.3s;
font-family: inherit;
font-weight: 500;
}

.input-group input:focus,
.input-group select:focus,
.input-group textarea:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 5px rgba(26, 82, 118, 0.15);
transform: translateY(-2px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Buttons
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
cursor: pointer;
border: none;
padding: 14px 24px;
border-radius: 16px;
font-weight: 700;
transition: all 0.4s ease;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 10px;
box-shadow: 0 6px 20px rgba(0,0,0,0.15);
font-size: 1rem;
position: relative;
overflow: hidden;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.btn::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
background: rgba(255,255,255,0.3);
border-radius: 50%;
transition: width 0.6s, height 0.6s;
transform: translate(-50%, -50%);
}

.btn:hover::before {
width: 300px;
height: 300px;
}

.btn:hover {
transform: translateY(-3px);
box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}

.btn-primary {
background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%);
color: white;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Loading Spinner
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading {
display: none;
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
z-index: 20000;
}

.spinner {
border: 8px solid rgba(255,255,255,0.3);
border-top: 8px solid var(--primary);
border-radius: 50%;
width: 80px;
height: 80px;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Footer
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.engineer-footer {
background: linear-gradient(135deg, rgba(28, 40, 51, 0.98) 0%, rgba(44, 62, 80, 0.98) 100%);
backdrop-filter: blur(15px);
color: #ecf0f1;
text-align: center;
padding: 18px;
position: fixed;
bottom: 0;
width: 100%;
font-size: 0.95rem;
border-top: 4px solid var(--accent);
z-index: 999;
box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
font-weight: 600;
letter-spacing: 0.5px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Responsive - COMPRESSED UI
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
/* Header Mobile */
header {
padding: 4px 8px !important;
}

header img {
width: 22px !important;
height: 22px !important;
}

.header-title h1 {
font-size: 0.65rem !important;
}

.header-title small {
font-size: 0.5rem !important;
}

header button {
padding: 4px 6px !important;
font-size: 0.6rem !important;
}

/* Portal Mobile */
.portal-container {
grid-template-columns: 1fr;
gap: 12px;
}

.portal-box {
padding: 15px 12px;
min-height: 140px;
}

.portal-box i {
font-size: 40px !important;
}

.portal-box h2 {
font-size: 0.9rem !important;
}

.portal-box p {
font-size: 0.75rem !important;
}

/* Forms Mobile */
.form-grid {
grid-template-columns: 1fr;
}

.card {
padding: 12px 8px;
}

.btn {
padding: 6px 10px !important;
font-size: 0.7rem !important;
}

.input-group input,
.input-group select,
.input-group textarea {
padding: 8px !important;
font-size: 0.8rem !important;
}

/* Table Mobile */
table {
font-size: 0.65rem !important;
}

table th, table td {
padding: 4px 2px !important;
font-size: 0.65rem !important;
}
}

/* Desktop Compression */
header {
padding: 8px 3%;
}

header img {
width: 35px;
height: 35px;
}

.header-title h1 {
font-size: 0.9rem;
}

.header-title small {
font-size: 0.65rem;
}

header button {
padding: 6px 10px;
font-size: 0.75rem;
}

.btn {
padding: 8px 14px;
font-size: 0.85rem;
}

table th {
padding: 8px 6px;
font-size: 0.85rem;
}

table td {
padding: 6px 4px;
font-size: 0.8rem;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Vehicle Cards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.vehicle-card {
background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
backdrop-filter: blur(10px);
padding: 30px 20px;
border-radius: 20px;
text-align: center;
cursor: pointer;
border: 3px solid transparent;
transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
box-shadow: 0 8px 25px rgba(0,0,0,0.1);
position: relative;
overflow: hidden;
}

.vehicle-card::before {
content: '';
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(26, 82, 118, 0.1) 0%, transparent 70%);
transform: scale(0);
transition: transform 0.5s ease;
}

.vehicle-card:hover::before {
transform: scale(1);
}

.vehicle-card:hover {
transform: translateY(-10px) scale(1.05);
border-color: var(--primary);
box-shadow: 0 20px 50px rgba(26, 82, 118, 0.3);
}

.vehicle-card.selected {
border-color: var(--secondary);
background: linear-gradient(135deg, rgba(39, 174, 96, 0.15) 0%, rgba(46, 204, 113, 0.15) 100%);
box-shadow: 0 15px 40px rgba(39, 174, 96, 0.4);
transform: scale(1.05);
}

.vehicle-card.selected::after {
content: 'âœ“';
position: absolute;
top: 10px;
right: 10px;
width: 35px;
height: 35px;
background: var(--secondary);
color: white;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.3rem;
font-weight: bold;
box-shadow: 0 4px 15px rgba(39, 174, 96, 0.5);
}
</style>
</head>
<body>

<!-- Loading Spinner -->
<div class="loading" id="loadingSpinner">
<div class="spinner"></div>
</div>

<!-- Header -->
<header>
<div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap; width: 100%;">
<div style="display: flex; align-items: center; gap: 15px;">
<img src="https://i.postimg.cc/Hs92TtbL/41jjsn4SHDL-AC-UF894-1000-QL80.jpg" 
style="width: 60px; height: 60px; object-fit: contain; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); background: white; padding: 5px; border: 2px solid rgba(255,255,255,0.5);" 
alt="Ø¹Ù„Ù… Ù…ØµØ±">
<img src="https://i.postimg.cc/brFBgHg7/Flag-of-Sharkiya-Governorate.png" 
style="width: 60px; height: 60px; object-fit: contain; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); background: white; padding: 5px; border: 2px solid rgba(255,255,255,0.5);" 
alt="Ø¹Ù„Ù… Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">
</div>
<div class="header-title" style="flex: 1;">
<h1>ğŸ›ï¸ Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±</h1>
<small>Ø¯/ Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ù‚Ø¯Ù… - Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</small>
</div>
<div style="display:flex; gap:12px; flex-wrap: wrap;">
<button id="goPortalBtn" class="btn" style="background: rgba(255,255,255,0.15); color: white; display:none;" onclick="location.reload()">ğŸ  Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</button>
<button id="loginBtn" class="btn" style="background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.4);">ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
</div>
</div>
</header>

<!-- Egyptian Flag Stripe -->
<div style="height: 8px; background: linear-gradient(90deg, #ce1126 0%, #ce1126 33.33%, #ffffff 33.33%, #ffffff 66.66%, #000000 66.66%, #000000 100%); box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>

<!-- Main Container -->
<div class="container">

<!-- Portal Section -->
<div id="portalSection">
<h2 style="text-align: center; color: white; margin-top: 50px; margin-bottom: 15px; font-size: 2.5rem; text-shadow: 0 4px 10px rgba(0,0,0,0.3);">
Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©
</h2>
<p style="text-align: center; color: rgba(255,255,255,0.9); margin-bottom: 50px; font-size: 1.2rem; text-shadow: 0 2px 5px rgba(0,0,0,0.2);">
ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„ÙŠÙ‡
</p>

<div class="portal-container">
<!-- Vehicle Coding Portal -->
<div class="portal-box" onclick="openService('citizenPage')" style="border-bottom: 6px solid var(--primary);">
<i style="font-style: normal; font-size: 85px;">ğŸšœ</i>
<h2 style="color: var(--primary);">Ù‚Ø³Ù… ØªÙƒÙˆÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</h2>
<p>ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆÙƒØªÙˆÙƒ ÙˆØ§Ù„Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„ ÙˆØ§Ù„ØªØ±ÙˆØ³ÙŠÙƒÙ„ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ Ø¨Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø°ÙƒÙŠØ©</p>
</div>

<!-- Inquiry Portal -->
<div class="portal-box" onclick="openService('inquiryPage')" style="border-bottom: 6px solid var(--secondary);">
<i style="font-style: normal; font-size: 85px;">ğŸ”</i>
<h2 style="color: var(--secondary);">Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h2>
<p>ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ ÙˆÙ…Ø¹Ø±ÙØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ø±ÙƒØ¨ØªÙƒ</p>
</div>

<!-- Complaints Portal -->
<div class="portal-box" onclick="openService('complaintsPage')" style="border-bottom: 6px solid var(--accent);">
<i style="font-style: normal; font-size: 85px;">âš–ï¸</i>
<h2 style="color: var(--accent);">ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰</h2>
<p>ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø¨Ù„Ø§ØºØ§Øª Ù…Ø¹ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„</p>
</div>

<!-- Complaint Inquiry Portal -->
<div class="portal-box" onclick="openService('complaintInquiryPage')" style="border-bottom: 6px solid var(--warning);">
<i style="font-style: normal; font-size: 85px;">ğŸ“‹</i>
<h2 style="color: var(--warning);">Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
<p>ØªØ§Ø¨Ø¹ Ø­Ø§Ù„Ø© Ø´ÙƒÙˆØ§Ùƒ ÙˆØ§Ø·Ù„Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯</p>
</div>
</div>
</div>

<!-- Citizen Page (Vehicle Registration) -->
<div id="citizenPage" style="display:none;">
<div class="card">
<h2 style="text-align: center; color: var(--primary); margin-bottom: 30px; font-size: 2rem;">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙƒØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>

<!-- Vehicle Type Selection -->
<div id="vehicleTypeSelection" style="margin-bottom: 40px;">
<h3 style="text-align: center; color: var(--primary); margin-bottom: 30px; font-size: 1.4rem;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
<div class="vehicle-card" data-type="ØªÙˆÙƒØªÙˆÙƒ" onclick="selectVehicleType('ØªÙˆÙƒØªÙˆÙƒ')">
<div style="margin-bottom: 10px;"><img src="https://i.postimg.cc/QtgDfPKv/images-(1).jpg" style="width: 100px; height: 80px; object-fit: contain; border-radius: 10px;"></div>
<h4 style="color: var(--primary); margin: 10px 0; font-size: 1.2rem;">ØªÙˆÙƒØªÙˆÙƒ</h4>
<p style="color: #666; font-size: 0.9rem;">Ù…Ø±ÙƒØ¨Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø¹Ø¬Ù„Ø§Øª</p>
</div>
<div class="vehicle-card" data-type="Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„" onclick="selectVehicleType('Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„')">
<div style="margin-bottom: 10px;"><img src="https://i.postimg.cc/zfKYfM7K/hwjn-4-2.jpg" style="width: 100px; height: 80px; object-fit: contain; border-radius: 10px;"></div>
<h4 style="color: var(--primary); margin: 10px 0; font-size: 1.2rem;">Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„</h4>
<p style="color: #666; font-size: 0.9rem;">Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©</p>
</div>
<div class="vehicle-card" data-type="ØªØ±ÙˆØ³ÙŠÙƒÙ„" onclick="selectVehicleType('ØªØ±ÙˆØ³ÙŠÙƒÙ„')">
<div style="margin-bottom: 10px;"><img src="https://i.postimg.cc/HnSfKCYf/images-(2).jpg" style="width: 100px; height: 80px; object-fit: contain; border-radius: 10px;"></div>
<h4 style="color: var(--primary); margin: 10px 0; font-size: 1.2rem;">ØªØ±ÙˆØ³ÙŠÙƒÙ„</h4>
<p style="color: #666; font-size: 0.9rem;">Ø¯Ø±Ø§Ø¬Ø© Ø«Ù„Ø§Ø«ÙŠØ©</p>
</div>
<div class="vehicle-card" data-type="Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ" onclick="selectVehicleType('Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ')">
<div style="margin-bottom: 10px;"><img src="https://i.postimg.cc/HkjpTBFt/images.jpg" style="width: 100px; height: 80px; object-fit: contain; border-radius: 10px;"></div>
<h4 style="color: var(--primary); margin: 10px 0; font-size: 1.2rem;">Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</h4>
<p style="color: #666; font-size: 0.9rem;">Ø­Ø§ÙÙ„Ø© ØµØºÙŠØ±Ø©</p>
</div>
</div>
</div>

<!-- Registration Form -->
<div id="registrationForm" style="display:none;">
<div style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%); padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center; border: 2px solid var(--primary);">
<p style="margin: 0; color: var(--primary); font-size: 1.1rem; font-weight: 600;">
Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±: <span id="selectedVehicleType" style="font-size: 1.3rem; color: var(--secondary);"></span>
</p>
<button onclick="resetVehicleSelection()" class="btn" style="background: rgba(231, 76, 60, 0.1); color: var(--danger); padding: 8px 20px; margin-top: 10px; font-size: 0.9rem;">
ğŸ”„ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
</button>
</div>

<div class="form-grid">
<div class="input-group" style="grid-column: 1 / -1;">
<label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ</label>
<input type="text" id="ownerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
</div>

<div class="input-group">
<label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</label>
<input type="text" id="nationalId" maxlength="14" placeholder="Ù…Ø«Ø§Ù„: 29501011234567" oninput="validateNationalId(this)">
<div id="nidValidation" style="font-size: 0.85rem; margin-top: 8px; padding: 8px 12px; border-radius: 8px; display: none; font-weight: 600;"></div>
</div>

<div class="input-group">
<label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ø£Ø¯Ø®Ù„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„ØªØ­Ù‚Ù‚)</label>
<small style="color: #666; font-size: 0.85rem; display: block; margin-bottom: 8px; line-height: 1.5;">
âš ï¸ Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
</small>
<input type="date" id="birthDate" onchange="verifyBirthDate()" placeholder="Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯Ùƒ">
<div id="birthValidation" style="font-size: 0.85rem; margin-top: 8px; padding: 8px 12px; border-radius: 8px; display: none; font-weight: 600;"></div>
</div>

<div class="input-group">
<label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)</label>
<input type="tel" id="phone" maxlength="11" placeholder="01XXXXXXXXX">
</div>

<div class="input-group">
<label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
<input type="text" id="vType" readonly style="background: rgba(39, 174, 96, 0.1); border: 2px solid var(--secondary); font-weight: 700; color: var(--secondary); font-size: 1.1rem; cursor: not-allowed;">
</div>

<div class="input-group">
<label>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (Ø§Ù„Ø³Ù†Ø©)</label>
<select id="vYear"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©...</option></select>
</div>

<div class="input-group" style="grid-column: 1 / -1;">
<label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
<input type="text" id="address" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„">
</div>

<div class="input-group" style="grid-column: 1 / -1;">
<label>Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</label>
<input type="file" id="multiFiles" multiple accept="image/*" style="padding: 30px; border: 3px dashed var(--primary);">
<small style="color: #666; margin-top: 10px; display: block;">âœ“ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø¹Ø¯Ø© ØµÙˆØ±</small>
</div>
</div>

<button id="submitBtn" class="btn btn-primary" style="width: 100%; font-size: 1.4rem; margin-top: 35px; padding: 20px;">
Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…
</button>
</div>
</div>
</div>

<!-- Inquiry Page -->
<div id="inquiryPage" style="display:none;">
<div class="card" style="border: 3px solid var(--secondary);">
<h2 style="text-align: center; color: var(--secondary); margin-bottom: 40px; font-size: 2rem;">ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h2>
<p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 1.1rem;">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ</p>

<div class="form-grid">
<div class="input-group" style="grid-column: 1 / -1;">
<label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
<input type="text" id="inqOwnerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
</div>

<div class="input-group">
<label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</label>
<input type="text" id="inqNationalId" maxlength="14" placeholder="29501011234567">
</div>

<div class="input-group">
<label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)</label>
<input type="tel" id="inqPhone" maxlength="11" placeholder="01XXXXXXXXX">
</div>
</div>

<button id="inquiryBtn" class="btn btn-primary" style="width: 100%; font-size: 1.4rem; margin-top: 35px; padding: 20px;">
ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¢Ù†
</button>

<div id="inquiryResult" style="display:none; margin-top: 40px; padding: 40px; border-radius: 25px; text-align: center;"></div>
</div>
</div>

<!-- Complaints Page -->
<div id="complaintsPage" style="display:none;">
<div class="card" style="border: 3px solid var(--accent);">
<h2 style="text-align: center; color: var(--accent); margin-bottom: 30px; font-size: 2rem;">âš–ï¸ ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰</h2>
<p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 1.05rem;">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰</p>

<div class="form-grid">
<div class="input-group" style="grid-column: 1 / -1;">
<label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
<input type="text" id="compOwnerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
</div>

<div class="input-group">
<label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</label>
<input type="text" id="compNationalId" maxlength="14" placeholder="29501011234567">
</div>

<div class="input-group">
<label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)</label>
<input type="tel" id="compPhone" maxlength="11" placeholder="01XXXXXXXXX">
</div>

<div class="input-group">
<label>Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰</label>
<select id="compType">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹...</option>
<option value="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø¬Ø±Ø©">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø¬Ø±Ø©</option>
<option value="Ø³ÙˆØ¡ Ù…Ø¹Ø§Ù…Ù„Ø©">Ø³ÙˆØ¡ Ù…Ø¹Ø§Ù…Ù„Ø©</option>
<option value="Ù‚ÙŠØ§Ø¯Ø© Ù…ØªÙ‡ÙˆØ±Ø©">Ù‚ÙŠØ§Ø¯Ø© Ù…ØªÙ‡ÙˆØ±Ø©</option>
<option value="Ù…Ø±ÙƒØ¨Ø© Ù…Ø®Ø§Ù„ÙØ©">Ù…Ø±ÙƒØ¨Ø© Ù…Ø®Ø§Ù„ÙØ©</option>
<option value="Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„ÙƒÙˆØ¯">Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„ÙƒÙˆØ¯</option>
<option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
</select>
</div>

<div class="input-group" style="grid-column: 1 / -1;">
<label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰</label>
<textarea id="compDetails" rows="5" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„..."></textarea>
</div>

<!-- ØµÙˆØ±Ø© Ø³ÙŠÙ„ÙÙŠ -->
<div class="input-group" style="grid-column: 1 / -1;">
<label style="color: var(--accent); font-size: 1.1rem;">ğŸ“¸ ØµÙˆØ±Ø© Ø³ÙŠÙ„ÙÙŠ (Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ©)</label>
<input type="file" id="compSelfie" accept="image/*" capture="user" style="padding: 20px; border: 3px dashed var(--accent); background: rgba(211, 84, 0, 0.05);">
<small style="color: #666; margin-top: 10px; display: block;">âœ“ Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ø³ÙŠÙ„ÙÙŠ ÙˆØ§Ø¶Ø­Ø© Ù„ÙˆØ¬Ù‡Ùƒ</small>
</div>

<!-- ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
<div class="input-group" style="grid-column: 1 / -1;">
<label style="color: var(--accent); font-size: 1.1rem;">ğŸªª ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
<input type="file" id="compIdCard" accept="image/*" style="padding: 20px; border: 3px dashed var(--accent); background: rgba(211, 84, 0, 0.05);">
<small style="color: #666; margin-top: 10px; display: block;">âœ“ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ)</small>
</div>

<!-- ØµÙˆØ±Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© -->
<div class="input-group" style="grid-column: 1 / -1;">
<label style="color: var(--accent); font-size: 1.1rem;">ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
<input type="file" id="compProblemImage" accept="image/*" multiple style="padding: 20px; border: 3px dashed var(--accent); background: rgba(211, 84, 0, 0.05);">
<small style="color: #666; margin-top: 10px; display: block;">âœ“ ØµÙˆØ± ØªÙˆØ¶Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ù (ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø©)</small>
</div>

<!-- ØµÙˆØ±Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ -->
<div class="input-group" style="grid-column: 1 / -1;">
<label style="color: var(--accent); font-size: 1.1rem;">ğŸšœ ØµÙˆØ±Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯</label>
<input type="file" id="compVehicleImage" accept="image/*" style="padding: 20px; border: 3px dashed var(--accent); background: rgba(211, 84, 0, 0.05);">
<small style="color: #666; margin-top: 10px; display: block;">âœ“ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„ØªÙƒÙˆÙŠØ¯</small>
</div>
</div>

<!-- Ù…Ù„Ø®Øµ Ø§Ù„ØµÙˆØ± -->
<div id="compImagesSummary" style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.1) 0%, rgba(186, 74, 0, 0.1) 100%); padding: 20px; border-radius: 15px; margin: 25px 0; border: 2px solid rgba(211, 84, 0, 0.3); display: none;">
<h4 style="color: var(--accent); margin-top: 0;">ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©:</h4>
<div id="compImagesList" style="display: flex; flex-direction: column; gap: 10px;"></div>
</div>

<button id="submitCompBtn" class="btn" style="width: 100%; background: linear-gradient(135deg, var(--accent) 0%, #ba4a00 100%); color: white; padding: 20px; font-size: 1.3rem; margin-top: 30px;">
Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ âœ‰ï¸
</button>
</div>
</div>

<!-- Complaint Inquiry Page -->
<div id="complaintInquiryPage" style="display:none;">
<div class="card" style="border: 3px solid var(--warning);">
<h2 style="text-align: center; color: var(--warning); margin-bottom: 40px; font-size: 2rem;">ğŸ“‹ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
<p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 1.1rem;">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø´ÙƒÙˆØ§Ùƒ</p>

<div class="form-grid">
<div class="input-group" style="grid-column: 1 / -1;">
<label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
<input type="text" id="compInqOwnerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
</div>

<div class="input-group">
<label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</label>
<input type="text" id="compInqNationalId" maxlength="14" placeholder="29501011234567">
</div>

<div class="input-group">
<label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)</label>
<input type="tel" id="compInqPhone" maxlength="11" placeholder="01XXXXXXXXX">
</div>
</div>

<button id="complaintInquiryBtn" class="btn" style="width: 100%; font-size: 1.4rem; margin-top: 35px; padding: 20px; background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%); color: white;">
ğŸ“‹ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ø´ÙƒÙˆÙ‰
</button>

<div id="complaintInquiryResult" style="display:none; margin-top: 40px;"></div>
</div>
</div>

<!-- Admin Page -->
<div id="adminPage" style="display:none;">
<!-- Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; margin-bottom: 35px;">
<div class="stat-card" onclick="showAllOrders()" style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.15) 0%, rgba(52, 152, 219, 0.15) 100%); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid var(--primary); box-shadow: 0 8px 25px rgba(26, 82, 118, 0.2); cursor: pointer; transition: all 0.3s ease;">
<p style="margin: 0; color: var(--primary); font-size: 1rem; font-weight: 600;">ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
<h3 id="statTotal" style="margin: 15px 0; font-size: 2.5rem; color: var(--primary); font-weight: bold;">0</h3>
<small style="color: #666; font-size: 0.85rem;">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶</small>
</div>
<div class="stat-card" onclick="showCodedOrders()" style="background: linear-gradient(135deg, rgba(39, 174, 96, 0.15) 0%, rgba(46, 204, 113, 0.15) 100%); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid var(--secondary); box-shadow: 0 8px 25px rgba(39, 174, 96, 0.2); cursor: pointer; transition: all 0.3s ease;">
<p style="margin: 0; color: var(--secondary); font-size: 1rem; font-weight: 600;">âœ… ØªÙ… Ø§Ù„ØªÙƒÙˆÙŠØ¯</p>
<h3 id="statCoded" style="margin: 15px 0; font-size: 2.5rem; color: var(--secondary); font-weight: bold;">0</h3>
<small style="color: #666; font-size: 0.85rem;">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶</small>
</div>
<div class="stat-card" onclick="showPendingOrders()" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.15) 0%, rgba(214, 137, 16, 0.15) 100%); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid var(--warning); box-shadow: 0 8px 25px rgba(243, 156, 18, 0.2); cursor: pointer; transition: all 0.3s ease;">
<p style="margin: 0; color: var(--warning); font-size: 1rem; font-weight: 600;">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
<h3 id="statPending" style="margin: 15px 0; font-size: 2.5rem; color: var(--warning); font-weight: bold;">0</h3>
<small style="color: #666; font-size: 0.85rem;">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶</small>
</div>
<div class="stat-card" onclick="showComplaintsTable()" style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.15) 0%, rgba(186, 74, 0, 0.15) 100%); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid var(--accent); box-shadow: 0 8px 25px rgba(211, 84, 0, 0.2); cursor: pointer; transition: all 0.3s ease;">
<p style="margin: 0; color: var(--accent); font-size: 1rem; font-weight: 600;">âš–ï¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</p>
<h3 id="statCompTotal" style="margin: 15px 0; font-size: 2.5rem; color: var(--accent); font-weight: bold;">0</h3>
<small style="color: #666; font-size: 0.85rem;">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶</small>
</div>
</div>

<style>
.stat-card:hover {
transform: translateY(-8px) scale(1.05);
box-shadow: 0 15px 40px rgba(0,0,0,0.3) !important;
}

.stat-card:active {
transform: translateY(-4px) scale(1.02);
}

.stat-card {
position: relative;
overflow: hidden;
}

.stat-card::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
background: rgba(255, 255, 255, 0.3);
border-radius: 50%;
transform: translate(-50%, -50%);
transition: width 0.6s, height 0.6s;
}

.stat-card:hover::before {
width: 300px;
height: 300px;
}
</style>

<div class="card">
<!-- Control Buttons -->
<div style="display:flex; gap:15px; margin-bottom:35px; flex-wrap: wrap; align-items: center;">
<button id="toggleDataBtn" class="btn" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white;" onclick="toggleDataVisibility()">ï¿½ï¸ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©</button>
<button id="showOrdersBtn" class="btn" style="background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%); color: white;">ğŸšœ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</button>
<button id="showComplaintsBtn" class="btn" style="background: linear-gradient(135deg, var(--accent) 0%, #ba4a00 100%); color: white;">âš–ï¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</button>
<button id="showAdminLogsBtn" class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</button>
<button id="bulkImportBtn" class="btn" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</button>
<button id="cleanupDuplicatesBtn" class="btn" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white; display: none;">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙƒØ±Ø§Ø±</button>
<button id="dateFilterBtn" class="btn" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); color: white;">ğŸ“… ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
<div style="flex: 1; display: flex; gap: 10px;">
<select id="searchType" style="padding: 12px; border-radius: 12px; border: 2px solid var(--glass-border); background: rgba(255,255,255,0.95); font-weight: 600; min-width: 150px;">
<option value="all">ğŸ” Ø§Ù„ÙƒÙ„</option>
<option value="name">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</option>
<option value="code">ï¿½ Ø§Ù„ÙƒÙˆØ¯</option>
<option value="nationalId">ğŸ†” Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</option>
<option value="phone">ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ</option>
<option value="chassis">ğŸ”§ Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡</option>
<option value="motor">âš™ï¸ Ø§Ù„Ù…ÙˆØªÙˆØ±</option>
</select>
<input type="text" id="searchInput" oninput="window.searchOrders()" style="flex: 1; padding:16px; border-radius:16px; border:2px solid var(--glass-border); background:rgba(255,255,255,0.95); font-weight:600;" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª..." title="Ø§Ù„Ø¨Ø­Ø« ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©">
</div>
<button id="exportExcelBtn" class="btn" style="background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); color:white;">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
<button onclick="location.reload()" class="btn" style="background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

<!-- Filter Status Message -->
<div id="filterStatus" style="display:none; background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(26, 82, 118, 0.1) 100%); padding: 15px 25px; border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--info); text-align: center;">
<p style="margin: 0; color: var(--info); font-weight: bold; font-size: 1.1rem;">
<span id="filterStatusText">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
<button onclick="showAllOrders()" style="background: rgba(52, 152, 219, 0.2); border: none; padding: 5px 15px; border-radius: 8px; margin-right: 15px; cursor: pointer; color: var(--info); font-weight: bold;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
</p>
</div>

<!-- Pagination Controls -->
<div id="paginationControls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(142, 68, 173, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%); border-radius: 15px; border: 2px solid #8e44ad;">
<div style="display: flex; gap: 10px; align-items: center;">
<button onclick="window.changePage(-1)" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #3498db 0%, #2874a6 100%); color: white;">â®ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
<span id="pageInfo" style="font-weight: bold; color: #8e44ad; font-size: 1.1rem;">ØµÙØ­Ø© 1 Ù…Ù† 1</span>
<button onclick="window.changePage(1)" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #3498db 0%, #2874a6 100%); color: white;">Ø§Ù„ØªØ§Ù„ÙŠ â­ï¸</button>
</div>
<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
<button id="loadAllDataBtn" onclick="window.loadAllData()" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white; display: none;">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
<label style="font-weight: 600; color: #555;">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø©:</label>
<select id="recordsPerPage" onchange="window.changeRecordsPerPage()" style="padding: 8px 15px; border-radius: 10px; border: 2px solid #8e44ad; font-weight: 600; background: white;">
<option value="50">50</option>
<option value="100" selected>100</option>
<option value="200">200</option>
<option value="500">500</option>
</select>
<span id="totalRecordsInfo" style="font-weight: bold; color: #27ae60; font-size: 1.1rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø³Ø¬Ù„</span>
<span id="loadingMoreInfo" style="font-weight: 600; color: #e67e22; font-size: 0.9rem; display: none;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
</div>
</div>

<!-- Orders Table -->
<div id="ordersTableContainer" style="overflow-x:auto;">
<table id="excelTable" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
<thead>
<tr>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ù‡Ø§ØªÙ</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ù†ÙˆØ¹</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ù…ÙˆØªÙˆØ±</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„ÙƒÙˆØ¯</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">ğŸ“· Ø§Ù„ØµÙˆØ±</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>
</div>

<!-- Complaints Table -->
<div id="complaintsTableContainer" style="overflow-x:auto; display: none;">
<table id="complaintsTable" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
<thead>
<tr>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ø§Ø³Ù…</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ù‡Ø§ØªÙ</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="compTableBody"></tbody>
</table>
</div>

<!-- Admin Logs Table -->
<div id="adminLogsTableContainer" style="overflow-x:auto; display: none;">
<h3 style="color: #e74c3c; margin-bottom: 25px; text-align: center; font-size: 1.8rem;">ğŸ“œ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</h3>
<table id="adminLogsTable" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
<thead>
<tr>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ù…Ø´Ø±Ù</th>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">IP Address</th>
</tr>
</thead>
<tbody id="adminLogsTableBody"></tbody>
</table>
</div>
</div>
</div>

<!-- Modal for Images -->
<div id="imgModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<span onclick="document.getElementById('imgModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: white; font-size: 45px; cursor: pointer; z-index: 10001;">&times;</span>
<img id="mainViewImg" style="max-width:90%; max-height:80vh; display:block; margin:80px auto 30px; border:8px solid white; border-radius:25px;">
<div id="modalThumbnails" style="display: flex; justify-content: center; gap: 15px; padding: 25px; flex-wrap: wrap;"></div>
</div>

<!-- Modal for Coding -->
<div id="codeModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 5% auto; padding: 45px; width: 92%; max-width: 500px; border-radius: 35px; text-align: center; position: relative;">
<span onclick="document.getElementById('codeModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 30px;">ğŸ”¢ ØªÙƒÙˆÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h3>
<p id="codeHint" style="font-size:1.1rem; color:#555; background: rgba(0,0,0,0.06); padding:18px; border-radius:15px; margin: 25px 0; font-weight: 600;"></p>
<div class="input-group">
<label style="justify-content: center;">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ù…Ø±ÙƒØ¨Ø©:</label>
<input type="text" id="manualCodeInput" style="text-align:center; font-size:2.5rem; font-weight:bold; color:var(--secondary); border: 3px solid var(--secondary); height: 80px;">
</div>

<!-- WhatsApp Notification Checkbox -->
<div style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); padding: 20px; border-radius: 15px; margin: 25px 0; border: 2px solid rgba(37, 211, 102, 0.3);">
<label style="display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 1.1rem; color: #16a34a; font-weight: 700;">
<input type="checkbox" id="sendWhatsAppCode" checked style="width: 24px; height: 24px; cursor: pointer; accent-color: #16a34a;">
<span>ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…ÙˆØ§Ø·Ù†</span>
</label>
<small style="display: block; text-align: center; color: #666; margin-top: 10px; font-size: 0.9rem;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</small>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmCodeBtn" class="btn btn-primary" style="flex:1; padding:18px; font-size: 1.1rem;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ âœ…</button>
<button onclick="document.getElementById('codeModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">Ø¥Ù„ØºØ§Ø¡ âŒ</button>
</div>
</div>
</div>

<!-- Modal for Edit -->
<div id="editModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 3% auto; padding: 45px; width: 92%; max-width: 700px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('editModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: var(--warning); font-size: 1.8rem; margin-bottom: 30px; text-align: center;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h3>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
<div class="input-group">
<label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ</label>
<input type="text" id="editOwnerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
</div>

<div class="input-group">
<label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)</label>
<input type="tel" id="editPhone" maxlength="11" placeholder="01XXXXXXXXX">
</div>

<div class="input-group">
<label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
<select id="editVType">
<option value="ØªÙˆÙƒØªÙˆÙƒ">ØªÙˆÙƒØªÙˆÙƒ</option>
<option value="Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„">Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„</option>
<option value="ØªØ±ÙˆØ³ÙŠÙƒÙ„">ØªØ±ÙˆØ³ÙŠÙƒÙ„</option>
<option value="Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ">Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
</select>
</div>

<div class="input-group">
<label>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³Ù†Ø©</label>
<select id="editVYear"></select>
</div>

<div class="input-group" style="grid-column: 1 / -1;">
<label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
<textarea id="editAddress" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„"></textarea>
</div>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmEditBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); color: white;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª âœ…</button>
<button onclick="document.getElementById('editModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">Ø¥Ù„ØºØ§Ø¡ âŒ</button>
</div>
</div>
</div>

<!-- Modal for Bulk Import -->
<div id="bulkImportModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 3% auto; padding: 45px; width: 92%; max-width: 900px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('bulkImportModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: #8e44ad; font-size: 1.8rem; margin-bottom: 30px;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠ Ù…Ù† Excel</h3>

<div style="background: linear-gradient(135deg, rgba(142, 68, 173, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%); padding: 25px; border-radius: 20px; margin: 25px 0; border: 2px solid rgba(142, 68, 173, 0.3);">
<h4 style="color: #8e44ad; margin-top: 0;">ğŸ“‹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</h4>
<p style="color: #666; line-height: 1.8; margin: 15px 0;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ù…Ù„Ù Excel Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
<ol style="color: #555; line-height: 2; font-weight: 600;">
<li>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</li>
<li>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</li>
<li>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)</li>
<li>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (ØªÙˆÙƒØªÙˆÙƒ / Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„ / ØªØ±ÙˆØ³ÙŠÙƒÙ„ / Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ)</li>
<li>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³Ù†Ø©</li>
<li>Ø§Ù„Ù„ÙˆÙ†</li>
<li>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</li>
<li>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹)</li>
</ol>
<button id="downloadTemplateBtn" class="btn" style="background: linear-gradient(135deg, var(--info) 0%, #2874a6 100%); color: white; margin-top: 15px;">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ù†Ù…ÙˆØ°Ø¬ÙŠ</button>
</div>

<div class="input-group">
<label style="font-size: 1.1rem; color: #8e44ad;">Ø§Ø®ØªØ± Ù…Ù„Ù Excel Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:</label>
<input type="file" id="bulkImportFile" accept=".xlsx, .xls" style="padding: 20px; border: 3px dashed #8e44ad; background: rgba(142, 68, 173, 0.05); font-weight: 600; border-radius: 15px;">
</div>

<div id="importPreview" style="display:none; margin: 25px 0; max-height: 300px; overflow-y: auto; background: white; padding: 20px; border-radius: 15px; border: 2px solid #ddd;"></div>

<!-- Progress Bar -->
<div id="importProgress" style="display:none; margin: 25px 0;">
<div style="background: #f0f0f0; border-radius: 10px; overflow: hidden; height: 30px; position: relative;">
<div id="progressBar" style="background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
<span id="progressText" style="color: white; font-weight: bold; font-size: 0.9rem; position: absolute; width: 100%; text-align: center; z-index: 1;">0%</span>
</div>
</div>
<p id="progressStatus" style="text-align: center; margin-top: 10px; color: #666; font-weight: 600;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmImportBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); color: white;">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
<button onclick="document.getElementById('bulkImportModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>
</div>

<!-- Modal for Activity Log -->
<div id="activityLogModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 3% auto; padding: 45px; width: 92%; max-width: 800px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('activityLogModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: #34495e; font-size: 1.8rem; margin-bottom: 30px; text-align: center;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
<div id="activityLogContent" style="max-height: 500px; overflow-y: auto;"></div>
</div>
</div>

<!-- Modal for Login -->
<div id="loginModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); backdrop-filter: blur(20px); overflow-y: auto;">
<div style="background: white; margin: 5% auto; padding: 50px; width: 92%; max-width: 500px; border-radius: 35px; position: relative; box-shadow: 0 25px 80px rgba(0,0,0,0.4);">
<span onclick="document.getElementById('loginModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer; transition: transform 0.3s;" onmouseover="this.style.transform='rotate(90deg)'" onmouseout="this.style.transform='rotate(0deg)'">&times;</span>

<!-- Logos -->
<div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px;">
<img src="https://i.postimg.cc/Hs92TtbL/41jjsn4SHDL-AC-UF894-1000-QL80.jpg" 
style="width: 70px; height: 70px; object-fit: contain; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); background: white; padding: 8px; border: 3px solid rgba(26, 82, 118, 0.3); animation: pulse 2s infinite;" 
alt="Ø¹Ù„Ù… Ù…ØµØ±">
<img src="https://i.postimg.cc/brFBgHg7/Flag-of-Sharkiya-Governorate.png" 
style="width: 70px; height: 70px; object-fit: contain; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); background: white; padding: 8px; border: 3px solid rgba(26, 82, 118, 0.3); animation: pulse 2s infinite;" 
alt="Ø¹Ù„Ù… Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">
</div>

<!-- Title -->
<h3 style="color: var(--primary); font-size: 2rem; margin-bottom: 15px; text-align: center; font-weight: 900;">ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
<p style="text-align: center; color: #666; margin-bottom: 35px; font-size: 1rem;">Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±</p>

<!-- Egyptian Flag Stripe -->
<div style="height: 6px; background: linear-gradient(90deg, #ce1126 0%, #ce1126 33.33%, #ffffff 33.33%, #ffffff 66.66%, #000000 66.66%, #000000 100%); border-radius: 10px; margin-bottom: 35px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>

<!-- Login Form -->
<div class="input-group">
<label style="font-size: 1.1rem; color: var(--primary); font-weight: 700;">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
<input type="text" id="loginUsername" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="padding: 18px; border: 3px solid var(--glass-border); border-radius: 15px; font-size: 1.1rem; font-weight: 600; transition: all 0.3s;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 5px rgba(26, 82, 118, 0.1)'" onblur="this.style.borderColor='var(--glass-border)'; this.style.boxShadow='none'">
</div>

<div class="input-group">
<label style="font-size: 1.1rem; color: var(--primary); font-weight: 700;">ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
<input type="password" id="loginPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="padding: 18px; border: 3px solid var(--glass-border); border-radius: 15px; font-size: 1.1rem; font-weight: 600; transition: all 0.3s;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 5px rgba(26, 82, 118, 0.1)'" onblur="this.style.borderColor='var(--glass-border)'; this.style.boxShadow='none'" onkeypress="if(event.key==='Enter') document.getElementById('confirmLoginBtn').click()">
</div>

<!-- Login Button -->
<button id="confirmLoginBtn" class="btn" style="width: 100%; padding: 20px; font-size: 1.3rem; margin-top: 25px; background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%); color: white; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 10px 30px rgba(26, 82, 118, 0.4); position: relative; overflow: hidden; transition: all 0.3s;">
<span style="position: relative; z-index: 1;">Ø¯Ø®ÙˆÙ„ ğŸš€</span>
</button>

<style>
#confirmLoginBtn:hover {
transform: translateY(-3px);
box-shadow: 0 15px 40px rgba(26, 82, 118, 0.5);
}

#confirmLoginBtn:active {
transform: translateY(0);
}

#loginModal {
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}
</style>

<!-- Info Box -->
<div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(26, 82, 118, 0.1) 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 2px solid rgba(52, 152, 219, 0.3);">
<p style="margin: 0; color: #555; font-size: 0.9rem; text-align: center; line-height: 1.8;">
<strong style="color: var(--primary);">â„¹ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong><br>
Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø´Ø±ÙØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
</p>
</div>
</div>
</div>

<!-- Modal for Date Filter -->
<div id="dateFilterModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 10% auto; padding: 45px; width: 92%; max-width: 500px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('dateFilterModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 30px; text-align: center;">ğŸ“… ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</h3>

<div class="input-group">
<label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
<input type="date" id="filterFromDate" style="padding: 16px; border-radius: 12px; border: 2px solid var(--glass-border); width: 100%;">
</div>

<div class="input-group">
<label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
<input type="date" id="filterToDate" style="padding: 16px; border-radius: 12px; border: 2px solid var(--glass-border); width: 100%;">
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="applyDateFilterBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%); color: white;">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
<button onclick="clearDateFilter()" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%); color: white;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
</div>
</div>
</div>

<!-- Modal for Status Change -->
<div id="statusChangeModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 5% auto; padding: 45px; width: 92%; max-width: 550px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('statusChangeModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: #8e44ad; font-size: 1.8rem; margin-bottom: 30px; text-align: center;">ğŸ”„ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h3>

<div class="input-group">
<label style="font-size: 1.1rem; color: #8e44ad;">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
<select id="newStatusSelect" style="padding: 18px; border-radius: 12px; border: 3px solid #8e44ad; width: 100%; font-size: 1.1rem; font-weight: 700; color: #8e44ad;">
<option value="pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
<option value="approved">âœ“ ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„</option>
<option value="coded">âœ… ØªÙ… Ø§Ù„ØªÙƒÙˆÙŠØ¯</option>
<option value="delivered">ğŸ‰ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
</select>
</div>

<div class="input-group">
<label style="font-size: 1.1rem; color: #8e44ad;">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
<textarea id="statusNote" rows="3" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø©..." style="padding: 16px; border-radius: 12px; border: 2px solid var(--glass-border); width: 100%; font-size: 1rem;"></textarea>
</div>

<!-- WhatsApp Notification Checkbox -->
<div style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); padding: 20px; border-radius: 15px; margin: 25px 0; border: 2px solid rgba(37, 211, 102, 0.3);">
<label style="display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 1.1rem; color: #16a34a; font-weight: 700;">
<input type="checkbox" id="sendWhatsAppStatus" checked style="width: 24px; height: 24px; cursor: pointer; accent-color: #16a34a;">
<span>ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…ÙˆØ§Ø·Ù†</span>
</label>
<small style="display: block; text-align: center; color: #666; margin-top: 10px; font-size: 0.9rem;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</small>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmStatusChangeBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white;">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±</button>
<button onclick="document.getElementById('statusChangeModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>
</div>

<!-- Modal for Complaint Reply -->
<div id="complaintReplyModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 5% auto; padding: 45px; width: 92%; max-width: 600px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('complaintReplyModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: var(--secondary); font-size: 1.8rem; margin-bottom: 30px; text-align: center;">ğŸ’¬ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙˆÙ‰</h3>

<div class="input-group">
<label style="font-size: 1.1rem; color: var(--secondary);">Ù†Øµ Ø§Ù„Ø±Ø¯:</label>
<textarea id="complaintReplyText" rows="6" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙˆÙ‰..." style="padding: 16px; border-radius: 12px; border: 3px solid var(--secondary); width: 100%; font-size: 1.05rem; line-height: 1.8;"></textarea>
</div>

<!-- WhatsApp Notification Checkbox -->
<div style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); padding: 20px; border-radius: 15px; margin: 25px 0; border: 2px solid rgba(37, 211, 102, 0.3);">
<label style="display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 1.1rem; color: #16a34a; font-weight: 700;">
<input type="checkbox" id="sendWhatsAppReply" checked style="width: 24px; height: 24px; cursor: pointer; accent-color: #16a34a;">
<span>ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…ÙˆØ§Ø·Ù†</span>
</label>
<small style="display: block; text-align: center; color: #666; margin-top: 10px; font-size: 0.9rem;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø¯ ÙƒØ§Ù…Ù„Ø§Ù‹</small>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmComplaintReplyBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); color: white;">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
<button onclick="document.getElementById('complaintReplyModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>
</div>

</div>

<!-- Egyptian Flag Stripe -->
<div style="height: 8px; background: linear-gradient(90deg, #ce1126 0%, #ce1126 33.33%, #ffffff 33.33%, #ffffff 66.66%, #000000 66.66%, #000000 100%); box-shadow: 0 -2px 8px rgba(0,0,0,0.3);"></div>

<!-- Footer -->
<footer class="engineer-footer">
<div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
<img src="https://i.postimg.cc/Hs92TtbL/41jjsn4SHDL-AC-UF894-1000-QL80.jpg" 
style="width: 40px; height: 40px; object-fit: contain; border-radius: 8px; background: white; padding: 3px;" 
alt="Ø¹Ù„Ù… Ù…ØµØ±">
<span>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø© Ù…/ Ù…Ù‡Ù†Ø¯ Ø§Ù„ØªÙ‡Ø§Ù…ÙŠ - 01021102607 | Ù†Ø¸Ø§Ù… Ù…ØªØ·ÙˆØ± Ø¨ØªÙ‚Ù†ÙŠØ§Øª Ø­Ø¯ÙŠØ«Ø©</span>
<img src="https://i.postimg.cc/brFBgHg7/Flag-of-Sharkiya-Governorate.png" 
style="width: 40px; height: 40px; object-fit: contain; border-radius: 8px; background: white; padding: 3px;" 
alt="Ø¹Ù„Ù… Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">
</div>
</footer>

<!-- JavaScript -->
<script>
console.log('â•'.repeat(60));
console.log('âœ… Ù…Ù†Ø¸ÙˆÙ…Ø© ØªÙƒÙˆÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª - ÙƒÙØ± ØµÙ‚Ø±');
console.log('ğŸ”’ Ù†Ø¸Ø§Ù… Ø£Ù…Ø§Ù† Ù…ØªÙ‚Ø¯Ù… - SHA-256 Password Hashing');
console.log('âœ… Ø¢Ù…Ù† 100% Ù„Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub');
console.log('â•'.repeat(60));

// Navigation Function
function openService(serviceId) {
console.log('ğŸ”„ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…:', serviceId);
document.getElementById('portalSection').style.display = 'none';
document.getElementById(serviceId).style.display = 'block';
document.getElementById('goPortalBtn').style.display = 'inline-flex';
}

// Fill Years
function fillYears() {
const select = document.getElementById('vYear');
if (!select) return;
for (let year = 2000; year <= 2030; year++) {
let opt = document.createElement('option');
opt.value = year;
opt.innerText = year;
select.appendChild(opt);
}
}
fillYears();

// Fill Years for Edit Modal
function fillEditYears() {
const select = document.getElementById('editVYear');
if (!select) return;
for (let year = 2000; year <= 2030; year++) {
let opt = document.createElement('option');
opt.value = year;
opt.innerText = year;
select.appendChild(opt);
}
}
fillEditYears();

// Vehicle Type Selection
function selectVehicleType(type) {
document.querySelectorAll('.vehicle-card').forEach(card => {
card.classList.remove('selected');
});
document.querySelector(`.vehicle-card[data-type="${type}"]`).classList.add('selected');
document.getElementById('vType').value = type;
document.getElementById('selectedVehicleType').innerText = type;
document.getElementById('vehicleTypeSelection').style.display = 'none';
document.getElementById('registrationForm').style.display = 'block';
}

function resetVehicleSelection() {
document.getElementById('vehicleTypeSelection').style.display = 'block';
document.getElementById('registrationForm').style.display = 'none';
document.querySelectorAll('.vehicle-card').forEach(card => {
card.classList.remove('selected');
});
}

// Validate National ID
function validateNationalId(input) {
const nid = input.value.replace(/[^0-9]/g, '');
input.value = nid;
const msgDiv = document.getElementById('nidValidation');

if (nid.length === 0) {
msgDiv.style.display = 'none';
input.style.borderColor = 'var(--glass-border)';
return;
}

if (nid.length !== 14) {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(231, 76, 60, 0.1)';
msgDiv.style.color = 'var(--danger)';
msgDiv.innerText = 'âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù…';
input.style.borderColor = 'var(--danger)';
return false;
}

const century = nid[0];
if (!['2', '3'].includes(century)) {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(231, 76, 60, 0.1)';
msgDiv.style.color = 'var(--danger)';
msgDiv.innerText = 'âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 2 Ø£Ùˆ 3)';
input.style.borderColor = 'var(--danger)';
return false;
}

const year = parseInt((century === '2' ? '19' : '20') + nid.substring(1, 3));
const month = parseInt(nid.substring(3, 5));
const day = parseInt(nid.substring(5, 7));

if (month < 1 || month > 12 || day < 1 || day > 31) {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(231, 76, 60, 0.1)';
msgDiv.style.color = 'var(--danger)';
msgDiv.innerText = 'âŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
input.style.borderColor = 'var(--danger)';
return false;
}

// Don't show the extracted birth date - just confirm the ID is valid
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(39, 174, 96, 0.1)';
msgDiv.style.color = 'var(--secondary)';
msgDiv.innerText = 'âœ… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ ØµØ­ÙŠØ­ - Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯Ùƒ Ù„Ù„ØªØ­Ù‚Ù‚';
input.style.borderColor = 'var(--secondary)';

// Don't auto-fill birth date - let user enter it manually
// This is intentional for verification purposes

return true;
}

// Verify Birth Date
function verifyBirthDate() {
const nid = document.getElementById('nationalId').value;
const birthInput = document.getElementById('birthDate').value;
const msgDiv = document.getElementById('birthValidation');

if (!nid || nid.length !== 14 || !birthInput) {
msgDiv.style.display = 'none';
document.getElementById('birthDate').style.borderColor = 'var(--glass-border)';
return;
}

const century = nid[0];
const year = parseInt((century === '2' ? '19' : '20') + nid.substring(1, 3));
const month = parseInt(nid.substring(3, 5));
const day = parseInt(nid.substring(5, 7));

const nidDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

if (birthInput === nidDate) {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(39, 174, 96, 0.1)';
msgDiv.style.color = 'var(--secondary)';
msgDiv.innerText = 'âœ… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©';
document.getElementById('birthDate').style.borderColor = 'var(--secondary)';
return true;
} else {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(231, 76, 60, 0.1)';
msgDiv.style.color = 'var(--danger)';
msgDiv.innerText = 'âŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ - ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
document.getElementById('birthDate').style.borderColor = 'var(--danger)';
return false;
}
}

// Make functions global
window.selectVehicleType = selectVehicleType;
window.resetVehicleSelection = resetVehicleSelection;
window.validateNationalId = validateNationalId;
window.verifyBirthDate = verifyBirthDate;
window.getStatusDisplay = function(status) {
const statusMap = {
pending: { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', color: '#f39c12', icon: 'â³' },
approved: { text: 'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„', color: '#3498db', icon: 'âœ“' },
coded: { text: 'ØªÙ… Ø§Ù„ØªÙƒÙˆÙŠØ¯', color: '#27ae60', icon: 'âœ…' },
delivered: { text: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', color: '#16a085', icon: 'ğŸ‰' }
};
return statusMap[status] || statusMap.pending;
};

// Update complaint images summary
function updateComplaintImagesSummary() {
const selfie = document.getElementById('compSelfie').files[0];
const idCard = document.getElementById('compIdCard').files[0];
const problemImages = document.getElementById('compProblemImage').files;
const vehicleImage = document.getElementById('compVehicleImage').files[0];

const summary = document.getElementById('compImagesSummary');
const list = document.getElementById('compImagesList');

let hasImages = selfie || idCard || problemImages.length > 0 || vehicleImage;

if (hasImages) {
summary.style.display = 'block';
let html = '';
if (selfie) html += `<div style="color: var(--secondary); font-weight: 600;">âœ… ØµÙˆØ±Ø© Ø³ÙŠÙ„ÙÙŠ: ${selfie.name}</div>`;
if (idCard) html += `<div style="color: var(--secondary); font-weight: 600;">âœ… ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${idCard.name}</div>`;
if (problemImages.length > 0) html += `<div style="color: var(--secondary); font-weight: 600;">âœ… ØµÙˆØ± Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: ${problemImages.length} ØµÙˆØ±Ø©</div>`;
if (vehicleImage) html += `<div style="color: var(--secondary); font-weight: 600;">âœ… ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${vehicleImage.name}</div>`;
list.innerHTML = html;
} else {
summary.style.display = 'none';
}
}

document.getElementById('compSelfie').onchange = updateComplaintImagesSummary;
document.getElementById('compIdCard').onchange = updateComplaintImagesSummary;
document.getElementById('compProblemImage').onchange = updateComplaintImagesSummary;
document.getElementById('compVehicleImage').onchange = updateComplaintImagesSummary;

// Test: Check all sections exist
setTimeout(() => {
const sections = ['portalSection', 'citizenPage', 'inquiryPage', 'complaintsPage', 'complaintInquiryPage'];
sections.forEach(id => {
const el = document.getElementById(id);
console.log(el ? `âœ… ${id}: Ù…ÙˆØ¬ÙˆØ¯` : `âŒ ${id}: Ù…ÙÙ‚ÙˆØ¯`);
});
}, 500);
</script>

<!-- Secure Configuration - EMBEDDED (Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ù…Ù„ÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©) -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Secure Configuration - Ù…Ø¯Ù…Ø¬ ÙÙŠ Ø§Ù„Ù…Ù„Ù
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const xorCipher = (str, key) => {
    let result = '';
    for (let i = 0; i < str.length; i++) {
        result += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length));
    }
    return result;
};

const b64Encode = (str) => btoa(unescape(encodeURIComponent(str)));
const b64Decode = (str) => decodeURIComponent(escape(atob(str)));

const encrypt = (data, key) => {
    const xored = xorCipher(data, key);
    return b64Encode(xored);
};

const decrypt = (encrypted, key) => {
    const decoded = b64Decode(encrypted);
    return xorCipher(decoded, key);
};

const getSecureConfig = () => {
    const encryptedFirebase = {
        a: "QUl6YVN5RFVaOEY3UmJDRUVfTDN4LXhWWXFHSHhQWnFFLXZIOWxN",
        b: "c3lzdGVtLXN0b3JhZ2UtYmQwZWQuZmlyZWJhc2VhcHAuY29t",
        c: "c3lzdGVtLXN0b3JhZ2UtYmQwZWQ=",
        d: "c3lzdGVtLXN0b3JhZ2UtYmQwZWQuZmlyZWJhc2VzdG9yYWdlLmFwcA==",
        e: "MTA1OTcyNjczMjQzMA==",
        f: "MTo1OTcyNjczMjQzMDp3ZWI6ZTRjOGUzZjNiOGUzZTNlM2UzZTNlMw=="
    };
    const encryptedCloudinary = {
        n: "ZGczdTNmMjJu",
        p: "V09SS1NBUVI="
    };
    return {
        firebase: {
            apiKey: atob(encryptedFirebase.a),
            authDomain: atob(encryptedFirebase.b),
            projectId: atob(encryptedFirebase.c),
            storageBucket: atob(encryptedFirebase.d),
            messagingSenderId: atob(encryptedFirebase.e),
            appId: atob(encryptedFirebase.f)
        },
        cloudinary: {
            cloudName: atob(encryptedCloudinary.n),
            uploadPreset: atob(encryptedCloudinary.p)
        }
    };
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECURE AUTHENTICATION - SHA-256 Password Hashing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Username: "Eltohamy" â†’ SHA-256 Hash
// Password: "551855125500" â†’ SHA-256 Hash
// âš ï¸ These are ONE-WAY hashes - CANNOT be reversed!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORED_HASHES = {
    usernameHash: "0374325315d6b42a0653e7506b7ad03345469624515b0dd327ba9ea571ca8ac3", // SHA-256("Eltohamy")
    passwordHash: "a7e5464e053f294fdf2722bac2440aa90e1296fc28a1d8a66eb635238c3b5f95"  // SHA-256("551855125500")
};

// SHA-256 Hash Function (Browser Native)
async function hashString(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Authenticate Admin (Async - uses SHA-256)
const authenticateAdmin = async (username, password) => {
    try {
        const usernameHash = await hashString(username);
        const passwordHash = await hashString(password);
        
        if (usernameHash === STORED_HASHES.usernameHash && 
            passwordHash === STORED_HASHES.passwordHash) {
            return { success: true, role: "SUPER", username: username };
        }
        
        console.warn('âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ ÙØ§Ø´Ù„Ø©');
        return { success: false, role: null, username: null };
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚:', error);
        return { success: false, role: null, username: null };
    }
};

const SESSION_KEY = 'ks_admin_session';
const SESSION_TIMEOUT = 4 * 60 * 60 * 1000;

const createSession = (username, role) => {
    const session = { username: username, role: role, timestamp: Date.now(), token: btoa(username + Date.now() + Math.random()) };
    const encrypted = encrypt(JSON.stringify(session), username + "KafrSakr");
    sessionStorage.setItem(SESSION_KEY, encrypted);
    return session;
};

const getSession = () => {
    try {
        const encrypted = sessionStorage.getItem(SESSION_KEY);
        if (!encrypted) return null;
        const possibleUsers = ['admin', 'supervisor'];
        for (let user of possibleUsers) {
            try {
                const decrypted = decrypt(encrypted, user + "KafrSakr");
                const session = JSON.parse(decrypted);
                if (Date.now() - session.timestamp > SESSION_TIMEOUT) {
                    clearSession();
                    return null;
                }
                return session;
            } catch (e) { continue; }
        }
        return null;
    } catch (e) { return null; }
};

const clearSession = () => { sessionStorage.removeItem(SESSION_KEY); };
const isAuthenticated = () => { const session = getSession(); return session !== null; };

const ENCRYPTION_KEY = "KafrSakr@2026#SecureData";

const encryptSensitiveData = (data) => {
    if (data.nationalId) {
        data.nationalId_encrypted = encrypt(data.nationalId, ENCRYPTION_KEY);
        data.nationalId = data.nationalId.substring(0, 4) + "****" + data.nationalId.substring(10);
    }
    if (data.phone) {
        data.phone_encrypted = encrypt(data.phone, ENCRYPTION_KEY);
        data.phone_display = data.phone.substring(0, 3) + "****" + data.phone.substring(8);
    }
    if (data.birthDate) {
        data.birthDate_encrypted = encrypt(data.birthDate, ENCRYPTION_KEY);
    }
    return data;
};

const decryptSensitiveData = (data) => {
    if (data.nationalId_encrypted) {
        data.nationalId = decrypt(data.nationalId_encrypted, ENCRYPTION_KEY);
    }
    if (data.phone_encrypted) {
        data.phone = decrypt(data.phone_encrypted, ENCRYPTION_KEY);
    }
    if (data.birthDate_encrypted) {
        data.birthDate = decrypt(data.birthDate_encrypted, ENCRYPTION_KEY);
    }
    return data;
};

const setupAdminCredentials = (credentials) => {
    localStorage.setItem('admin_credentials', JSON.stringify(credentials));
    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„');
};

window.SecureConfig = {
    getSecureConfig,
    authenticateAdmin,
    createSession,
    getSession,
    clearSession,
    isAuthenticated,
    encryptSensitiveData,
    decryptSensitiveData,
    encrypt,
    decrypt,
    setupAdminCredentials
};

console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ø§Ù† Ø¬Ø§Ù‡Ø² ÙˆÙ…Ø¯Ù…Ø¬ ÙÙŠ Ø§Ù„Ù…Ù„Ù');
</script>

<!-- Firebase Integration - SECURE VERSION -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Get encrypted configuration from global SecureConfig object
const secureConfig = window.SecureConfig.getSecureConfig();
const firebaseConfig = secureConfig.firebase;

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const dbRef = collection(db, "orders");
const compRef = collection(db, "complaints");

// Make Firebase instances globally available
window.firebaseDb = db;
window.dbRef = dbRef;
window.compRef = compRef;
window.encryptSensitiveData = window.SecureConfig.encryptSensitiveData;
window.decryptSensitiveData = window.SecureConfig.decryptSensitiveData;

console.log('âœ… Firebase Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­ (ÙˆØ¶Ø¹ Ø¢Ù…Ù†)!');

// Cloudinary Configuration (Encrypted)
const CLOUDINARY_CLOUD_NAME = secureConfig.cloudinary.cloudName;
const CLOUDINARY_UPLOAD_PRESET = secureConfig.cloudinary.uploadPreset;

// Upload to Cloudinary
const uploadToCloudinary = async (file) => {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = async (e) => {
const img = new Image();
img.src = e.target.result;
img.onload = async () => {
const canvas = document.createElement('canvas');
const maxWidth = 800;
const scale = img.width > maxWidth ? maxWidth / img.width : 1;
canvas.width = img.width * scale;
canvas.height = img.height * scale;
const ctx = canvas.getContext('2d');
ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

canvas.toBlob(async (blob) => {
try {
const formData = new FormData();
formData.append('file', blob);
formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
method: 'POST',
body: formData
});

const data = await response.json();
if (data.secure_url) {
resolve(data.secure_url);
} else {
reject(new Error('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©'));
}
} catch (error) {
reject(new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹: ${error.message}`));
}
}, 'image/jpeg', 0.70);
};
};
});
};

// Format DateTime
function formatDateTime(ts) {
if (!ts) return "-";
const d = new Date(ts);
return d.toLocaleDateString('ar-EG') + " " + d.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
}

// Make formatDateTime globally available
window.formatDateTime = formatDateTime;

// Submit Vehicle Registration (WITH ENCRYPTION)
document.getElementById('submitBtn').onclick = async () => {
const btn = document.getElementById('submitBtn');
const files = document.getElementById('multiFiles').files;
const owner = document.getElementById('ownerName').value.trim();
const nid = document.getElementById('nationalId').value.trim();
const phone = document.getElementById('phone').value.trim();
const year = document.getElementById('vYear').value;
const color = document.getElementById('vColor').value.trim();
const address = document.getElementById('address').value.trim();
const vType = document.getElementById('vType').value;
const birthDate = document.getElementById('birthDate').value;

// Validate National ID
if (!validateNationalId(document.getElementById('nationalId'))) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ ØµØ­ÙŠØ­ (14 Ø±Ù‚Ù…)");
return;
}

// Verify Birth Date
if (!verifyBirthDate()) {
alert("âŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ");
return;
}

if (!owner || nid.length !== 14 || phone.length !== 11 || !year || !vType || files.length === 0 || !birthDate) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
return;
}

// Check duplicate with birth date verification
const checkSnap = await getDocs(query(dbRef, where("nationalId", "==", nid)));
if (!checkSnap.empty) {
// Check if birth date matches
const existingData = checkSnap.docs[0].data();
if (existingData.birthDate === birthDate) {
alert("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© (Firebase)!");
return;
} else {
alert("âš ï¸ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ Ù…Ø´Ø§Ø¨Ù‡ Ù„ÙƒÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù…Ø®ØªÙ„Ù. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
return;
}
}

// Check duplicate in LocalStorage
const localKeys = Object.keys(localStorage);
for (let key of localKeys) {
if (key.startsWith('order_')) {
try {
const localItem = JSON.parse(localStorage.getItem(key));
if (localItem.nationalId === nid) {
alert("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© (LocalStorage)!");
return;
}
if (localItem.phone === phone) {
alert("âŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‡Ø°Ø§ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©!");
return;
}
} catch (e) {
console.error('Error checking localStorage:', e);
}
}
}

document.getElementById('loadingSpinner').style.display = 'block';
btn.disabled = true;

try {
const imgUrls = [];
btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±...";
for (let i = 0; i < files.length; i++) {
const url = await uploadToCloudinary(files[i]);
imgUrls.push(url);
btn.innerText = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1} Ù…Ù† ${files.length}...`;
}

const refNumber = 'KS-' + Date.now().toString().slice(-8);

// Prepare data with encryption for sensitive fields
let dataToSave = {
owner,
nationalId: nid,
phone,
birthDate,
vType,
vYear: year,
vColor: color,
vDesc: `Ù…ÙˆØ¯ÙŠÙ„ ${year} - Ù„ÙˆÙ† ${color}`,
address,
images: imgUrls,
timestamp: Date.now(),
codedAt: null,
vCode: "",
refNumber,
status: "pending",
statusHistory: [{
status: "pending",
timestamp: Date.now(),
note: "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨",
by: "system"
}]
};

// Encrypt sensitive data before saving
dataToSave = window.encryptSensitiveData(dataToSave);

await addDoc(dbRef, dataToSave);

document.getElementById('loadingSpinner').style.display = 'none';

// Send confirmation WhatsApp to citizen
const confirmMessage = `âœ… *ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!*\n\n` +
`ğŸ‘¤ Ø§Ù„Ø³ÙŠØ¯/Ø©: ${owner}\n` +
`ğŸšœ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${vType}\n` +
`ğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: *${refNumber}*\n\n` +
`âš ï¸ Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ\n\n` +
`â³ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹\n\n` +
`ğŸ“ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±: 01021102607\n\n` +
`_Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±_`;

// Auto-send WhatsApp
if (phone && phone.length === 11) {
const whatsappUrl = `https://wa.me/2${phone}?text=${encodeURIComponent(confirmMessage)}`;
window.open(whatsappUrl, '_blank');
}

alert(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“‹ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${refNumber}\n\nâš ï¸ Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ\n\nğŸ“± Ø³ÙŠØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…`);
location.reload();
} catch (e) {
document.getElementById('loadingSpinner').style.display = 'none';
alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
btn.disabled = false;
btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…";
}
};

// Inquiry Button
document.getElementById('inquiryBtn').onclick = async () => {
const owner = document.getElementById('inqOwnerName').value.trim();
const nid = document.getElementById('inqNationalId').value.trim();
const phone = document.getElementById('inqPhone').value.trim();

if (!owner || nid.length !== 14 || phone.length !== 11) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
return;
}

document.getElementById('loadingSpinner').style.display = 'block';

try {
const q = query(dbRef,
where("nationalId", "==", nid),
where("owner", "==", owner),
where("phone", "==", phone)
);

const snapshot = await getDocs(q);
const resultDiv = document.getElementById('inquiryResult');

if (snapshot.empty) {
resultDiv.style.display = 'block';
resultDiv.style.background = 'linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.1) 100%)';
resultDiv.style.border = '3px solid var(--danger)';
resultDiv.innerHTML = `
<i style="font-size: 80px; display: block; margin-bottom: 20px;">âŒ</i>
<h3 style="color: var(--danger); margin-bottom: 15px; font-size: 1.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</h3>
<p style="color: #666; font-size: 1.1rem;">ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</p>
`;
} else {
const data = snapshot.docs[0].data();
const statusInfo = window.getStatusDisplay(data.status || 'pending');

// Build status history HTML with admin info
let historyHTML = '';
if (data.statusHistory && data.statusHistory.length > 0) {
historyHTML = '<div style="background: white; padding: 25px; border-radius: 20px; margin: 25px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">';
historyHTML += '<h4 style="color: var(--primary); margin: 0 0 20px 0; font-size: 1.3rem; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">ğŸ“‹ Ø³Ø¬Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h4>';
historyHTML += '<div style="position: relative; padding-right: 30px;">';

data.statusHistory.forEach((log, index) => {
const logStatusInfo = window.getStatusDisplay(log.status);
const isLast = index === data.statusHistory.length - 1;

// Admin info
let adminInfo = '';
if (log.by) {
if (log.by === 'SUPER') {
adminInfo = '<span style="background: #e74c3c; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px;">ğŸ‘‘ Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…</span>';
} else if (log.by === 'ADMIN') {
adminInfo = '<span style="background: #3498db; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px;">ğŸ”§ Ù…Ø´Ø±Ù</span>';
} else if (log.by === 'system') {
adminInfo = '<span style="background: #95a5a6; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px;">ğŸ¤– Ø§Ù„Ù†Ø¸Ø§Ù…</span>';
} else {
adminInfo = `<span style="background: #7f8c8d; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px;">ğŸ‘¤ ${log.by}</span>`;
}
}

historyHTML += `
<div style="position: relative; margin-bottom: ${isLast ? '0' : '25px'};">
<div style="position: absolute; right: -30px; top: 5px; width: 18px; height: 18px; background: ${logStatusInfo.color}; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 2;"></div>
${!isLast ? '<div style="position: absolute; right: -21px; top: 23px; width: 2px; height: calc(100% + 25px); background: #ddd; z-index: 1;"></div>' : ''}
<div style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(250,250,250,0.95) 100%); padding: 18px; border-radius: 12px; border-right: 4px solid ${logStatusInfo.color}; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;">
<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
<span style="background: ${logStatusInfo.color}; color: white; padding: 6px 14px; border-radius: 8px; font-weight: bold; font-size: 0.95rem;">${logStatusInfo.icon} ${logStatusInfo.text}</span>
${adminInfo}
</div>
<span style="color: #999; font-size: 0.85rem; font-weight: 600;">${window.formatDateTime(log.timestamp)}</span>
</div>
${log.note ? `<p style="margin: 10px 0 0 0; color: #555; line-height: 1.6; font-size: 0.95rem; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px;">ğŸ’¬ ${log.note}</p>` : ''}
</div>
</div>
`;
});

historyHTML += '</div></div>';
}

if (data.vCode && data.vCode !== "") {
resultDiv.style.display = 'block';
resultDiv.style.background = 'linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, rgba(46, 204, 113, 0.08) 100%)';
resultDiv.style.border = '3px solid var(--secondary)';
resultDiv.innerHTML = `
<div style="text-align: center;">
<i style="font-size: 90px; display: block; margin-bottom: 20px; animation: pulse 2s infinite;">âœ…</i>
<h3 style="color: var(--secondary); margin-bottom: 25px; font-size: 2rem; font-weight: 900;">ØªÙ… Ø§Ù„ØªÙƒÙˆÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!</h3>
</div>

<div style="background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); padding: 35px; border-radius: 25px; margin: 25px 0; box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3); text-align: center;">
<p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin-bottom: 12px; font-weight: 600;">ğŸ”¢ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
<h2 style="color: white; font-size: 4.5rem; font-weight: 900; margin: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.2); letter-spacing: 3px;">${data.vCode}</h2>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">ğŸšœ ${data.vType}</p>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">ğŸ“… ${data.vYear || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">Ø§Ù„Ù„ÙˆÙ†</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">ğŸ¨ ${data.vColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
</div>
</div>

<div style="background: white; padding: 20px; border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
<div>
<p style="color: #999; font-size: 0.85rem; margin: 0 0 5px 0;">ğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0; font-family: monospace;">${data.refNumber || 'N/A'}</p>
</div>
<div>
<p style="color: #999; font-size: 0.85rem; margin: 0 0 5px 0;">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙƒÙˆÙŠØ¯</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0;">${window.formatDateTime(data.codedAt)}</p>
</div>
</div>
</div>

${historyHTML}

<div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 2px solid rgba(52, 152, 219, 0.3); text-align: center;">
<p style="margin: 0; color: var(--info); font-size: 1rem; line-height: 1.8;">
<strong style="font-size: 1.1rem;">âœ… ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</strong><br>
<span style="font-size: 0.95rem;">ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ù…Ù‚Ø± Ø±Ø¦Ø§Ø³Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ù…Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</span>
</p>
</div>
`;
} else {
resultDiv.style.display = 'block';
resultDiv.style.background = 'linear-gradient(135deg, rgba(243, 156, 18, 0.08) 0%, rgba(214, 137, 16, 0.08) 100%)';
resultDiv.style.border = '3px solid var(--warning)';
resultDiv.innerHTML = `
<div style="text-align: center;">
<i style="font-size: 90px; display: block; margin-bottom: 20px; animation: pulse 2s infinite;">${statusInfo.icon}</i>
<h3 style="color: var(--warning); margin-bottom: 20px; font-size: 2rem; font-weight: 900;">${statusInfo.text}</h3>
</div>

<div style="background: ${statusInfo.color}; color: white; padding: 25px; border-radius: 20px; margin: 25px 0; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
<p style="margin: 0; font-size: 1.3rem; font-weight: bold;">${statusInfo.icon} ${statusInfo.text}</p>
<p style="margin: 10px 0 0 0; font-size: 1rem; opacity: 0.95;">Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">ğŸšœ ${data.vType}</p>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">ğŸ“… ${data.vYear || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">Ø§Ù„Ù„ÙˆÙ†</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">ğŸ¨ ${data.vColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
</div>
</div>

<div style="background: white; padding: 20px; border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
<div>
<p style="color: #999; font-size: 0.85rem; margin: 0 0 5px 0;">ğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0; font-family: monospace;">${data.refNumber || 'N/A'}</p>
</div>
<div>
<p style="color: #999; font-size: 0.85rem; margin: 0 0 5px 0;">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0;">${window.formatDateTime(data.timestamp)}</p>
</div>
</div>
</div>

${historyHTML}

<div style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.1) 0%, rgba(214, 137, 16, 0.1) 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 2px solid rgba(243, 156, 18, 0.3); text-align: center;">
<p style="margin: 0; color: var(--warning); font-size: 1rem; line-height: 1.8;">
<strong style="font-size: 1.1rem;">â³ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</strong><br>
<span style="font-size: 0.95rem;">Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹</span>
</p>
</div>
`;
}
}

document.getElementById('loadingSpinner').style.display = 'none';
} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
}
};

// Submit Complaint
document.getElementById('submitCompBtn').onclick = async () => {
const btn = document.getElementById('submitCompBtn');
const ownerName = document.getElementById('compOwnerName').value.trim();
const nid = document.getElementById('compNationalId').value.trim();
const phone = document.getElementById('compPhone').value.trim();
const compType = document.getElementById('compType').value;
const details = document.getElementById('compDetails').value.trim();

// Get all image files
const selfie = document.getElementById('compSelfie').files[0];
const idCard = document.getElementById('compIdCard').files[0];
const problemImages = document.getElementById('compProblemImage').files;
const vehicleImage = document.getElementById('compVehicleImage').files[0];

if (!ownerName || nid.length !== 14 || phone.length !== 11 || !compType || !details) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
return;
}

if (!selfie || !idCard || !vehicleImage) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\nâ€¢ ØµÙˆØ±Ø© Ø³ÙŠÙ„ÙÙŠ\nâ€¢ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©\nâ€¢ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©/Ø§Ù„ÙƒÙˆØ¯");
return;
}

document.getElementById('loadingSpinner').style.display = 'block';
btn.disabled = true;
btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

try {
const imgUrls = {
selfie: '',
idCard: '',
problemImages: [],
vehicleImage: ''
};

// Upload selfie
btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø³ÙŠÙ„ÙÙŠ...";
imgUrls.selfie = await uploadToCloudinary(selfie);

// Upload ID card
btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...";
imgUrls.idCard = await uploadToCloudinary(idCard);

// Upload vehicle image
btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©...";
imgUrls.vehicleImage = await uploadToCloudinary(vehicleImage);

// Upload problem images
if (problemImages.length > 0) {
for (let i = 0; i < problemImages.length; i++) {
btn.innerText = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ${i + 1} Ù…Ù† ${problemImages.length}...`;
const url = await uploadToCloudinary(problemImages[i]);
imgUrls.problemImages.push(url);
}
}

await addDoc(compRef, {
ownerName,
nationalId: nid,
phone,
type: compType,
details,
images: imgUrls,
status: 'pending',
reply: '',
timestamp: Date.now()
});

document.getElementById('loadingSpinner').style.display = 'none';

// Send confirmation WhatsApp to citizen
const confirmMessage = `âœ… *ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø´ÙƒÙˆØ§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!*\n\n` +
`ğŸ‘¤ Ø§Ù„Ø³ÙŠØ¯/Ø©: ${ownerName}\n` +
`ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰: ${compType}\n` +
`ğŸ“¸ ØªÙ… Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\n\n` +
`â³ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´ÙƒÙˆØ§Ùƒ ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª\n\n` +
`ğŸ“ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±: 01021102607\n\n` +
`_Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±_`;

// Auto-send WhatsApp (no confirmation needed for citizen's own submission)
if (phone && phone.length === 11) {
const whatsappUrl = `https://wa.me/2${phone}?text=${encodeURIComponent(confirmMessage)}`;
window.open(whatsappUrl, '_blank');
}

alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø´ÙƒÙˆØ§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“‹ ØªÙ… Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\nâ³ Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø±Ø¯ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª.\n\nğŸ“± Ø³ÙŠØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…");
location.reload();
} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
alert("âŒ Ø®Ø·Ø£: " + error.message);
btn.disabled = false;
btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ âœ‰ï¸";
}
};

// Complaint Inquiry
document.getElementById('complaintInquiryBtn').onclick = async () => {
const owner = document.getElementById('compInqOwnerName').value.trim();
const nid = document.getElementById('compInqNationalId').value.trim();
const phone = document.getElementById('compInqPhone').value.trim();

if (!owner || nid.length !== 14 || phone.length !== 11) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
return;
}

document.getElementById('loadingSpinner').style.display = 'block';

try {
const q = query(compRef,
where("nationalId", "==", nid),
where("ownerName", "==", owner),
where("phone", "==", phone),
orderBy("timestamp", "desc")
);

const snapshot = await getDocs(q);
const resultDiv = document.getElementById('complaintInquiryResult');

if (snapshot.empty) {
resultDiv.style.display = 'block';
resultDiv.innerHTML = `
<div style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.1) 100%); padding: 40px; border-radius: 25px; text-align: center; border: 3px solid var(--danger);">
<i style="font-size: 80px; display: block; margin-bottom: 20px;">âŒ</i>
<h3 style="color: var(--danger); margin-bottom: 15px; font-size: 1.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰ Ù…Ø·Ø§Ø¨Ù‚Ø©</h3>
<p style="color: #666; font-size: 1.1rem;">ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</p>
</div>
`;
} else {
let complaintsHTML = '';
snapshot.forEach((doc) => {
const data = doc.data();
const statusColor = data.status === 'replied' ? 'var(--secondary)' : 'var(--warning)';
const statusText = data.status === 'replied' ? 'âœ… ØªÙ… Ø§Ù„Ø±Ø¯' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
const statusBg = data.status === 'replied' ? 'rgba(39, 174, 96, 0.15)' : 'rgba(243, 156, 18, 0.15)';

complaintsHTML += `
<div style="background: linear-gradient(135deg, ${statusBg} 0%, ${statusBg} 100%); padding: 30px; border-radius: 20px; margin-bottom: 20px; border: 3px solid ${statusColor};">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="color: ${statusColor}; margin: 0; font-size: 1.5rem;">${data.type}</h3>
<span style="background: ${statusColor}; color: white; padding: 8px 16px; border-radius: 10px; font-weight: bold;">${statusText}</span>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
<p style="color: #666; margin: 0; line-height: 1.8;"><strong style="color: var(--primary);">Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong><br>${data.details}</p>
</div>
<p style="color: #666; font-size: 0.9rem;"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…:</strong> ${formatDateTime(data.timestamp)}</p>
${data.images ? `
<div style="margin: 15px 0;">
<button class="btn btn-view-inquiry-images" data-doc-id="${doc.id}" style="background: rgba(211, 84, 0, 0.1); color: var(--accent); padding: 10px 20px; border-radius: 12px; font-weight: bold;">ğŸ–¼ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø©</button>
</div>
` : ''}
${data.status === 'replied' && data.reply ? `
<div style="background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(46, 204, 113, 0.1) 100%); padding: 20px; border-radius: 15px; border: 2px solid var(--secondary); margin-top: 15px;">
<p style="color: var(--secondary); margin: 0 0 10px 0; font-weight: bold; font-size: 1.1rem;">ğŸ’¬ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</p>
<p style="color: #555; margin: 0; line-height: 1.8;">${data.reply}</p>
</div>
` : `
<div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px;">
<p style="color: var(--warning); margin: 0; font-weight: bold;">â³ Ø´ÙƒÙˆØ§Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª</p>
</div>
`}
</div>
`;
});

resultDiv.style.display = 'block';
resultDiv.innerHTML = `
<h3 style="text-align: center; color: var(--primary); margin-bottom: 30px; font-size: 1.8rem;">Ø´ÙƒØ§ÙˆÙŠÙƒ (${snapshot.size})</h3>
${complaintsHTML}
`;

// Add event listeners for image viewing buttons
const complaintsData = {};
snapshot.forEach((doc) => {
complaintsData[doc.id] = doc.data();
});

resultDiv.querySelectorAll('.btn-view-inquiry-images').forEach(btn => {
btn.onclick = () => {
const docId = btn.getAttribute('data-doc-id');
const data = complaintsData[docId];
if (data && data.images) {
if (typeof data.images === 'object' && !Array.isArray(data.images)) {
// New format: categorized images
showCategorizedImages(data.images);
} else if (Array.isArray(data.images)) {
// Old format: array of images
viewImages(data.images);
}
} else {
alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶");
}
};
});
}

document.getElementById('loadingSpinner').style.display = 'none';
} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
console.error(error);
}
};
</script>

<!-- Admin Panel JavaScript -->
<script type="module">
import { getDocs, query, orderBy, updateDoc, deleteDoc, doc, onSnapshot, addDoc, where, collection, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Access Firebase instances from window (no redeclaration - using window directly)
let currentEditId = "";
let userRole = "";
let currentUsername = "";

// Create admin logs collection reference
const adminLogsRef = collection(window.firebaseDb, "adminLogs");

// Log Admin Action
async function logAdminAction(username, action, details) {
try {
await addDoc(adminLogsRef, {
username: username,
role: userRole,
action: action,
details: details,
timestamp: Date.now(),
ipAddress: 'N/A'
});
} catch (error) {
console.error("Error logging action:", error);
}
}

window.logAdminAction = logAdminAction;

// Send WhatsApp Notification Function
async function sendWhatsAppNotification(phone, message, confirmMessage = "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…ÙˆØ§Ø·Ù†ØŸ") {
if (!phone || phone.length !== 11) {
return false;
}

const whatsappUrl = `https://wa.me/2${phone}?text=${encodeURIComponent(message)}`;

if (confirm(confirmMessage)) {
window.open(whatsappUrl, '_blank');
return true;
}
return false;
}

window.sendWhatsAppNotification = sendWhatsAppNotification;

// Get Smart Next Code
async function getSmartNextCode() {
const snap = await getDocs(window.dbRef);
let maxCode = 100;
snap.forEach(d => {
const code = parseInt(d.data().vCode);
if (!isNaN(code) && code > maxCode) maxCode = code;
});
return { last: maxCode, next: maxCode + 1 };
}

// Make getSmartNextCode global
window.getSmartNextCode = getSmartNextCode;

// Login (SECURE VERSION)
document.getElementById('loginBtn').onclick = () => {
document.getElementById('loginModal').style.display = 'block';
document.getElementById('loginUsername').value = '';
document.getElementById('loginPassword').value = '';
document.getElementById('loginUsername').focus();
};

document.getElementById('confirmLoginBtn').onclick = async () => {
const u = document.getElementById('loginUsername').value.trim();
const p = document.getElementById('loginPassword').value;

if (!u || !p) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
return;
}

// Show loading
const btn = document.getElementById('confirmLoginBtn');
const originalText = btn.innerText;
btn.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
btn.disabled = true;

// Use SHA-256 authentication (async)
const authResult = await authenticateAdmin(u, p);

if (!authResult.success) {
alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
btn.innerText = originalText;
btn.disabled = false;
// Log failed login attempt
await logAdminAction('Unknown', 'Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ ÙØ§Ø´Ù„Ø©', `Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³Ù…: ${u}`);
return;
}

// Create secure session
const session = createSession(authResult.username, authResult.role);
userRole = authResult.role;
currentUsername = authResult.username;

// Hide login modal
document.getElementById('loginModal').style.display = 'none';

// Log admin login
await logAdminAction(currentUsername, 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„', `Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨ØµÙ„Ø§Ø­ÙŠØ©: ${userRole}`);

// Show role badge
const roleBadge = userRole === "SUPER" ? "ğŸ‘‘ Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…" : userRole === "ADMIN" ? "ğŸ”§ Ù…Ø´Ø±Ù" : "ğŸ‘ï¸ Ø¹Ø±Ø¶ ÙÙ‚Ø·";
const roleColor = userRole === "SUPER" ? "#e74c3c" : userRole === "ADMIN" ? "#3498db" : "#95a5a6";

document.getElementById('portalSection').style.display = 'none';
document.getElementById('citizenPage').style.display = 'none';
document.getElementById('inquiryPage').style.display = 'none';
document.getElementById('complaintsPage').style.display = 'none';
document.getElementById('complaintInquiryPage').style.display = 'none';
document.getElementById('adminPage').style.display = 'block';
document.getElementById('goPortalBtn').style.display = 'inline-flex';

// Add role badge to header
const header = document.querySelector('header');
const existingBadge = document.getElementById('roleBadge');
if (existingBadge) existingBadge.remove();
const badge = document.createElement('div');
badge.id = 'roleBadge';
badge.style.cssText = `background: ${roleColor}; color: white; padding: 8px 20px; border-radius: 12px; font-weight: bold; font-size: 0.9rem;`;
badge.innerText = roleBadge;
header.appendChild(badge);

loadAdminData();
loadComplaints();

// Hide buttons based on role
if (userRole === 'VIEWER') {
document.getElementById('bulkImportBtn').style.display = 'none';
}

// Show cleanup button only for SUPER admin
if (userRole === 'SUPER') {
document.getElementById('cleanupDuplicatesBtn').style.display = 'inline-flex';
}
};

// View Images
function viewImages(images) {
const modal = document.getElementById("imgModal");
const mainImg = document.getElementById("mainViewImg");
const thumbContainer = document.getElementById("modalThumbnails");

thumbContainer.innerHTML = '';
mainImg.src = images[0];

images.forEach(src => {
const img = document.createElement('img');
img.src = src;
img.style.width = "80px";
img.style.height = "80px";
img.style.cursor = "pointer";
img.style.objectFit = "cover";
img.style.borderRadius = "15px";
img.style.border = "3px solid white";
img.onclick = () => mainImg.src = src;
thumbContainer.appendChild(img);
});

modal.style.display = "block";
}

// View Categorized Images (for complaints)
function showCategorizedImages(images) {
const modal = document.getElementById("imgModal");
const mainImg = document.getElementById("mainViewImg");
const thumbContainer = document.getElementById("modalThumbnails");

thumbContainer.innerHTML = '';

// Collect all images with labels
const allImages = [];

if (images.selfie) {
allImages.push({ url: images.selfie, label: 'ğŸ“¸ ØµÙˆØ±Ø© Ø³ÙŠÙ„ÙÙŠ' });
}
if (images.idCard) {
allImages.push({ url: images.idCard, label: 'ğŸªª ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©' });
}
if (images.vehicleImage) {
allImages.push({ url: images.vehicleImage, label: 'ğŸšœ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©/Ø§Ù„ÙƒÙˆØ¯' });
}
if (images.problemImages && images.problemImages.length > 0) {
images.problemImages.forEach((url, index) => {
allImages.push({ url: url, label: `ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ${index + 1}` });
});
}

if (allImages.length === 0) {
alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶");
return;
}

// Set first image
mainImg.src = allImages[0].url;

// Create thumbnails with labels
allImages.forEach(imgData => {
const container = document.createElement('div');
container.style.textAlign = 'center';

const img = document.createElement('img');
img.src = imgData.url;
img.style.width = "80px";
img.style.height = "80px";
img.style.cursor = "pointer";
img.style.objectFit = "cover";
img.style.borderRadius = "15px";
img.style.border = "3px solid white";
img.onclick = () => mainImg.src = imgData.url;

const label = document.createElement('div');
label.innerText = imgData.label;
label.style.color = 'white';
label.style.fontSize = '0.75rem';
label.style.marginTop = '5px';
label.style.fontWeight = 'bold';

container.appendChild(img);
container.appendChild(label);
thumbContainer.appendChild(container);
});

modal.style.display = "block";
}

// Pagination & Progressive Loading Variables
let ordersArray = [];
let currentPage = 1;
let recordsPerPage = 100;
let allDataLoaded = false;

// Load Admin Data with Progressive Loading (Firebase + LocalStorage)
function loadAdminData() {
// Load first 100 records from Firebase
const initialQuery = query(window.dbRef, orderBy("timestamp", "desc"), limit(100));
  
onSnapshot(initialQuery, async (snap) => {
ordersArray = [];
let total = 0, coded = 0, pending = 0;

// 1. Load from Firebase
snap.forEach(s => {
const item = s.data();
const id = s.id;
ordersArray.push({ ...item, id, source: 'firebase' });
total++;
item.vCode ? coded++ : pending++;
});

// 2. Load from LocalStorage
const localKeys = Object.keys(localStorage);
localKeys.forEach(key => {
if (key.startsWith('order_')) {
try {
const item = JSON.parse(localStorage.getItem(key));
ordersArray.push({ ...item, id: key, source: 'localStorage' });
total++;
item.vCode ? coded++ : pending++;
} catch (e) {
console.error('Error parsing localStorage item:', key, e);
}
}
});

// 3. Remove duplicates (keep first occurrence)
const seenNIDs = new Set();
const seenRefs = new Set();
ordersArray = ordersArray.filter(item => {
// Check by nationalId
if (item.nationalId && seenNIDs.has(item.nationalId)) {
return false; // Skip duplicate
}
// Check by refNumber
if (item.refNumber && seenRefs.has(item.refNumber)) {
return false; // Skip duplicate
}
// Mark as seen
if (item.nationalId) seenNIDs.add(item.nationalId);
if (item.refNumber) seenRefs.add(item.refNumber);
return true; // Keep this record
});

// Check if there are more than 100 records in Firebase
const countQuery = query(window.dbRef);
const countSnap = await getDocs(countQuery);
const totalFirebaseRecords = countSnap.size;

// Show "Load All Data" button if more than 100 records
if (totalFirebaseRecords > 100 && !allDataLoaded) {
document.getElementById('loadAllDataBtn').style.display = 'inline-flex';
} else {
document.getElementById('loadAllDataBtn').style.display = 'none';
}

document.getElementById('totalRecordsInfo').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${ordersArray.length} Ø³Ø¬Ù„`;
document.getElementById('statTotal').innerText = ordersArray.length;
document.getElementById('statCoded').innerText = coded;
document.getElementById('statPending').innerText = pending;

// Sort by vCode numerically
ordersArray.sort((a, b) => {
const codeA = parseInt(a.vCode) || 0;
const codeB = parseInt(b.vCode) || 0;
return codeB - codeA;
});

renderCurrentPage();
initializePagination();
});
}

// Load All Data Function
window.loadAllData = async function() {
document.getElementById('loadingMoreInfo').style.display = 'inline';
document.getElementById('loadAllDataBtn').style.display = 'none';

try {
const allQuery = query(window.dbRef, orderBy("timestamp", "desc"));
const allSnap = await getDocs(allQuery);

ordersArray = [];
allSnap.forEach(s => {
const item = s.data();
const id = s.id;
ordersArray.push({ ...item, id });
});

// Sort by vCode
ordersArray.sort((a, b) => {
const codeA = parseInt(a.vCode) || 0;
const codeB = parseInt(b.vCode) || 0;
return codeB - codeA;
});

allDataLoaded = true;
document.getElementById('totalRecordsInfo').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${ordersArray.length} Ø³Ø¬Ù„`;
document.getElementById('loadingMoreInfo').style.display = 'none';

currentPage = 1;
renderCurrentPage();
initializePagination();

alert(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${ordersArray.length} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­!`);
} catch (error) {
console.error('Error loading all data:', error);
document.getElementById('loadingMoreInfo').style.display = 'none';
document.getElementById('loadAllDataBtn').style.display = 'inline-flex';
alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}
};

// Render Current Page
function renderCurrentPage() {
const tableBody = document.getElementById('dataTable');
tableBody.innerHTML = '';

const start = (currentPage - 1) * recordsPerPage;
const end = start + recordsPerPage;
const pageData = ordersArray.slice(start, end);

pageData.forEach(item => {
const id = item.id;
const statusInfo = window.getStatusDisplay(item.status || 'pending');

const tr = document.createElement('tr');
tr.innerHTML = `
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:bold;">${item.owner}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-weight:600;">${item.nationalId}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:600;">${item.phone || '-'}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85);"><span style="background:linear-gradient(135deg, var(--info) 0%, var(--primary) 100%); color:white; padding:6px 12px; border-radius:10px; font-weight:bold;">${item.vType}</span></td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:600; color:#555;">${item.vYear || '-'}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:600; color:#555;">${item.chassis || '-'}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:600; color:#555;">${item.motor || '-'}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color:#555;" title="${item.address || '-'}">${item.address || '-'}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-size:0.9rem; color:#666;">${window.formatDateTime(item.timestamp)}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:bold; font-size:1.2rem; color:${item.vCode ? 'var(--secondary)' : 'var(--danger)'}">${item.vCode || '-'}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85);"><button class="btn view-btn" style="background:rgba(26, 82, 118, 0.12); color:var(--primary); padding:10px 16px;">ğŸ–¼ï¸ ${item.images ? item.images.length : 0}</button></td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); display:flex; gap:8px;">
<button class="btn btn-status" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©" style="padding:10px 14px; background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'};">ğŸ”„</button>
<button class="btn btn-code" title="ØªÙƒÙˆÙŠØ¯" style="padding:10px 14px; background: linear-gradient(135deg, var(--info) 0%, #2874a6 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'};">ğŸ”¢</button>
<button class="btn btn-edit" title="ØªØ¹Ø¯ÙŠÙ„" style="padding:10px 14px; background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'};">âœï¸</button>
<button class="btn btn-del" title="Ø­Ø°Ù" style="padding:10px 14px; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white; display: ${userRole === 'SUPER' ? 'inline-flex' : 'none'};">ğŸ—‘ï¸</button>
<button class="btn btn-log" title="Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" style="padding:10px 14px; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white;">ğŸ“‹</button>
</td>
`;

// Add event listeners (same as before)
tr.querySelector('.btn-status').onclick = async () => {
document.getElementById('statusChangeModal').style.display = 'block';
document.getElementById('newStatusSelect').value = item.status || 'pending';
document.getElementById('statusNote').value = '';
document.getElementById('sendWhatsAppStatus').checked = true;
window.currentStatusChangeItem = { item, id };
};

tr.querySelector('.btn-code').onclick = async () => {
if (item.vCode) {
alert("âš ï¸ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…ÙƒÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø±Ù‚Ù…: " + item.vCode);
return;
}
const info = await getSmartNextCode();
document.getElementById('codeHint').innerText = `Ø¢Ø®Ø± ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: (${info.last}) | Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­: (${info.next})`;
document.getElementById('manualCodeInput').value = info.next;
document.getElementById('codeModal').style.display = 'block';

document.getElementById('confirmCodeBtn').onclick = async () => {
const newCode = document.getElementById('manualCodeInput').value;
if (!newCode) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ØµØ­ÙŠØ­");
return;
}
document.getElementById('loadingSpinner').style.display = 'block';
await updateDoc(doc(window.firebaseDb, "orders", id), {
vCode: newCode.toString(),
codedAt: Date.now(),
status: "coded",
statusHistory: [...(item.statusHistory || []), {
status: "coded",
timestamp: Date.now(),
note: `ØªÙ… Ø§Ù„ØªÙƒÙˆÙŠØ¯ Ø¨Ø±Ù‚Ù…: ${newCode}`,
by: userRole
}]
});
await logAdminAction(currentUsername, 'ØªÙƒÙˆÙŠØ¯ Ù…Ø±ÙƒØ¨Ø©', `ØªÙ… ØªÙƒÙˆÙŠØ¯ Ù…Ø±ÙƒØ¨Ø© ${item.vType} Ù„Ù„Ù…Ø§Ù„Ùƒ: ${item.owner} Ø¨Ø§Ù„ÙƒÙˆØ¯: ${newCode}`);
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('codeModal').style.display = 'none';
const sendWhatsApp = document.getElementById('sendWhatsAppCode').checked;
if (sendWhatsApp) {
const message = `ğŸ‰ *ØªÙ… ØªÙƒÙˆÙŠØ¯ Ù…Ø±ÙƒØ¨ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!*\n\nğŸ‘¤ Ø§Ù„Ø³ÙŠØ¯/Ø©: ${item.owner}\nğŸ”¢ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: *${newCode}*\nğŸšœ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${item.vType}\nğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${item.refNumber}\n\nâœ… ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø±\n\n_Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±_`;
if (item.phone && item.phone.length === 11) {
const whatsappUrl = `https://wa.me/2${item.phone}?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl, '_blank');
}
}
alert("âœ… ØªÙ… Ø§Ù„ØªÙƒÙˆÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!" + (sendWhatsApp && item.phone && item.phone.length === 11 ? "\nğŸ“± ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" : ""));
};
};

tr.querySelector('.btn-edit').onclick = async () => {
document.getElementById('editOwnerName').value = item.owner;
document.getElementById('editPhone').value = item.phone || '';
document.getElementById('editVType').value = item.vType;
document.getElementById('editVYear').value = item.vYear || '';
document.getElementById('editAddress').value = item.address || '';
document.getElementById('editModal').style.display = 'block';

document.getElementById('confirmEditBtn').onclick = async () => {
const newOwner = document.getElementById('editOwnerName').value.trim();
const newPhone = document.getElementById('editPhone').value.trim();
const newVType = document.getElementById('editVType').value;
const newVYear = document.getElementById('editVYear').value;
const newAddress = document.getElementById('editAddress').value.trim();
if (!newOwner || !newPhone || newPhone.length !== 11) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
return;
}
document.getElementById('loadingSpinner').style.display = 'block';
await updateDoc(doc(window.firebaseDb, "orders", id), {
owner: newOwner,
phone: newPhone,
vType: newVType,
vYear: newVYear,
vDesc: `Ù…ÙˆØ¯ÙŠÙ„ ${newVYear}`,
address: newAddress,
statusHistory: [...(item.statusHistory || []), {
status: item.status || 'pending',
timestamp: Date.now(),
note: "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
by: userRole
}]
});
await logAdminAction(currentUsername, 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª', `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ÙƒØ¨Ø© ${item.vType} Ù„Ù„Ù…Ø§Ù„Ùƒ: ${item.owner} (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${item.refNumber})`);
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('editModal').style.display = 'none';
alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
};
};

tr.querySelector('.btn-del').onclick = async () => {
if (confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
// Check if record is from Firebase or LocalStorage
if (item.source === 'localStorage') {
// Delete from LocalStorage
localStorage.removeItem(id);
await logAdminAction(currentUsername, 'Ø­Ø°Ù Ø·Ù„Ø¨', `ØªÙ… Ø­Ø°Ù Ø·Ù„Ø¨ Ù…Ø±ÙƒØ¨Ø© ${item.vType} Ù„Ù„Ù…Ø§Ù„Ùƒ: ${item.owner} Ù…Ù† LocalStorage`);
alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† LocalStorage Ø¨Ù†Ø¬Ø§Ø­");
} else {
// Delete from Firebase
await deleteDoc(doc(window.firebaseDb, "orders", id));
await logAdminAction(currentUsername, 'Ø­Ø°Ù Ø·Ù„Ø¨', `ØªÙ… Ø­Ø°Ù Ø·Ù„Ø¨ Ù…Ø±ÙƒØ¨Ø© ${item.vType} Ù„Ù„Ù…Ø§Ù„Ùƒ: ${item.owner} (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${item.refNumber})`);
alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Firebase Ø¨Ù†Ø¬Ø§Ø­");
}
location.reload();
}
};

tr.querySelector('.btn-log').onclick = () => {
showActivityLog(item);
};

tr.querySelector('.view-btn').onclick = () => {
if (item.images && item.images.length > 0) {
viewImages(item.images);
} else {
alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶");
}
};

tableBody.appendChild(tr);
});
}

// Initialize Pagination
function initializePagination() {
const totalPages = Math.ceil(ordersArray.length / recordsPerPage);
document.getElementById('pageInfo').innerText = `ØµÙØ­Ø© ${currentPage} Ù…Ù† ${totalPages}`;
}

// Change Page
window.changePage = function(direction) {
const totalPages = Math.ceil(ordersArray.length / recordsPerPage);
currentPage += direction;
if (currentPage < 1) currentPage = 1;
if (currentPage > totalPages) currentPage = totalPages;
renderCurrentPage();
initializePagination();
window.scrollTo({ top: 0, behavior: 'smooth' });
};

// Change Records Per Page
window.changeRecordsPerPage = function() {
recordsPerPage = parseInt(document.getElementById('recordsPerPage').value);
currentPage = 1;
renderCurrentPage();
initializePagination();
};

// Load Complaints
function loadComplaints() {
onSnapshot(query(window.compRef, orderBy("timestamp", "desc")), (snap) => {
const body = document.getElementById('compTableBody');
body.innerHTML = '';
let total = 0, pending = 0, replied = 0;

snap.forEach(s => {
const item = s.data();
const id = s.id;
total++;
item.status === 'replied' ? replied++ : pending++;

const tr = document.createElement('tr');

// Build images display HTML
let imagesHTML = '';
if (item.images) {
if (typeof item.images === 'object' && !Array.isArray(item.images)) {
// New format: categorized images
let imageCount = 0;
if (item.images.selfie) imageCount++;
if (item.images.idCard) imageCount++;
if (item.images.vehicleImage) imageCount++;
if (item.images.problemImages) imageCount += item.images.problemImages.length;

imagesHTML = `<button class="btn btn-view-comp-images" style="background:rgba(211, 84, 0, 0.1); color:var(--accent); padding:10px 14px;">ğŸ–¼ï¸ Ø¹Ø±Ø¶ (${imageCount})</button>`;
} else if (Array.isArray(item.images)) {
// Old format: array of images
imagesHTML = `<button class="btn btn-view-comp-images" style="background:rgba(211, 84, 0, 0.1); color:var(--accent); padding:10px 14px;">ğŸ–¼ï¸ Ø¹Ø±Ø¶ (${item.images.length})</button>`;
}
} else {
imagesHTML = '<span style="color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</span>';
}

tr.innerHTML = `
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:bold;">${item.ownerName}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:600;">${item.phone}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); color:var(--accent); font-weight:bold;">${item.type}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); max-width: 300px;">${item.details}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85);">${imagesHTML}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85);"><span style="background: ${item.status === 'replied' ? 'var(--secondary)' : 'var(--warning)'}; color: white; padding: 6px 12px; border-radius: 8px; font-weight: bold;">${item.status === 'replied' ? 'âœ… ØªÙ… Ø§Ù„Ø±Ø¯' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}</span></td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); display:flex; gap:8px;">
<button class="btn btn-reply" title="Ø§Ù„Ø±Ø¯" style="padding:10px 14px; background: var(--secondary); color: white;">ğŸ’¬</button>
<button class="btn btn-del" title="Ø­Ø°Ù" style="padding:10px 14px; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">ğŸ—‘ï¸</button>
</td>
`;

tr.querySelector('.btn-reply').onclick = async () => {
// Show complaint reply modal
document.getElementById('complaintReplyModal').style.display = 'block';
document.getElementById('complaintReplyText').value = item.reply || '';
document.getElementById('sendWhatsAppReply').checked = true;

// Store current complaint data
window.currentComplaintReply = { item, id };
};

tr.querySelector('.btn-del').onclick = async () => {
if (confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´ÙƒÙˆÙ‰ØŸ")) {
await deleteDoc(doc(window.firebaseDb, "complaints", id));

// Log complaint deletion
await logAdminAction(currentUsername, 'Ø­Ø°Ù Ø´ÙƒÙˆÙ‰', `ØªÙ… Ø­Ø°Ù Ø´ÙƒÙˆÙ‰ Ù…Ù† Ù†ÙˆØ¹: ${item.type} Ù„Ù„Ù…ÙˆØ§Ø·Ù†: ${item.ownerName}`);

alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
}
};

// View complaint images button
const viewBtn = tr.querySelector('.btn-view-comp-images');
if (viewBtn) {
viewBtn.onclick = () => {
if (item.images) {
if (typeof item.images === 'object' && !Array.isArray(item.images)) {
// New format: categorized images - show in modal with categories
showCategorizedImages(item.images);
} else if (Array.isArray(item.images)) {
// Old format: array of images
viewImages(item.images);
}
} else {
alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶");
}
};
}

body.appendChild(tr);
});

document.getElementById('statCompTotal').innerText = total;
});
}

// Cleanup Duplicates Function (Firebase + LocalStorage)
document.getElementById('cleanupDuplicatesBtn').onclick = async () => {
if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù…Ù†:\nâ€¢ Firebase\nâ€¢ LocalStorage\n\nØ¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰:\nâ€¢ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ\nâ€¢ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n\nØ³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£ÙˆÙ„ Ø³Ø¬Ù„ ÙÙ‚Ø·.')) {
return;
}

document.getElementById('loadingSpinner').style.display = 'block';

try {
// 1. Get all records from Firebase
const firebaseSnap = await getDocs(window.dbRef);
const firebaseRecords = [];
firebaseSnap.forEach(doc => {
firebaseRecords.push({ id: doc.id, source: 'firebase', ...doc.data() });
});

// 2. Get all records from LocalStorage
const localStorageRecords = [];
const localKeys = Object.keys(localStorage);
localKeys.forEach(key => {
if (key.startsWith('order_')) {
try {
const data = JSON.parse(localStorage.getItem(key));
localStorageRecords.push({ id: key, source: 'localStorage', ...data });
} catch (e) {
console.error('Error parsing localStorage item:', key, e);
}
}
});

// 3. Combine all records
const allRecords = [...firebaseRecords, ...localStorageRecords];
console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${allRecords.length} (Firebase: ${firebaseRecords.length}, LocalStorage: ${localStorageRecords.length})`);

// 4. Find duplicates
const seen = new Map(); // key -> first record
const duplicates = [];

allRecords.forEach(record => {
// Create unique key based on nationalId AND phone
const nidKey = record.nationalId ? `nid_${record.nationalId}` : null;
const phoneKey = record.phone ? `phone_${record.phone}` : null;

let isDuplicate = false;

// Check by nationalId
if (nidKey && seen.has(nidKey)) {
duplicates.push(record);
isDuplicate = true;
}

// Check by phone
if (phoneKey && seen.has(phoneKey)) {
if (!isDuplicate) { // Don't add twice
duplicates.push(record);
isDuplicate = true;
}
}

// If not duplicate, mark as seen
if (!isDuplicate) {
if (nidKey) seen.set(nidKey, record);
if (phoneKey) seen.set(phoneKey, record);
}
});

if (duplicates.length === 0) {
document.getElementById('loadingSpinner').style.display = 'none';
alert('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø©!');
return;
}

// 5. Delete duplicates
let deletedFromFirebase = 0;
let deletedFromLocalStorage = 0;

for (const record of duplicates) {
if (record.source === 'firebase') {
await deleteDoc(doc(window.firebaseDb, "orders", record.id));
deletedFromFirebase++;
} else if (record.source === 'localStorage') {
localStorage.removeItem(record.id);
deletedFromLocalStorage++;
}
}

// Log action
await logAdminAction(currentUsername, 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙƒØ±Ø§Ø±', `ØªÙ… Ø­Ø°Ù ${duplicates.length} Ø³Ø¬Ù„ Ù…ÙƒØ±Ø± (Firebase: ${deletedFromFirebase}, LocalStorage: ${deletedFromLocalStorage})`);

document.getElementById('loadingSpinner').style.display = 'none';
alert(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\nâ€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${allRecords.length}\nâ€¢ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: ${duplicates.length}\n  - Ù…Ù† Firebase: ${deletedFromFirebase}\n  - Ù…Ù† LocalStorage: ${deletedFromLocalStorage}\nâ€¢ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${allRecords.length - duplicates.length}`);

// Reload data
loadAdminData();
} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙƒØ±Ø§Ø±: ' + error.message);
console.error(error);
}
};

// Show Orders/Complaints
document.getElementById('showOrdersBtn').onclick = () => {
document.getElementById('ordersTableContainer').style.display = 'block';
document.getElementById('complaintsTableContainer').style.display = 'none';
document.getElementById('adminLogsTableContainer').style.display = 'none';
showAllOrdersInTable();
};

// Status Change Modal Handler
document.getElementById('confirmStatusChangeBtn').onclick = async () => {
if (!window.currentStatusChangeItem) return;

const { item, id } = window.currentStatusChangeItem;
const newStatus = document.getElementById('newStatusSelect').value;
const note = document.getElementById('statusNote').value.trim();
const sendWhatsApp = document.getElementById('sendWhatsAppStatus').checked;

const statusNames = {
"pending": "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
"approved": "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„",
"coded": "ØªÙ… Ø§Ù„ØªÙƒÙˆÙŠØ¯",
"delivered": "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
};

document.getElementById('loadingSpinner').style.display = 'block';

await updateDoc(doc(window.firebaseDb, "orders", id), {
status: newStatus,
statusHistory: [...(item.statusHistory || []), {
status: newStatus,
timestamp: Date.now(),
note: note || "",
by: userRole
}]
});

// Log status change action
await logAdminAction(currentUsername, 'ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø©', `ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù…Ø±ÙƒØ¨Ø© ${item.vType} Ù„Ù„Ù…Ø§Ù„Ùƒ: ${item.owner} Ø¥Ù„Ù‰: ${statusNames[newStatus]} (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${item.refNumber})`);

// Send WhatsApp notification if checkbox is checked
if (sendWhatsApp && item.phone && item.phone.length === 11) {
let message = '';
const statusName = statusNames[newStatus];

if (newStatus === 'approved') {
message = `âœ… *ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ!*\n\n` +
`ğŸ‘¤ Ø§Ù„Ø³ÙŠØ¯/Ø©: ${item.owner}\n` +
`ğŸšœ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${item.vType}\n` +
`ğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${item.refNumber}\n\n` +
`âœ… Ø§Ù„Ø­Ø§Ù„Ø©: ${statusName}\n` +
`â³ Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„ØªÙƒÙˆÙŠØ¯ØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹\n\n` +
`_Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±_`;
} else if (newStatus === 'delivered') {
message = `ğŸ‰ *ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©!*\n\n` +
`ğŸ‘¤ Ø§Ù„Ø³ÙŠØ¯/Ø©: ${item.owner}\n` +
`ğŸšœ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${item.vType}\n` +
`ğŸ”¢ Ø§Ù„ÙƒÙˆØ¯: ${item.vCode || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\n` +
`ğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${item.refNumber}\n\n` +
`âœ… Ø§Ù„Ø­Ø§Ù„Ø©: ${statusName}\n` +
`ğŸŠ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ÙƒÙ… Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„ØªÙƒÙˆÙŠØ¯\n\n` +
`_Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±_`;
} else if (newStatus === 'pending') {
message = `â³ *ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨*\n\n` +
`ğŸ‘¤ Ø§Ù„Ø³ÙŠØ¯/Ø©: ${item.owner}\n` +
`ğŸšœ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${item.vType}\n` +
`ğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${item.refNumber}\n\n` +
`â³ Ø§Ù„Ø­Ø§Ù„Ø©: ${statusName}\n` +
`ğŸ“ Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\n\n` +
`_Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±_`;
} else if (newStatus === 'coded') {
message = `âœ… *ØªÙ… ØªÙƒÙˆÙŠØ¯ Ù…Ø±ÙƒØ¨ØªÙƒ!*\n\n` +
`ğŸ‘¤ Ø§Ù„Ø³ÙŠØ¯/Ø©: ${item.owner}\n` +
`ğŸšœ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${item.vType}\n` +
`ğŸ”¢ Ø§Ù„ÙƒÙˆØ¯: ${item.vCode || 'Ø³ÙŠØªÙ… Ø¥Ø¨Ù„Ø§ØºÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹'}\n` +
`ğŸ“‹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${item.refNumber}\n\n` +
`âœ… Ø§Ù„Ø­Ø§Ù„Ø©: ${statusName}\n` +
`ğŸ“ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±: 01021102607\n\n` +
`_Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±_`;
}

if (message) {
const whatsappUrl = `https://wa.me/2${item.phone}?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl, '_blank');
}
}

document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('statusChangeModal').style.display = 'none';
alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!" + (sendWhatsApp && item.phone && item.phone.length === 11 ? "\nğŸ“± ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" : ""));
};

document.getElementById('showComplaintsBtn').onclick = () => {
document.getElementById('ordersTableContainer').style.display = 'none';
document.getElementById('complaintsTableContainer').style.display = 'block';
document.getElementById('adminLogsTableContainer').style.display = 'none';
loadComplaints();
};

// Complaint Reply Modal Handler
document.getElementById('confirmComplaintReplyBtn').onclick = async () => {
if (!window.currentComplaintReply) return;

const { item, id } = window.currentComplaintReply;
const reply = document.getElementById('complaintReplyText').value.trim();
const sendWhatsApp = document.getElementById('sendWhatsAppReply').checked;

if (!reply) {
alert("âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø±Ø¯");
return;
}

document.getElementById('loadingSpinner').style.display = 'block';

await updateDoc(doc(window.firebaseDb, "complaints", id), {
reply: reply,
status: 'replied',
repliedAt: Date.now()
});

// Log complaint reply action
await logAdminAction(currentUsername, 'Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø´ÙƒÙˆÙ‰', `ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø´ÙƒÙˆÙ‰ Ù…Ù† Ù†ÙˆØ¹: ${item.type} Ù„Ù„Ù…ÙˆØ§Ø·Ù†: ${item.ownerName}`);

// Send WhatsApp notification if checkbox is checked
if (sendWhatsApp && item.phone && item.phone.length === 11) {
const message = `âœ… *ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø´ÙƒÙˆØ§Ùƒ!*\n\n` +
`ğŸ‘¤ Ø§Ù„Ø³ÙŠØ¯/Ø©: ${item.ownerName}\n` +
`ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰: ${item.type}\n\n` +
`ğŸ’¬ *Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:*\n${reply}\n\n` +
`ğŸ“ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±: 01021102607\n\n` +
`_Ø±Ø¦Ø§Ø³Ø© Ù…Ø±ÙƒØ² ÙˆÙ…Ø¯ÙŠÙ†Ø© ÙƒÙØ± ØµÙ‚Ø±_`;

const whatsappUrl = `https://wa.me/2${item.phone}?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl, '_blank');
}

document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('complaintReplyModal').style.display = 'none';
alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!" + (sendWhatsApp && item.phone && item.phone.length === 11 ? "\nğŸ“± ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯" : ""));
};

document.getElementById('showAdminLogsBtn').onclick = () => {
document.getElementById('ordersTableContainer').style.display = 'none';
document.getElementById('complaintsTableContainer').style.display = 'none';
document.getElementById('adminLogsTableContainer').style.display = 'block';
loadAdminLogs();
};

// Filter functions for stat cards
function showAllOrders() {
document.getElementById('ordersTableContainer').style.display = 'block';
document.getElementById('complaintsTableContainer').style.display = 'none';
document.getElementById('filterStatus').style.display = 'none';
showAllOrdersInTable();
}

function showAllOrdersInTable() {
document.querySelectorAll('#dataTable tr').forEach(row => {
row.style.display = '';
});
}

function showCodedOrders() {
document.getElementById('ordersTableContainer').style.display = 'block';
document.getElementById('complaintsTableContainer').style.display = 'none';
document.getElementById('filterStatus').style.display = 'block';
document.getElementById('filterStatusText').innerText = 'âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…ÙƒÙˆØ¯Ø© ÙÙ‚Ø·';
let count = 0;
document.querySelectorAll('#dataTable tr').forEach(row => {
const codeCell = row.cells[6]; // Column index for code
if (codeCell && codeCell.innerText.includes('â³')) {
row.style.display = 'none';
} else {
row.style.display = '';
count++;
}
});
document.getElementById('filterStatusText').innerText = `âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…ÙƒÙˆØ¯Ø© ÙÙ‚Ø· (${count} Ù…Ø±ÙƒØ¨Ø©)`;
}

function showPendingOrders() {
document.getElementById('ordersTableContainer').style.display = 'block';
document.getElementById('complaintsTableContainer').style.display = 'none';
document.getElementById('filterStatus').style.display = 'block';
document.getElementById('filterStatusText').innerText = 'â³ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙÙ‚Ø·';
let count = 0;
document.querySelectorAll('#dataTable tr').forEach(row => {
const codeCell = row.cells[6]; // Column index for code
if (codeCell && codeCell.innerText.includes('â³')) {
row.style.display = '';
count++;
} else {
row.style.display = 'none';
}
});
document.getElementById('filterStatusText').innerText = `â³ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙÙ‚Ø· (${count} Ù…Ø±ÙƒØ¨Ø©)`;
}

function showComplaintsTable() {
document.getElementById('ordersTableContainer').style.display = 'none';
document.getElementById('complaintsTableContainer').style.display = 'block';
document.getElementById('filterStatus').style.display = 'none';
loadComplaints();
}

// Make functions global
window.showAllOrders = showAllOrders;
window.showCodedOrders = showCodedOrders;
window.showPendingOrders = showPendingOrders;
window.showComplaintsTable = showComplaintsTable;

// Show Activity Log
function showActivityLog(item) {
const modal = document.getElementById('activityLogModal');
const content = document.getElementById('activityLogContent');
const history = item.statusHistory || [];

let html = `
<div style="background: linear-gradient(135deg, rgba(52, 73, 94, 0.1) 0%, rgba(44, 62, 80, 0.1) 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #34495e;">
<h4 style="color: #34495e; margin: 0 0 10px 0;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨:</h4>
<p style="margin: 5px 0;"><strong>Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> ${item.owner}</p>
<p style="margin: 5px 0;"><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ:</strong> ${item.refNumber || 'N/A'}</p>
<p style="margin: 5px 0;"><strong>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</strong> ${item.vType}</p>
</div>
`;

if (history.length === 0) {
html += '<p style="text-align: center; color: #999; padding: 40px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª</p>';
} else {
html += '<div style="position: relative; padding-right: 30px;">';
history.forEach((log, index) => {
const statusInfo = window.getStatusDisplay(log.status);
const isLast = index === history.length - 1;
html += `
<div style="position: relative; margin-bottom: 25px;">
<div style="position: absolute; right: -30px; top: 0; width: 20px; height: 20px; background: ${statusInfo.color}; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
${!isLast ? '<div style="position: absolute; right: -21px; top: 20px; width: 2px; height: calc(100% + 25px); background: #ddd;"></div>' : ''}
<div style="background: white; padding: 20px; border-radius: 15px; border: 2px solid ${statusInfo.color}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<span style="background: ${statusInfo.color}; color: white; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 0.9rem;">${statusInfo.icon} ${statusInfo.text}</span>
<span style="color: #999; font-size: 0.85rem;">${window.formatDateTime(log.timestamp)}</span>
</div>
${log.note ? `<p style="margin: 10px 0 0 0; color: #555; line-height: 1.6;">${log.note}</p>` : ''}
${log.by ? `<p style="margin: 10px 0 0 0; color: #999; font-size: 0.85rem;">Ø¨ÙˆØ§Ø³Ø·Ø©: ${log.by === 'SUPER' ? 'ğŸ‘‘ Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…' : log.by === 'ADMIN' ? 'ğŸ”§ Ù…Ø´Ø±Ù' : log.by}</p>` : ''}
</div>
</div>
`;
});
html += '</div>';
}

content.innerHTML = html;
modal.style.display = 'block';
}

window.showActivityLog = showActivityLog;

// Date Filter
let dateFilterActive = false;
let filterFromTimestamp = null;
let filterToTimestamp = null;

document.getElementById('dateFilterBtn').onclick = () => {
document.getElementById('dateFilterModal').style.display = 'block';
};

document.getElementById('applyDateFilterBtn').onclick = () => {
const fromDate = document.getElementById('filterFromDate').value;
const toDate = document.getElementById('filterToDate').value;

if (!fromDate || !toDate) {
alert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† ÙˆØ§Ù„Ù‰");
return;
}

filterFromTimestamp = new Date(fromDate).setHours(0, 0, 0, 0);
filterToTimestamp = new Date(toDate).setHours(23, 59, 59, 999);
dateFilterActive = true;

document.getElementById('dateFilterModal').style.display = 'none';
document.getElementById('filterStatus').style.display = 'block';
document.getElementById('filterStatusText').innerText = `ğŸ“… Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† ${fromDate} Ø¥Ù„Ù‰ ${toDate}`;

applyDateFilter();
};

function clearDateFilter() {
dateFilterActive = false;
filterFromTimestamp = null;
filterToTimestamp = null;
document.getElementById('filterFromDate').value = '';
document.getElementById('filterToDate').value = '';
document.getElementById('dateFilterModal').style.display = 'none';
document.getElementById('filterStatus').style.display = 'none';
showAllOrdersInTable();
}

window.clearDateFilter = clearDateFilter;

function applyDateFilter() {
let count = 0;
document.querySelectorAll('#dataTable tr').forEach(row => {
const timestampCell = row.cells[5]; // Date column
if (timestampCell) {
const dateText = timestampCell.innerText;
// Try to parse the date - this is approximate
const rowDate = new Date(dateText.split(' ')[0].split('/').reverse().join('-'));
const rowTimestamp = rowDate.getTime();

if (rowTimestamp >= filterFromTimestamp && rowTimestamp <= filterToTimestamp) {
row.style.display = '';
count++;
} else {
row.style.display = 'none';
}
}
});
document.getElementById('filterStatusText').innerText = `ğŸ“… Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (${count} Ø·Ù„Ø¨)`;
}

// Load Admin Logs
function loadAdminLogs() {
onSnapshot(query(adminLogsRef, orderBy("timestamp", "desc")), (snap) => {
const tableBody = document.getElementById('adminLogsTableBody');
tableBody.innerHTML = '';

if (snap.empty) {
tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
return;
}

snap.forEach(s => {
const item = s.data();
const roleIcon = item.role === 'SUPER' ? 'ğŸ‘‘' : item.role === 'ADMIN' ? 'ğŸ”§' : 'ğŸ‘ï¸';
const roleText = item.role === 'SUPER' ? 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…' : item.role === 'ADMIN' ? 'Ù…Ø´Ø±Ù' : 'Ø¹Ø±Ø¶ ÙÙ‚Ø·';

const tr = document.createElement('tr');
tr.innerHTML = `
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:bold;">
<span style="background: ${item.role === 'SUPER' ? '#e74c3c' : item.role === 'ADMIN' ? '#3498db' : '#95a5a6'}; color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.9rem;">
${roleIcon} ${item.username}
</span>
<br><small style="color: #999; font-size: 0.85rem;">${roleText}</small>
</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:600; color: var(--primary);">${item.action}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); color: #555;">${item.details}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-size:0.9rem; color:#666;">${window.formatDateTime(item.timestamp)}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-family: monospace; color: #999;">${item.ipAddress || 'N/A'}</td>
`;
tableBody.appendChild(tr);
});
});
}

// Advanced Search System
let allOrdersData = []; // Store all orders for search

window.searchOrders = function() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
const searchType = document.getElementById('searchType').value;
const rows = document.querySelectorAll('#dataTable tr');

if (!searchTerm) {
rows.forEach(row => row.style.display = '');
return;
}

rows.forEach(row => {
const cells = row.querySelectorAll('td');
if (cells.length === 0) return;

let shouldShow = false;

if (searchType === 'all') {
// Search in all columns
const text = row.innerText.toLowerCase();
shouldShow = text.includes(searchTerm);
} else if (searchType === 'name') {
// Column 0: Ø§Ù„Ù…Ø§Ù„Ùƒ
shouldShow = cells[0]?.innerText.toLowerCase().includes(searchTerm);
} else if (searchType === 'code') {
// Column 9: Ø§Ù„ÙƒÙˆØ¯
shouldShow = cells[9]?.innerText.toLowerCase().includes(searchTerm);
} else if (searchType === 'nationalId') {
// Column 1: Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ
shouldShow = cells[1]?.innerText.toLowerCase().includes(searchTerm);
} else if (searchType === 'phone') {
// Column 2: Ø§Ù„Ù‡Ø§ØªÙ
shouldShow = cells[2]?.innerText.toLowerCase().includes(searchTerm);
} else if (searchType === 'chassis') {
// Column 5: Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡
shouldShow = cells[5]?.innerText.toLowerCase().includes(searchTerm);
} else if (searchType === 'motor') {
// Column 6: Ø§Ù„Ù…ÙˆØªÙˆØ±
shouldShow = cells[6]?.innerText.toLowerCase().includes(searchTerm);
}

row.style.display = shouldShow ? '' : 'none';
});
};

// Export Excel
document.getElementById('exportExcelBtn').onclick = () => {
const wb = XLSX.utils.table_to_book(document.getElementById("excelTable"));
XLSX.writeFile(wb, `Ù…Ù†Ø¸ÙˆÙ…Ø©_ÙƒÙØ±_ØµÙ‚Ø±_${new Date().toLocaleDateString('ar-EG')}.xlsx`);
alert("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
};

// Make functions and variables global
window.viewImages = viewImages;
window.addDoc = addDoc;
window.getDocs = getDocs;
window.query = query;
window.where = where;

// Bulk Import
document.getElementById('bulkImportBtn').onclick = () => {
document.getElementById('bulkImportModal').style.display = 'block';
};

// Download Template
document.getElementById('downloadTemplateBtn').onclick = () => {
const templateData = [
['Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ', 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©', 'Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³Ù†Ø©', 'Ø§Ù„Ù„ÙˆÙ†', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©'],
['Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø­Ø³Ù†', '29501011234567', '01012345678', 'ØªÙˆÙƒØªÙˆÙƒ', '2020', 'Ø£Ø­Ù…Ø±', 'ÙƒÙØ± ØµÙ‚Ø± - Ø­ÙŠ Ø§Ù„Ù†ØµØ±', ''],
['ÙØ§Ø·Ù…Ø© Ù…Ø­Ù…ÙˆØ¯ Ø³Ø¹ÙŠØ¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', '29601021234568', '01098765432', 'Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„', '2021', 'Ø£Ø³ÙˆØ¯', 'Ø§Ù„Ø¨ÙˆÙ‡Ø§ - Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¬Ù„Ø§Ø¡', '']
];

const ws = XLSX.utils.aoa_to_sheet(templateData);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
XLSX.writeFile(wb, 'Ù†Ù…ÙˆØ°Ø¬_Ø§Ø³ØªÙŠØ±Ø§Ø¯_Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª.xlsx');
};

let importedData = [];

// Read Excel File
document.getElementById('bulkImportFile').onchange = async (e) => {
const file = e.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = (event) => {
try {
const data = new Uint8Array(event.target.result);
const workbook = XLSX.read(data, { type: 'array' });
const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

if (jsonData.length < 2) {
alert('âŒ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª');
return;
}

// Smart Column Detection
const headers = jsonData[0].map(h => String(h).toLowerCase().trim());
const columnMap = {};

const patterns = {
owner: ['Ø§Ø³Ù…', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ù…Ø§Ù„Ùƒ', 'name', 'owner'],
nationalId: ['Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ', 'Ø§Ù„Ù‚ÙˆÙ…ÙŠ', 'Ø¨Ø·Ø§Ù‚Ø©', 'national', 'id'],
phone: ['Ù‡Ø§ØªÙ', 'ØªÙ„ÙŠÙÙˆÙ†', 'Ù…ÙˆØ¨Ø§ÙŠÙ„', 'phone', 'mobile'],
vType: ['Ù†ÙˆØ¹', 'Ø§Ù„Ù…Ø±ÙƒØ¨Ø©', 'type', 'vehicle'],
vYear: ['Ù…ÙˆØ¯ÙŠÙ„', 'Ø³Ù†Ø©', 'year', 'model'],
vColor: ['Ù„ÙˆÙ†', 'color'],
address: ['Ø¹Ù†ÙˆØ§Ù†', 'address', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'],
vCode: ['ÙƒÙˆØ¯', 'code', 'Ø§Ù„ÙƒÙˆØ¯']
};

// Match columns automatically
for (let i = 0; i < headers.length; i++) {
const header = headers[i];
for (const [key, keywords] of Object.entries(patterns)) {
if (keywords.some(kw => header.includes(kw))) {
columnMap[key] = i;
break;
}
}
}

// Check required columns
if (columnMap.owner === undefined || columnMap.nationalId === undefined) {
alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ)\nØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù');
return;
}

importedData = [];
const preview = document.getElementById('importPreview');
let previewHTML = `<h4 style="color: #8e44ad; margin-top: 0;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© (${jsonData.length - 1} Ø³Ø¬Ù„):</h4>
<p style="color: #666; margin-bottom: 15px;">âœ… ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: ${Object.keys(columnMap).join(', ')}</p>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #8e44ad; color: white;">
<th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø§Ø³Ù…</th>
<th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
<th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ù‡Ø§ØªÙ</th>
<th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ù†ÙˆØ¹</th>
<th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
</tr>
</thead>
<tbody>`;

for (let i = 1; i < jsonData.length; i++) {
const row = jsonData[i];
if (!row[columnMap.owner] || !row[columnMap.nationalId]) continue;

const record = {
owner: String(row[columnMap.owner] || '').trim(),
nationalId: String(row[columnMap.nationalId] || '').replace(/[^0-9]/g, ''),
phone: String(row[columnMap.phone] || '').replace(/[^0-9]/g, ''),
vType: row[columnMap.vType] || 'ØªÙˆÙƒØªÙˆÙƒ',
vYear: row[columnMap.vYear] || new Date().getFullYear(),
vColor: row[columnMap.vColor] || '',
address: row[columnMap.address] || '',
vCode: row[columnMap.vCode] || ''
};

const isValid = record.owner && record.nationalId.length === 14 && (!record.phone || record.phone.length === 11);
importedData.push(record);

previewHTML += `<tr style="background: ${isValid ? 'rgba(39, 174, 96, 0.1)' : 'rgba(231, 76, 60, 0.1)'};">
<td style="padding: 8px; border: 1px solid #ddd;">${record.owner}</td>
<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${record.nationalId}</td>
<td style="padding: 8px; border: 1px solid #ddd;">${record.phone || '-'}</td>
<td style="padding: 8px; border: 1px solid #ddd;">${record.vType}</td>
<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: ${isValid ? 'var(--secondary)' : 'var(--danger)'};">${isValid ? 'âœ… ØµØ­ÙŠØ­' : 'âŒ Ø®Ø·Ø£'}</td>
</tr>`;
}

previewHTML += '</tbody></table>';
preview.innerHTML = previewHTML;
preview.style.display = 'block';

alert(`âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© ${importedData.length} Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù…Ù„Ù\nğŸ§  ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹`);
} catch (error) {
alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
console.error(error);
}
};
reader.readAsArrayBuffer(file);
};

// Confirm Import
document.getElementById('confirmImportBtn').onclick = async () => {
if (importedData.length === 0) {
alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
return;
}

if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedData.length} Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\n\nâš ï¸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· (Ù„Ù† ÙŠØªÙ… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©)`)) {
return;
}

// Show progress bar
document.getElementById('importProgress').style.display = 'block';
document.getElementById('confirmImportBtn').disabled = true;

let successCount = 0;
let errorCount = 0;
let duplicateCount = 0;
const errors = [];

try {
// Get existing records from Firebase to check duplicates
const existingSnap = await getDocs(window.dbRef);
const existingNIDs = new Set();
const existingRefs = new Set();
existingSnap.forEach(doc => {
const data = doc.data();
if (data.nationalId) existingNIDs.add(data.nationalId);
if (data.refNumber) existingRefs.add(data.refNumber);
});

// Get existing records from LocalStorage to check duplicates
const localKeys = Object.keys(localStorage);
localKeys.forEach(key => {
if (key.startsWith('order_')) {
try {
const localItem = JSON.parse(localStorage.getItem(key));
if (localItem.nationalId) existingNIDs.add(localItem.nationalId);
if (localItem.phone) existingRefs.add(localItem.phone);
} catch (e) {
console.error('Error parsing localStorage item:', key, e);
}
}
});

const codeInfo = await getSmartNextCode();
let nextCode = codeInfo.next;

for (let i = 0; i < importedData.length; i++) {
const record = importedData[i];

// Update progress
const progress = Math.round(((i + 1) / importedData.length) * 100);
document.getElementById('progressBar').style.width = progress + '%';
document.getElementById('progressText').innerText = progress + '%';
document.getElementById('progressStatus').innerText = `Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø¬Ù„ ${i + 1} Ù…Ù† ${importedData.length}...`;

// Validate data
if (!record.owner || !record.nationalId || record.nationalId.length !== 14) {
errorCount++;
errors.push(`Ø§Ù„Ø³Ø¬Ù„ ${i + 1}: Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© (Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ)`);
continue;
}

if (record.phone && record.phone.length !== 11) {
errorCount++;
errors.push(`Ø§Ù„Ø³Ø¬Ù„ ${i + 1}: Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­`);
continue;
}

// Check for duplicates
if (existingNIDs.has(record.nationalId)) {
duplicateCount++;
continue;
}

const finalCode = record.vCode || nextCode.toString();
if (!record.vCode) nextCode++;

const refNumber = 'KS-IMP-' + Date.now().toString().slice(-8) + '-' + i;

await addDoc(window.dbRef, {
owner: record.owner,
nationalId: record.nationalId,
phone: record.phone || '',
vType: record.vType,
vYear: record.vYear,
vDesc: `Ù…ÙˆØ¯ÙŠÙ„ ${record.vYear}`,
address: record.address || '',
chassis: record.chassis || '',
motor: record.motor || '',
images: [],
timestamp: Date.now(),
codedAt: record.vCode ? Date.now() : null,
vCode: finalCode,
refNumber: refNumber,
importedBy: currentUsername,
importedAt: Date.now(),
status: record.vCode ? "coded" : "pending",
statusHistory: [{
status: record.vCode ? "coded" : "pending",
timestamp: Date.now(),
note: record.vCode ? `Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¹ ÙƒÙˆØ¯: ${finalCode}` : "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel",
by: userRole
}]
});

successCount++;
existingNIDs.add(record.nationalId);
}

// Log import action
await logAdminAction(currentUsername, 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel', `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${successCount} Ø³Ø¬Ù„ØŒ ØªØ®Ø·ÙŠ ${duplicateCount} Ù…ÙƒØ±Ø±ØŒ ÙØ´Ù„ ${errorCount} Ø³Ø¬Ù„`);

document.getElementById('importProgress').style.display = 'none';
document.getElementById('bulkImportModal').style.display = 'none';
document.getElementById('confirmImportBtn').disabled = false;

let resultMsg = `âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!\n\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\nâœ… Ù†Ø¬Ø­: ${successCount} Ø³Ø¬Ù„\nâš ï¸ Ù…ÙƒØ±Ø± (ØªÙ… ØªØ®Ø·ÙŠÙ‡): ${duplicateCount} Ø³Ø¬Ù„\nâŒ ÙØ´Ù„: ${errorCount} Ø³Ø¬Ù„\n\nğŸ“ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${importedData.length}`;
if (errors.length > 0 && errors.length <= 5) {
resultMsg += '\n\nâŒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:\n' + errors.slice(0, 5).join('\n');
if (errors.length > 5) {
resultMsg += `\n... Ùˆ ${errors.length - 5} Ø£Ø®Ø·Ø§Ø¡ Ø£Ø®Ø±Ù‰`;
}
}
alert(resultMsg);
location.reload();

} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + error.message);
}
};
</script>

</body>
</html>
