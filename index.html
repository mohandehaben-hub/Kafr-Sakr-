<!DOCTYPE html>
<!--
═══════════════════════════════════════════════════════════════
  منظومة تكويد المركبات - رئاسة مركز ومدينة كفر صقر
═══════════════════════════════════════════════════════════════
  🔒 نظام آمن - Supabase Authentication
  ✅ آمن 100% للرفع على GitHub
  ✅ Row Level Security (RLS) مُفعّل
  
  م/ مهند التهامي - 01021102607
═══════════════════════════════════════════════════════════════
-->
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>منظومة تكويد المركبات - كفر صقر</title>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">

<style>
/* ═══════════════════════════════════════════════════════════════
   CSS Variables
   ═══════════════════════════════════════════════════════════════ */
:root {
--primary: #1a5276;
--secondary: #27ae60;
--accent: #d35400;
--danger: #e74c3c;
--warning: #f39c12;
--info: #3498db;
--bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
--glass-white: rgba(255, 255, 255, 0.85);
--glass-border: rgba(255, 255, 255, 0.5);
--text-dark: #2c3e50;
--shadow-lg: 0 20px 60px rgba(0,0,0,0.3);
}

/* ═══════════════════════════════════════════════════════════════
   Base Styles
   ═══════════════════════════════════════════════════════════════ */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: var(--bg-gradient);
background-attachment: fixed;
direction: rtl;
color: var(--text-dark);
padding-bottom: 100px;
min-height: 100vh;
}

/* ═══════════════════════════════════════════════════════════════
   Header
   ═══════════════════════════════════════════════════════════════ */
header {
background: linear-gradient(135deg, rgba(26, 82, 118, 0.98) 0%, rgba(21, 67, 96, 0.98) 100%);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
color: white;
padding: 8px 3%;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: var(--shadow-lg);
border-bottom: 3px solid rgba(255, 255, 255, 0.3);
position: sticky;
top: 0;
z-index: 1000;
animation: slideDown 0.5s ease;
}

.header-title h1 {
font-size: 1.1rem;
margin: 0;
line-height: 1.3;
}

.header-title small {
font-size: 0.75rem;
opacity: 0.9;
}

@keyframes slideDown {
from { transform: translateY(-100%); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeIn {
from { opacity: 0; transform: scale(0.9); }
to { opacity: 1; transform: scale(1); }
}

@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

.header-title h1 {
margin: 0;
font-size: 1.4rem;
text-shadow: 0 3px 6px rgba(0,0,0,0.3);
}

.header-title small {
color: #f1c40f;
font-size: 0.85rem;
display: block;
margin-top: 5px;
}

/* ═══════════════════════════════════════════════════════════════
   Container & Cards
   ═══════════════════════════════════════════════════════════════ */
.container {
max-width: 1400px;
margin: 30px auto;
padding: 0 20px;
}

.card {
background: var(--glass-white);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
padding: 40px;
border-radius: 30px;
border: 2px solid var(--glass-border);
box-shadow: var(--shadow-lg);
animation: fadeIn 0.6s ease;
margin-bottom: 30px;
margin-top: 20px;
}

/* ═══════════════════════════════════════════════════════════════
   Portal Boxes
   ═══════════════════════════════════════════════════════════════ */
.portal-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 30px;
margin-top: 50px;
padding: 0 10px;
}

.portal-box {
background: var(--glass-white);
backdrop-filter: blur(20px);
padding: 50px 30px;
border-radius: 30px;
text-align: center;
cursor: pointer;
border: 3px solid transparent;
transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
box-shadow: 0 15px 40px rgba(0,0,0,0.15);
position: relative;
overflow: hidden;
min-height: 320px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}

.portal-box::before {
content: '';
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
transform: scale(0);
transition: transform 0.6s ease;
}

.portal-box:hover::before {
transform: scale(1);
}

.portal-box:hover {
transform: translateY(-15px) scale(1.05);
box-shadow: 0 30px 70px rgba(0,0,0,0.25);
}

.portal-box i {
font-size: 90px;
display: block;
margin-bottom: 25px;
animation: pulse 2s infinite;
filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
}

.portal-box h2 {
margin: 15px 0;
font-size: 1.6rem;
font-weight: 900;
text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.portal-box p {
color: #666;
font-size: 1rem;
line-height: 1.8;
margin: 15px 0 0 0;
font-weight: 500;
}

/* ═══════════════════════════════════════════════════════════════
   Forms
   ═══════════════════════════════════════════════════════════════ */
.form-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 25px;
}

.input-group {
display: flex;
flex-direction: column;
margin-bottom: 20px;
position: relative;
}

.input-group label {
margin-bottom: 12px;
font-weight: 700;
color: var(--primary);
font-size: 1rem;
display: flex;
align-items: center;
gap: 8px;
}

.input-group label::before {
content: '●';
color: var(--accent);
font-size: 0.8rem;
}

.input-group input,
.input-group select,
.input-group textarea {
padding: 16px;
border: 2px solid var(--glass-border);
border-radius: 15px;
background: rgba(255, 255, 255, 0.95);
font-size: 1.05rem;
transition: all 0.3s;
font-family: inherit;
font-weight: 500;
}

.input-group input:focus,
.input-group select:focus,
.input-group textarea:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 5px rgba(26, 82, 118, 0.15);
transform: translateY(-2px);
}

/* ═══════════════════════════════════════════════════════════════
   Buttons
   ═══════════════════════════════════════════════════════════════ */
.btn {
cursor: pointer;
border: none;
padding: 14px 24px;
border-radius: 16px;
font-weight: 700;
transition: all 0.4s ease;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 10px;
box-shadow: 0 6px 20px rgba(0,0,0,0.15);
font-size: 1rem;
position: relative;
overflow: hidden;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.btn::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
background: rgba(255,255,255,0.3);
border-radius: 50%;
transition: width 0.6s, height 0.6s;
transform: translate(-50%, -50%);
}

.btn:hover::before {
width: 300px;
height: 300px;
}

.btn:hover {
transform: translateY(-3px);
box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}

.btn-primary {
background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%);
color: white;
}

/* ═══════════════════════════════════════════════════════════════
   Loading Spinner
   ═══════════════════════════════════════════════════════════════ */
.loading {
display: none;
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
z-index: 20000;
}

.spinner {
border: 8px solid rgba(255,255,255,0.3);
border-top: 8px solid var(--primary);
border-radius: 50%;
width: 80px;
height: 80px;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* ═══════════════════════════════════════════════════════════════
   Footer
   ═══════════════════════════════════════════════════════════════ */
.engineer-footer {
background: linear-gradient(135deg, rgba(28, 40, 51, 0.98) 0%, rgba(44, 62, 80, 0.98) 100%);
backdrop-filter: blur(15px);
color: #ecf0f1;
text-align: center;
padding: 18px;
position: fixed;
bottom: 0;
width: 100%;
font-size: 0.95rem;
border-top: 4px solid var(--accent);
z-index: 999;
box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
font-weight: 600;
letter-spacing: 0.5px;
}

/* ═══════════════════════════════════════════════════════════════
   Responsive
   ═══════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
/* Header Mobile Optimization */
header {
padding: 4px 8px !important;
min-height: auto !important;
}

header > div {
gap: 4px !important;
}

header img {
width: 22px !important;
height: 22px !important;
padding: 2px !important;
}

.header-title {
min-width: 0 !important;
flex: 1 !important;
}

.header-title h1 {
font-size: 0.65rem !important;
margin: 0 !important;
line-height: 1.1 !important;
}

.header-title small {
font-size: 0.5rem !important;
display: block;
}

header button {
padding: 4px 6px !important;
font-size: 0.6rem !important;
white-space: nowrap;
min-width: auto !important;
}

/* Portal Section Mobile */
.portal-container {
grid-template-columns: 1fr;
gap: 12px;
padding: 0 8px;
}

.portal-box {
padding: 15px 12px;
min-height: 140px;
}

.portal-box i {
font-size: 40px !important;
}

.portal-box h2 {
font-size: 0.9rem !important;
margin: 8px 0 !important;
}

.portal-box p {
font-size: 0.75rem !important;
line-height: 1.3 !important;
}

/* Form Grid Mobile */
.form-grid {
grid-template-columns: 1fr;
gap: 10px;
}

/* Cards Mobile */
.card {
padding: 12px 8px;
margin-bottom: 12px;
}

/* Buttons Mobile */
.btn {
padding: 8px 12px !important;
font-size: 0.75rem !important;
white-space: nowrap;
}

/* Control Buttons - Stack vertically on mobile */
#adminPanel > div:nth-of-type(2) {
flex-direction: column !important;
gap: 10px !important;
}

#adminPanel > div:nth-of-type(2) > button {
width: 100% !important;
justify-content: center !important;
}

/* Search container - Stack vertically */
#adminPanel > div:nth-of-type(2) > div {
width: 100% !important;
flex-direction: column !important;
}

#searchType, #searchInput {
width: 100% !important;
}

/* Container Mobile */
.container {
padding: 8px !important;
}

/* Headings Mobile */
h2 {
font-size: 1rem !important;
margin: 10px 0 !important;
}

/* Input Fields Mobile */
.input-group input,
.input-group select,
.input-group textarea {
padding: 8px !important;
font-size: 0.8rem !important;
}

.input-group label {
font-size: 0.75rem !important;
}

/* Stats Cards Mobile - Smaller */
.stat-card {
padding: 6px !important;
border-radius: 10px !important;
}

.stat-card h3 {
font-size: 1rem !important;
margin: 3px 0 !important;
}

.stat-card p {
font-size: 0.6rem !important;
margin: 0 !important;
}

.stat-card small {
font-size: 0.6rem !important;
display: none !important; /* Hide "اضغط للعرض" on mobile */
}

/* Make stats grid 2 columns on mobile (compact) */
#adminPanel > div:first-of-type {
grid-template-columns: 1fr 1fr !important;
gap: 6px !important;
margin-bottom: 12px !important;
}

/* Search Mobile */
#searchInput {
padding: 8px !important;
font-size: 0.8rem !important;
}

#searchType {
padding: 6px !important;
font-size: 0.75rem !important;
min-width: 80px !important;
}

/* Table Mobile - Hide non-essential columns */
.table-container {
overflow-x: auto !important;
-webkit-overflow-scrolling: touch;
width: 100% !important;
}

table {
font-size: 0.65rem !important;
width: 100% !important;
}

table th {
padding: 6px 4px !important;
font-size: 0.65rem !important;
background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%) !important;
color: white !important;
font-weight: 600 !important;
}

table td {
padding: 6px 4px !important;
font-size: 0.65rem !important;
}

/* Hide non-essential columns on mobile by default */
table th:nth-child(4),  /* Type */
table td:nth-child(4),
table th:nth-child(5),  /* Year */
table td:nth-child(5),
table th:nth-child(6),  /* Chassis */
table td:nth-child(6),
table th:nth-child(7),  /* Motor */
table td:nth-child(7),
table th:nth-child(9),  /* Date */
table td:nth-child(9),
table th:nth-child(11), /* Images */
table td:nth-child(11),
table th:nth-child(12), /* Actions */
table td:nth-child(12) {
display: none !important;
}

/* Show hidden columns when toggle is active */
table.show-all-columns th,
table.show-all-columns td {
display: table-cell !important;
}
}

table td {
padding: 3px 2px !important;
font-size: 0.6rem !important;
white-space: nowrap;
}

table td button {
padding: 4px 6px !important;
font-size: 0.65rem !important;
}

/* Action Buttons in Table */
table td:last-child {
display: flex !important;
gap: 2px !important;
flex-wrap: nowrap !important;
}

/* Make buttons stack on mobile for control panel */
.card > div:first-child {
flex-direction: column !important;
gap: 6px !important;
}

.card > div:first-child > div {
width: 100% !important;
flex-direction: column !important;
gap: 6px !important;
}

.card > div:first-child button {
width: 100% !important;
}

/* Pagination Mobile */
#paginationControls {
flex-direction: column !important;
gap: 8px !important;
align-items: stretch !important;
}

#paginationControls > div {
width: 100% !important;
justify-content: center !important;
}

#paginationControls button {
padding: 6px 10px !important;
font-size: 0.7rem !important;
}

#paginationControls select {
padding: 6px !important;
font-size: 0.7rem !important;
}

/* Modal Mobile */
.modal-content {
width: 95% !important;
max-width: 95% !important;
margin: 5% auto !important;
padding: 15px !important;
}

.modal-content h3 {
font-size: 1rem !important;
}

.modal-content button {
padding: 8px 12px !important;
font-size: 0.75rem !important;
}

/* Welcome Text Mobile */
#portalSection h2 {
font-size: 1.3rem !important;
margin-top: 20px !important;
margin-bottom: 10px !important;
}

#portalSection p {
font-size: 0.85rem !important;
margin-bottom: 20px !important;
}

/* Table Responsive Styles */
table {
font-size: 0.85rem;
}

table th, table td {
white-space: nowrap;
}

@media (max-width: 1024px) {
table {
font-size: 0.7rem;
}
table th {
padding: 5px 3px !important;
font-size: 0.7rem !important;
}
table td {
padding: 4px 2px !important;
font-size: 0.65rem !important;
}
}

/* ═══════════════════════════════════════════════════════════════
   Vehicle Cards
   ═══════════════════════════════════════════════════════════════ */
.vehicle-card {
background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
backdrop-filter: blur(10px);
padding: 30px 20px;
border-radius: 20px;
text-align: center;
cursor: pointer;
border: 3px solid transparent;
transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
box-shadow: 0 8px 25px rgba(0,0,0,0.1);
position: relative;
overflow: hidden;
}

.vehicle-card::before {
content: '';
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(26, 82, 118, 0.1) 0%, transparent 70%);
transform: scale(0);
transition: transform 0.5s ease;
}

.vehicle-card:hover::before {
transform: scale(1);
}

.vehicle-card:hover {
transform: translateY(-10px) scale(1.05);
border-color: var(--primary);
box-shadow: 0 20px 50px rgba(26, 82, 118, 0.3);
}

.vehicle-card.selected {
border-color: var(--secondary);
background: linear-gradient(135deg, rgba(39, 174, 96, 0.15) 0%, rgba(46, 204, 113, 0.15) 100%);
box-shadow: 0 15px 40px rgba(39, 174, 96, 0.4);
transform: scale(1.05);
}

.vehicle-card.selected::after {
content: '✓';
position: absolute;
top: 10px;
right: 10px;
width: 35px;
height: 35px;
background: var(--secondary);
color: white;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.3rem;
font-weight: bold;
box-shadow: 0 4px 15px rgba(39, 174, 96, 0.5);
}
</style>
</head>
<body>

<!-- Loading Spinner -->
<div class="loading" id="loadingSpinner">
<div class="spinner"></div>
</div>

<!-- Header -->
<header>
<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; width: 100%;">
<div style="display: flex; align-items: center; gap: 6px;">
<img src="https://i.postimg.cc/Hs92TtbL/41jjsn4SHDL-AC-UF894-1000-QL80.jpg" 
style="width: 35px; height: 35px; object-fit: contain; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); background: white; padding: 3px; border: 1px solid rgba(255,255,255,0.5);" 
alt="علم مصر">
<img src="https://i.postimg.cc/brFBgHg7/Flag-of-Sharkiya-Governorate.png" 
style="width: 35px; height: 35px; object-fit: contain; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); background: white; padding: 3px; border: 1px solid rgba(255,255,255,0.5);" 
alt="علم الشرقية">
</div>
<div class="header-title" style="flex: 1; min-width: 150px;">
<h1 style="font-size: 0.9rem; margin: 0; line-height: 1.2;">🏛️ رئاسة مركز كفر صقر</h1>
<small style="font-size: 0.65rem; opacity: 0.85;">د/ أحمد المقدم</small>
</div>
<div style="display:flex; gap:6px; flex-wrap: wrap;">
<button id="goPortalBtn" class="btn" style="background: rgba(255,255,255,0.15); color: white; display:none; padding: 6px 10px; font-size: 0.75rem;" onclick="location.reload()">🏠 البوابة</button>
<button id="logoutBtn" class="btn" style="background: rgba(255,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.4); display:none; cursor:pointer; padding: 6px 10px; font-size: 0.75rem;" onclick="logoutAdmin()">🚪 خروج</button>
<button id="loginBtn" class="btn" style="background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.4); padding: 6px 10px; font-size: 0.75rem;">🔐 التحكم</button>
</div>
</div>
</header>

<!-- Egyptian Flag Stripe -->
<div style="height: 8px; background: linear-gradient(90deg, #ce1126 0%, #ce1126 33.33%, #ffffff 33.33%, #ffffff 66.66%, #000000 66.66%, #000000 100%); box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>

<!-- Main Container -->
<div class="container">

<!-- Portal Section -->
<div id="portalSection">
<h2 style="text-align: center; color: white; margin-top: 50px; margin-bottom: 15px; font-size: 2.5rem; text-shadow: 0 4px 10px rgba(0,0,0,0.3);">
أهلاً بك في بوابة الخدمات الرقمية المتطورة
</h2>
<p style="text-align: center; color: rgba(255,255,255,0.9); margin-bottom: 50px; font-size: 1.2rem; text-shadow: 0 2px 5px rgba(0,0,0,0.2);">
يرجى اختيار القسم الذي ترغب في الدخول إليه
</p>

<div class="portal-container">
<!-- Vehicle Coding Portal -->
<div class="portal-box" onclick="openService('citizenPage')" style="border-bottom: 6px solid var(--primary);">
<i style="font-style: normal; font-size: 85px;">🚜</i>
<h2 style="color: var(--primary);">قسم تكويد المركبات</h2>
<p>تسجيل بيانات التوكتوك والموتوسيكل والتروسيكل والميكروباص بالمنظومة الذكية</p>
</div>

<!-- Inquiry Portal -->
<div class="portal-box" onclick="openService('inquiryPage')" style="border-bottom: 6px solid var(--secondary);">
<i style="font-style: normal; font-size: 85px;">🔍</i>
<h2 style="color: var(--secondary);">استعلام عن حالة الطلب</h2>
<p>تحقق من حالة طلبك ومعرفة الكود الخاص بمركبتك</p>
</div>

<!-- Complaints Portal -->
<div class="portal-box" onclick="openService('complaintsPage')" style="border-bottom: 6px solid var(--accent);">
<i style="font-style: normal; font-size: 85px;">⚖️</i>
<h2 style="color: var(--accent);">تقديم شكوى</h2>
<p>تقديم الشكاوى والبلاغات مع التوثيق الكامل</p>
</div>

<!-- Complaint Inquiry Portal -->
<div class="portal-box" onclick="openService('complaintInquiryPage')" style="border-bottom: 6px solid var(--warning);">
<i style="font-style: normal; font-size: 85px;">📋</i>
<h2 style="color: var(--warning);">استعلام عن الشكوى</h2>
<p>تابع حالة شكواك واطلع على الرد</p>
</div>
</div>
</div>

<!-- Citizen Page (Vehicle Registration) -->
<div id="citizenPage" style="display:none;">
<div class="card">
<h2 style="text-align: center; color: var(--primary); margin-bottom: 30px; font-size: 2rem;">📝 تسجيل مركبة جديدة</h2>

<!-- Vehicle Type Selection -->
<div id="vehicleTypeSelection" style="margin-bottom: 40px;">
<h3 style="text-align: center; color: var(--primary); margin-bottom: 30px; font-size: 1.4rem;">اختر نوع المركبة:</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
<div class="vehicle-card" data-type="توكتوك" onclick="selectVehicleType('توكتوك')">
<div style="margin-bottom: 10px;"><img src="https://i.postimg.cc/QtgDfPKv/images-(1).jpg" style="width: 100px; height: 80px; object-fit: contain; border-radius: 10px;"></div>
<h4 style="color: var(--primary); margin: 10px 0; font-size: 1.2rem;">توكتوك</h4>
<p style="color: #666; font-size: 0.9rem;">مركبة ثلاثية العجلات</p>
</div>
<div class="vehicle-card" data-type="موتوسيكل" onclick="selectVehicleType('موتوسيكل')">
<div style="margin-bottom: 10px;"><img src="https://i.postimg.cc/zfKYfM7K/hwjn-4-2.jpg" style="width: 100px; height: 80px; object-fit: contain; border-radius: 10px;"></div>
<h4 style="color: var(--primary); margin: 10px 0; font-size: 1.2rem;">موتوسيكل</h4>
<p style="color: #666; font-size: 0.9rem;">دراجة نارية</p>
</div>
<div class="vehicle-card" data-type="تروسيكل" onclick="selectVehicleType('تروسيكل')">
<div style="margin-bottom: 10px;"><img src="https://i.postimg.cc/HnSfKCYf/images-(2).jpg" style="width: 100px; height: 80px; object-fit: contain; border-radius: 10px;"></div>
<h4 style="color: var(--primary); margin: 10px 0; font-size: 1.2rem;">تروسيكل</h4>
<p style="color: #666; font-size: 0.9rem;">دراجة ثلاثية</p>
</div>
<div class="vehicle-card" data-type="ميكروباص" onclick="selectVehicleType('ميكروباص')">
<div style="margin-bottom: 10px;"><img src="https://i.postimg.cc/HkjpTBFt/images.jpg" style="width: 100px; height: 80px; object-fit: contain; border-radius: 10px;"></div>
<h4 style="color: var(--primary); margin: 10px 0; font-size: 1.2rem;">ميكروباص</h4>
<p style="color: #666; font-size: 0.9rem;">حافلة صغيرة</p>
</div>
</div>
</div>

<!-- Registration Form -->
<div id="registrationForm" style="display:none;">
<div style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%); padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center; border: 2px solid var(--primary);">
<p style="margin: 0; color: var(--primary); font-size: 1.1rem; font-weight: 600;">
نوع المركبة المختار: <span id="selectedVehicleType" style="font-size: 1.3rem; color: var(--secondary);"></span>
</p>
<button onclick="resetVehicleSelection()" class="btn" style="background: rgba(231, 76, 60, 0.1); color: var(--danger); padding: 8px 20px; margin-top: 10px; font-size: 0.9rem;">
🔄 تغيير نوع المركبة
</button>
</div>

<div class="form-grid">
<div class="input-group" style="grid-column: 1 / -1;">
<label>الاسم الرباعي للمالك</label>
<input type="text" id="ownerName" placeholder="أدخل اسم المالك بالكامل كما في البطاقة">
</div>

<div class="input-group">
<label>الرقم القومي (14 رقم)</label>
<input type="text" id="nationalId" maxlength="14" placeholder="مثال: 29501011234567" oninput="validateNationalId(this)">
<div id="nidValidation" style="font-size: 0.85rem; margin-top: 8px; padding: 8px 12px; border-radius: 8px; display: none; font-weight: 600;"></div>
</div>

<div class="input-group">
<label>تاريخ الميلاد (أدخله يدوياً للتحقق)</label>
<small style="color: #666; font-size: 0.85rem; display: block; margin-bottom: 8px; line-height: 1.5;">
⚠️ أدخل تاريخ ميلادك يدوياً للتأكد من صحة الرقم القومي ومنع التكرار
</small>
<input type="date" id="birthDate" onchange="verifyBirthDate()" placeholder="اختر تاريخ ميلادك">
<div id="birthValidation" style="font-size: 0.85rem; margin-top: 8px; padding: 8px 12px; border-radius: 8px; display: none; font-weight: 600;"></div>
</div>

<div class="input-group">
<label>رقم الهاتف (11 رقم)</label>
<input type="tel" id="phone" maxlength="11" placeholder="01XXXXXXXXX">
</div>

<div class="input-group">
<label>نوع المركبة</label>
<input type="text" id="vType" readonly style="background: rgba(39, 174, 96, 0.1); border: 2px solid var(--secondary); font-weight: 700; color: var(--secondary); font-size: 1.1rem; cursor: not-allowed;">
</div>

<div class="input-group">
<label>موديل المركبة (السنة)</label>
<select id="vYear"><option value="">اختر السنة...</option></select>
</div>

<div class="input-group" style="grid-column: 1 / -1;">
<label>العنوان</label>
<input type="text" id="address" placeholder="أدخل العنوان بالتفصيل">
</div>

<div class="input-group" style="grid-column: 1 / -1;">
<label>رفع الصور والمستندات</label>
<input type="file" id="multiFiles" multiple accept="image/*" style="padding: 30px; border: 3px dashed var(--primary);">
<small style="color: #666; margin-top: 10px; display: block;">✓ يمكنك رفع عدة صور</small>
</div>
</div>

<button id="submitBtn" class="btn btn-primary" style="width: 100%; font-size: 1.4rem; margin-top: 35px; padding: 20px;">
إرسال الطلب ✅
</button>
</div>
</div>
</div>

<!-- Inquiry Page -->
<div id="inquiryPage" style="display:none;">
<div class="card" style="border: 3px solid var(--secondary);">
<h2 style="text-align: center; color: var(--secondary); margin-bottom: 40px; font-size: 2rem;">🔍 استعلام عن حالة الطلب</h2>
<p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 1.1rem;">أدخل بياناتك للتحقق من حالة طلبك</p>

<div class="form-grid">
<div class="input-group" style="grid-column: 1 / -1;">
<label>الاسم الرباعي</label>
<input type="text" id="inqOwnerName" placeholder="أدخل اسم المالك بالكامل">
</div>

<div class="input-group">
<label>الرقم القومي (14 رقم)</label>
<input type="text" id="inqNationalId" maxlength="14" placeholder="29501011234567">
</div>

<div class="input-group">
<label>رقم الهاتف (11 رقم)</label>
<input type="tel" id="inqPhone" maxlength="11" placeholder="01XXXXXXXXX">
</div>
</div>

<button id="inquiryBtn" class="btn btn-primary" style="width: 100%; font-size: 1.4rem; margin-top: 35px; padding: 20px;">
🔍 استعلام الآن
</button>

<div id="inquiryResult" style="display:none; margin-top: 40px; padding: 40px; border-radius: 25px; text-align: center;"></div>
</div>
</div>

<!-- Complaints Page -->
<div id="complaintsPage" style="display:none;">
<div class="card" style="border: 3px solid var(--accent);">
<h2 style="text-align: center; color: var(--accent); margin-bottom: 30px; font-size: 2rem;">⚖️ تقديم شكوى</h2>
<p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 1.05rem;">املأ البيانات التالية لتقديم شكوى</p>

<div class="form-grid">
<div class="input-group" style="grid-column: 1 / -1;">
<label>الاسم الرباعي</label>
<input type="text" id="compOwnerName" placeholder="أدخل الاسم الكامل">
</div>

<div class="input-group">
<label>الرقم القومي (14 رقم)</label>
<input type="text" id="compNationalId" maxlength="14" placeholder="29501011234567">
</div>

<div class="input-group">
<label>رقم الهاتف (11 رقم)</label>
<input type="tel" id="compPhone" maxlength="11" placeholder="01XXXXXXXXX">
</div>

<div class="input-group">
<label>نوع الشكوى</label>
<select id="compType">
<option value="">اختر النوع...</option>
<option value="زيادة الأجرة">زيادة الأجرة</option>
<option value="سوء معاملة">سوء معاملة</option>
<option value="قيادة متهورة">قيادة متهورة</option>
<option value="مركبة مخالفة">مركبة مخالفة</option>
<option value="عدم الالتزام بالكود">عدم الالتزام بالكود</option>
<option value="أخرى">أخرى</option>
</select>
</div>

<div class="input-group" style="grid-column: 1 / -1;">
<label>تفاصيل الشكوى</label>
<textarea id="compDetails" rows="5" placeholder="اكتب تفاصيل الشكوى بالكامل..."></textarea>
</div>

<!-- صورة سيلفي -->
<div class="input-group" style="grid-column: 1 / -1;">
<label style="color: var(--accent); font-size: 1.1rem;">📸 صورة سيلفي (إثبات الهوية)</label>
<input type="file" id="compSelfie" accept="image/*" capture="user" style="padding: 20px; border: 3px dashed var(--accent); background: rgba(211, 84, 0, 0.05);">
<small style="color: #666; margin-top: 10px; display: block;">✓ التقط صورة سيلفي واضحة لوجهك</small>
</div>

<!-- صورة البطاقة -->
<div class="input-group" style="grid-column: 1 / -1;">
<label style="color: var(--accent); font-size: 1.1rem;">🪪 صورة البطاقة الشخصية</label>
<input type="file" id="compIdCard" accept="image/*" style="padding: 20px; border: 3px dashed var(--accent); background: rgba(211, 84, 0, 0.05);">
<small style="color: #666; margin-top: 10px; display: block;">✓ صورة واضحة للبطاقة الشخصية (الوجه الأمامي)</small>
</div>

<!-- صورة المشكلة -->
<div class="input-group" style="grid-column: 1 / -1;">
<label style="color: var(--accent); font-size: 1.1rem;">📷 صورة المشكلة</label>
<input type="file" id="compProblemImage" accept="image/*" multiple style="padding: 20px; border: 3px dashed var(--accent); background: rgba(211, 84, 0, 0.05);">
<small style="color: #666; margin-top: 10px; display: block;">✓ صور توضح المشكلة أو الموقف (يمكن رفع أكثر من صورة)</small>
</div>

<!-- صورة لوحة المركبة أو الكود -->
<div class="input-group" style="grid-column: 1 / -1;">
<label style="color: var(--accent); font-size: 1.1rem;">🚜 صورة لوحة المركبة أو الكود</label>
<input type="file" id="compVehicleImage" accept="image/*" style="padding: 20px; border: 3px dashed var(--accent); background: rgba(211, 84, 0, 0.05);">
<small style="color: #666; margin-top: 10px; display: block;">✓ صورة واضحة للوحة المركبة أو كود التكويد</small>
</div>
</div>

<!-- ملخص الصور -->
<div id="compImagesSummary" style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.1) 0%, rgba(186, 74, 0, 0.1) 100%); padding: 20px; border-radius: 15px; margin: 25px 0; border: 2px solid rgba(211, 84, 0, 0.3); display: none;">
<h4 style="color: var(--accent); margin-top: 0;">📋 ملخص الصور المرفوعة:</h4>
<div id="compImagesList" style="display: flex; flex-direction: column; gap: 10px;"></div>
</div>

<button id="submitCompBtn" class="btn" style="width: 100%; background: linear-gradient(135deg, var(--accent) 0%, #ba4a00 100%); color: white; padding: 20px; font-size: 1.3rem; margin-top: 30px;">
إرسال الشكوى ✉️
</button>
</div>
</div>

<!-- Complaint Inquiry Page -->
<div id="complaintInquiryPage" style="display:none;">
<div class="card" style="border: 3px solid var(--warning);">
<h2 style="text-align: center; color: var(--warning); margin-bottom: 40px; font-size: 2rem;">📋 استعلام عن حالة الشكوى</h2>
<p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 1.1rem;">أدخل بياناتك للتحقق من حالة شكواك</p>

<div class="form-grid">
<div class="input-group" style="grid-column: 1 / -1;">
<label>الاسم الرباعي</label>
<input type="text" id="compInqOwnerName" placeholder="أدخل اسم المالك بالكامل">
</div>

<div class="input-group">
<label>الرقم القومي (14 رقم)</label>
<input type="text" id="compInqNationalId" maxlength="14" placeholder="29501011234567">
</div>

<div class="input-group">
<label>رقم الهاتف (11 رقم)</label>
<input type="tel" id="compInqPhone" maxlength="11" placeholder="01XXXXXXXXX">
</div>
</div>

<button id="complaintInquiryBtn" class="btn" style="width: 100%; font-size: 1.4rem; margin-top: 35px; padding: 20px; background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%); color: white;">
📋 استعلام عن الشكوى
</button>

<div id="complaintInquiryResult" style="display:none; margin-top: 40px;"></div>
</div>
</div>

<!-- Admin Page -->
<div id="adminPage" style="display:none;">
<!-- Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; margin-bottom: 35px;">
<div class="stat-card" onclick="showAllOrders()" style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.15) 0%, rgba(52, 152, 219, 0.15) 100%); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid var(--primary); box-shadow: 0 8px 25px rgba(26, 82, 118, 0.2); cursor: pointer; transition: all 0.3s ease;">
<p style="margin: 0; color: var(--primary); font-size: 1rem; font-weight: 600;">📋 إجمالي الطلبات</p>
<h3 id="statTotal" style="margin: 15px 0; font-size: 2.5rem; color: var(--primary); font-weight: bold;">0</h3>
<small style="color: #666; font-size: 0.85rem;">اضغط للعرض</small>
</div>
<div class="stat-card" onclick="showCodedOrders()" style="background: linear-gradient(135deg, rgba(39, 174, 96, 0.15) 0%, rgba(46, 204, 113, 0.15) 100%); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid var(--secondary); box-shadow: 0 8px 25px rgba(39, 174, 96, 0.2); cursor: pointer; transition: all 0.3s ease;">
<p style="margin: 0; color: var(--secondary); font-size: 1rem; font-weight: 600;">✅ تم التكويد</p>
<h3 id="statCoded" style="margin: 15px 0; font-size: 2.5rem; color: var(--secondary); font-weight: bold;">0</h3>
<small style="color: #666; font-size: 0.85rem;">اضغط للعرض</small>
</div>
<div class="stat-card" onclick="showPendingOrders()" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.15) 0%, rgba(214, 137, 16, 0.15) 100%); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid var(--warning); box-shadow: 0 8px 25px rgba(243, 156, 18, 0.2); cursor: pointer; transition: all 0.3s ease;">
<p style="margin: 0; color: var(--warning); font-size: 1rem; font-weight: 600;">⏳ قيد الانتظار</p>
<h3 id="statPending" style="margin: 15px 0; font-size: 2.5rem; color: var(--warning); font-weight: bold;">0</h3>
<small style="color: #666; font-size: 0.85rem;">اضغط للعرض</small>
</div>
<div class="stat-card" onclick="showComplaintsTable()" style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.15) 0%, rgba(186, 74, 0, 0.15) 100%); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid var(--accent); box-shadow: 0 8px 25px rgba(211, 84, 0, 0.2); cursor: pointer; transition: all 0.3s ease;">
<p style="margin: 0; color: var(--accent); font-size: 1rem; font-weight: 600;">⚖️ إجمالي الشكاوى</p>
<h3 id="statCompTotal" style="margin: 15px 0; font-size: 2.5rem; color: var(--accent); font-weight: bold;">0</h3>
<small style="color: #666; font-size: 0.85rem;">اضغط للعرض</small>
</div>
</div>

<style>
.stat-card:hover {
transform: translateY(-8px) scale(1.05);
box-shadow: 0 15px 40px rgba(0,0,0,0.3) !important;
}

.stat-card:active {
transform: translateY(-4px) scale(1.02);
}

.stat-card {
position: relative;
overflow: hidden;
}

.stat-card::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
background: rgba(255, 255, 255, 0.3);
border-radius: 50%;
transform: translate(-50%, -50%);
transition: width 0.6s, height 0.6s;
}

.stat-card:hover::before {
width: 300px;
height: 300px;
}
</style>

<div class="card">
<!-- Control Buttons -->
<div style="display:flex; gap:15px; margin-bottom:35px; flex-wrap: wrap; align-items: center;">
<button id="showOrdersBtn" class="btn" style="background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%); color: white;">🚜 جدول المركبات</button>
<button id="showComplaintsBtn" class="btn" style="background: linear-gradient(135deg, var(--accent) 0%, #ba4a00 100%); color: white;">⚖️ قائمة الشكاوى</button>
<button id="showAdminLogsBtn" class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">📜 سجل المشرفين</button>
<button id="bulkImportBtn" class="btn" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white;">📥 استيراد من Excel</button>
<button id="dateFilterBtn" class="btn" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); color: white;">📅 فلترة بالتاريخ</button>
<button id="toggleColumnsBtn" class="btn" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; display: none;">👁️ إظهار/إخفاء الأعمدة</button>
<div style="flex: 1; display: flex; gap: 10px;">
<select id="searchType" style="padding: 12px; border-radius: 12px; border: 2px solid var(--glass-border); background: rgba(255,255,255,0.95); font-weight: 600; min-width: 150px;">
<option value="all">🔍 الكل</option>
<option value="name">👤 الاسم</option>
<option value="code">🔢 الكود</option>
<option value="nationalId">🆔 الرقم القومي</option>
<option value="phone">📱 الهاتف</option>
<option value="chassis">� الشاسيه</option>
<option value="motor">⚙️ الموتور</option>
</select>
<input type="text" id="searchInput" oninput="window.searchOrders()" style="flex: 1; padding:16px; border-radius:16px; border:2px solid var(--glass-border); background:rgba(255,255,255,0.95); font-weight:600;" placeholder="🔍 ابحث في كل السجلات..." title="البحث يعمل على جميع البيانات المحملة">
</div>
<button id="exportExcelBtn" class="btn" style="background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); color:white;">📊 تصدير Excel</button>
<button onclick="location.reload()" class="btn" style="background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">🚪 خروج</button>
</div>

<!-- Filter Status Message -->
<div id="filterStatus" style="display:none; background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(26, 82, 118, 0.1) 100%); padding: 15px 25px; border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--info); text-align: center;">
<p style="margin: 0; color: var(--info); font-weight: bold; font-size: 1.1rem;">
<span id="filterStatusText">عرض جميع الطلبات</span>
<button onclick="showAllOrders()" style="background: rgba(52, 152, 219, 0.2); border: none; padding: 5px 15px; border-radius: 8px; margin-right: 15px; cursor: pointer; color: var(--info); font-weight: bold;">🔄 إعادة تعيين</button>
</p>
</div>

<!-- Pagination Controls -->
<div id="paginationControls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(142, 68, 173, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%); border-radius: 15px; border: 2px solid #8e44ad;">
<div style="display: flex; gap: 10px; align-items: center;">
<button onclick="window.changePage(-1)" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #3498db 0%, #2874a6 100%); color: white;">⏮️ السابق</button>
<span id="pageInfo" style="font-weight: bold; color: #8e44ad; font-size: 1.1rem;">صفحة 1 من 1</span>
<button onclick="window.changePage(1)" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #3498db 0%, #2874a6 100%); color: white;">التالي ⏭️</button>
</div>
<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
<button id="loadAllDataBtn" onclick="window.loadAllData()" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white; display: none;">📥 تحميل كل البيانات</button>
<label style="font-weight: 600; color: #555;">عدد السجلات في الصفحة:</label>
<select id="recordsPerPage" onchange="window.changeRecordsPerPage()" style="padding: 8px 15px; border-radius: 10px; border: 2px solid #8e44ad; font-weight: 600; background: white;">
<option value="50">50</option>
<option value="100" selected>100</option>
<option value="200">200</option>
<option value="500">500</option>
</select>
<span id="totalRecordsInfo" style="font-weight: bold; color: #27ae60; font-size: 1.1rem;">إجمالي: 0 سجل</span>
<span id="loadingMoreInfo" style="font-weight: 600; color: #e67e22; font-size: 0.9rem; display: none;">⏳ جاري التحميل...</span>
</div>
</div>

<!-- Orders Table -->
<div id="ordersTableContainer" style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
<table id="excelTable" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
<thead>
<tr>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">المالك</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">الرقم القومي</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">الهاتف</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">النوع</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">الموديل</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">الشاسيه</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">الموتور</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">العنوان</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">التاريخ</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">الكود</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">📷 الصور</th>
<th style="background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); color: white; padding: 8px 6px; font-size: 0.85rem; position: sticky; top: 0; z-index: 10;">الإجراءات</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>
</div>

<!-- Complaints Table -->
<div id="complaintsTableContainer" style="overflow-x:auto; display: none;">
<table id="complaintsTable" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
<thead>
<tr>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">الاسم</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">الهاتف</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">نوع الشكوى</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">التفاصيل</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">المرفقات</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">الحالة</th>
<th style="background: linear-gradient(135deg, rgba(211, 84, 0, 0.95) 0%, rgba(186, 74, 0, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">الإجراءات</th>
</tr>
</thead>
<tbody id="compTableBody"></tbody>
</table>
</div>

<!-- Admin Logs Table -->
<div id="adminLogsTableContainer" style="overflow-x:auto; display: none;">
<h3 style="color: #e74c3c; margin-bottom: 25px; text-align: center; font-size: 1.8rem;">📜 سجل عمليات المشرفين</h3>
<table id="adminLogsTable" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
<thead>
<tr>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">المشرف</th>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">العملية</th>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">التفاصيل</th>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">التاريخ والوقت</th>
<th style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%); color: white; padding: 20px; font-size: 1rem;">IP Address</th>
</tr>
</thead>
<tbody id="adminLogsTableBody"></tbody>
</table>
</div>
</div>
</div>

<!-- Modal for Images -->
<div id="imgModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<span onclick="document.getElementById('imgModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: white; font-size: 45px; cursor: pointer; z-index: 10001;">&times;</span>
<img id="mainViewImg" style="max-width:90%; max-height:80vh; display:block; margin:80px auto 30px; border:8px solid white; border-radius:25px;">
<div id="modalThumbnails" style="display: flex; justify-content: center; gap: 15px; padding: 25px; flex-wrap: wrap;"></div>
</div>

<!-- Modal for Coding -->
<div id="codeModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 5% auto; padding: 45px; width: 92%; max-width: 500px; border-radius: 35px; text-align: center; position: relative;">
<span onclick="document.getElementById('codeModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 30px;">🔢 تكويد المركبة</h3>
<p id="codeHint" style="font-size:1.1rem; color:#555; background: rgba(0,0,0,0.06); padding:18px; border-radius:15px; margin: 25px 0; font-weight: 600;"></p>
<div class="input-group">
<label style="justify-content: center;">الكود المخصص للمركبة:</label>
<input type="text" id="manualCodeInput" style="text-align:center; font-size:2.5rem; font-weight:bold; color:var(--secondary); border: 3px solid var(--secondary); height: 80px;">
</div>

<!-- WhatsApp Notification Checkbox -->
<div style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); padding: 20px; border-radius: 15px; margin: 25px 0; border: 2px solid rgba(37, 211, 102, 0.3);">
<label style="display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 1.1rem; color: #16a34a; font-weight: 700;">
<input type="checkbox" id="sendWhatsAppCode" checked style="width: 24px; height: 24px; cursor: pointer; accent-color: #16a34a;">
<span>📱 إرسال إشعار واتساب للمواطن</span>
</label>
<small style="display: block; text-align: center; color: #666; margin-top: 10px; font-size: 0.9rem;">سيتم إرسال الكود ومعلومات الاستلام</small>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmCodeBtn" class="btn btn-primary" style="flex:1; padding:18px; font-size: 1.1rem;">تأكيد الكود ✅</button>
<button onclick="document.getElementById('codeModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">إلغاء ❌</button>
</div>
</div>
</div>

<!-- Modal for Edit -->
<div id="editModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 3% auto; padding: 45px; width: 92%; max-width: 700px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('editModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: var(--warning); font-size: 1.8rem; margin-bottom: 30px; text-align: center;">✏️ تعديل بيانات المركبة</h3>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
<div class="input-group">
<label>الاسم الرباعي للمالك</label>
<input type="text" id="editOwnerName" placeholder="أدخل الاسم الكامل">
</div>

<div class="input-group">
<label>رقم الهاتف (11 رقم)</label>
<input type="tel" id="editPhone" maxlength="11" placeholder="01XXXXXXXXX">
</div>

<div class="input-group">
<label>نوع المركبة</label>
<select id="editVType">
<option value="توكتوك">توكتوك</option>
<option value="موتوسيكل">موتوسيكل</option>
<option value="تروسيكل">تروسيكل</option>
<option value="ميكروباص">ميكروباص</option>
</select>
</div>

<div class="input-group">
<label>موديل السنة</label>
<select id="editVYear"></select>
</div>

<div class="input-group" style="grid-column: 1 / -1;">
<label>العنوان</label>
<textarea id="editAddress" rows="3" placeholder="أدخل العنوان بالتفصيل"></textarea>
</div>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmEditBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); color: white;">حفظ التعديلات ✅</button>
<button onclick="document.getElementById('editModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">إلغاء ❌</button>
</div>
</div>
</div>

<!-- Modal for Bulk Import -->
<div id="bulkImportModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 3% auto; padding: 45px; width: 92%; max-width: 900px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('bulkImportModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: #8e44ad; font-size: 1.8rem; margin-bottom: 30px;">📥 استيراد بيانات جماعي من Excel</h3>

<div style="background: linear-gradient(135deg, rgba(142, 68, 173, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%); padding: 25px; border-radius: 20px; margin: 25px 0; border: 2px solid rgba(142, 68, 173, 0.3);">
<h4 style="color: #8e44ad; margin-top: 0;">📋 تنسيق الملف المطلوب:</h4>
<p style="color: #666; line-height: 1.8; margin: 15px 0;">يدعم النظام طريقتين للاستيراد:</p>

<div style="background: white; padding: 15px; border-radius: 10px; margin: 10px 0;">
<h5 style="color: #8e44ad; margin: 0 0 10px 0;">🧠 الطريقة الأولى: اكتشاف تلقائي (موصى به)</h5>
<p style="color: #555; margin: 0; line-height: 1.6;">ضع أسماء الأعمدة في الصف الأول، وسيقوم النظام باكتشافها تلقائياً</p>
<p style="color: #666; font-size: 0.9rem; margin: 5px 0 0 0;">مثال: "الاسم الرباعي" | "الرقم القومي" | "رقم الهاتف" | "نوع المركبة"</p>
</div>

<div style="background: white; padding: 15px; border-radius: 10px; margin: 10px 0;">
<h5 style="color: #8e44ad; margin: 0 0 10px 0;">📍 الطريقة الثانية: أعمدة ثابتة</h5>
<p style="color: #555; margin: 0 0 10px 0; line-height: 1.6;">استخدم الترتيب التالي للأعمدة:</p>
<ol style="color: #555; line-height: 1.8; font-weight: 600; margin: 0; padding-right: 20px;">
<li><strong>العمود B:</strong> الكود (اختياري)</li>
<li><strong>العمود C:</strong> الاسم الرباعي (إلزامي)</li>
<li><strong>العمود D:</strong> الرقم القومي (14 رقم - إلزامي)</li>
<li><strong>العمود E:</strong> العنوان</li>
<li><strong>العمود F:</strong> رقم الشاسيه</li>
<li><strong>العمود G:</strong> رقم الموتور</li>
<li><strong>العمود H:</strong> رقم التليفون (11 رقم)</li>
</ol>
<p style="color: #e74c3c; font-weight: 600; margin: 10px 0 0 0; font-size: 0.9rem;">
⚠️ الصف الأول (Header) سيتم تجاهله تلقائياً
</p>
</div>

<button id="downloadTemplateBtn" class="btn" style="background: linear-gradient(135deg, var(--info) 0%, #2874a6 100%); color: white; margin-top: 15px;">📄 تحميل ملف نموذجي</button>

<button id="cleanDuplicatesBtn" class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; margin-top: 15px;">🧹 تنظيف السجلات المكررة</button>
</div>

<div class="input-group">
<label style="font-size: 1.1rem; color: #8e44ad;">اختر ملف Excel للاستيراد:</label>
<input type="file" id="bulkImportFile" accept=".xlsx, .xls" style="padding: 20px; border: 3px dashed #8e44ad; background: rgba(142, 68, 173, 0.05); font-weight: 600; border-radius: 15px;">
</div>

<div id="importPreview" style="display:none; margin: 25px 0; max-height: 300px; overflow-y: auto; background: white; padding: 20px; border-radius: 15px; border: 2px solid #ddd;"></div>

<!-- Progress Bar -->
<div id="importProgress" style="display:none; margin: 25px 0;">
<div style="background: #f0f0f0; border-radius: 10px; overflow: hidden; height: 30px; position: relative;">
<div id="progressBar" style="background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
<span id="progressText" style="color: white; font-weight: bold; font-size: 0.9rem; position: absolute; width: 100%; text-align: center; z-index: 1;">0%</span>
</div>
</div>
<p id="progressStatus" style="text-align: center; margin-top: 10px; color: #666; font-weight: 600;">جاري المعالجة...</p>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmImportBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); color: white;">✅ تأكيد الاستيراد</button>
<button onclick="document.getElementById('bulkImportModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">❌ إلغاء</button>
</div>
</div>
</div>

<!-- Modal for Activity Log -->
<div id="activityLogModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 3% auto; padding: 45px; width: 92%; max-width: 800px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('activityLogModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: #34495e; font-size: 1.8rem; margin-bottom: 30px; text-align: center;">📋 سجل العمليات</h3>
<div id="activityLogContent" style="max-height: 500px; overflow-y: auto;"></div>
</div>
</div>

<!-- Modal for Login -->
<div id="loginModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(26, 82, 118, 0.95) 0%, rgba(52, 152, 219, 0.95) 100%); backdrop-filter: blur(20px); overflow-y: auto;">
<div style="background: white; margin: 5% auto; padding: 50px; width: 92%; max-width: 500px; border-radius: 35px; position: relative; box-shadow: 0 25px 80px rgba(0,0,0,0.4);">
<span onclick="document.getElementById('loginModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer; transition: transform 0.3s;" onmouseover="this.style.transform='rotate(90deg)'" onmouseout="this.style.transform='rotate(0deg)'">&times;</span>

<!-- Logos -->
<div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px;">
<img src="https://i.postimg.cc/Hs92TtbL/41jjsn4SHDL-AC-UF894-1000-QL80.jpg" 
style="width: 70px; height: 70px; object-fit: contain; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); background: white; padding: 8px; border: 3px solid rgba(26, 82, 118, 0.3); animation: pulse 2s infinite;" 
alt="علم مصر">
<img src="https://i.postimg.cc/brFBgHg7/Flag-of-Sharkiya-Governorate.png" 
style="width: 70px; height: 70px; object-fit: contain; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); background: white; padding: 8px; border: 3px solid rgba(26, 82, 118, 0.3); animation: pulse 2s infinite;" 
alt="علم الشرقية">
</div>

<!-- Title -->
<h3 style="color: var(--primary); font-size: 2rem; margin-bottom: 15px; text-align: center; font-weight: 900;">🔐 لوحة التحكم</h3>
<p style="text-align: center; color: #666; margin-bottom: 35px; font-size: 1rem;">رئاسة مركز ومدينة كفر صقر</p>

<!-- Egyptian Flag Stripe -->
<div style="height: 6px; background: linear-gradient(90deg, #ce1126 0%, #ce1126 33.33%, #ffffff 33.33%, #ffffff 66.66%, #000000 66.66%, #000000 100%); border-radius: 10px; margin-bottom: 35px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>

<!-- Login Form -->
<div class="input-group">
<label style="font-size: 1.1rem; color: var(--primary); font-weight: 700;">📧 البريد الإلكتروني</label>
<input type="email" id="loginUsername" placeholder="أدخل البريد الإلكتروني" style="padding: 18px; border: 3px solid var(--glass-border); border-radius: 15px; font-size: 1.1rem; font-weight: 600; transition: all 0.3s;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 5px rgba(26, 82, 118, 0.1)'" onblur="this.style.borderColor='var(--glass-border)'; this.style.boxShadow='none'">
</div>

<div class="input-group">
<label style="font-size: 1.1rem; color: var(--primary); font-weight: 700;">🔒 كلمة المرور</label>
<input type="password" id="loginPassword" placeholder="أدخل كلمة المرور" style="padding: 18px; border: 3px solid var(--glass-border); border-radius: 15px; font-size: 1.1rem; font-weight: 600; transition: all 0.3s;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 5px rgba(26, 82, 118, 0.1)'" onblur="this.style.borderColor='var(--glass-border)'; this.style.boxShadow='none'" onkeypress="if(event.key==='Enter')document.getElementById('confirmLoginBtn').click()">
</div>

<!-- Login Credentials Info -->
<div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%); padding: 15px; border-radius: 12px; margin: 20px 0; border: 2px solid rgba(52, 152, 219, 0.3); text-align: center;">
<p style="margin: 0; color: var(--info); font-size: 0.95rem; font-weight: 600; line-height: 1.6;">
🔐 تسجيل الدخول عبر Supabase<br>
<span style="font-size: 0.9rem;">يرجى إدخال بيانات الدخول المسجلة في النظام</span>
</p>
</div>

<!-- Login Button -->
<button id="confirmLoginBtn" class="btn" style="width: 100%; padding: 20px; font-size: 1.3rem; margin-top: 25px; background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%); color: white; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 10px 30px rgba(26, 82, 118, 0.4); position: relative; overflow: hidden; transition: all 0.3s;">
<span style="position: relative; z-index: 1;">دخول 🚀</span>
</button>

<style>
#confirmLoginBtn:hover {
transform: translateY(-3px);
box-shadow: 0 15px 40px rgba(26, 82, 118, 0.5);
}

#confirmLoginBtn:active {
transform: translateY(0);
}

#loginModal {
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}
</style>

<!-- Info Box -->
<div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(26, 82, 118, 0.1) 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 2px solid rgba(52, 152, 219, 0.3);">
<p style="margin: 0; color: #555; font-size: 0.9rem; text-align: center; line-height: 1.8;">
<strong style="color: var(--primary);">ℹ️ ملاحظة:</strong><br>
للدخول كمشرف، استخدم بيانات الاعتماد الخاصة بك
</p>
</div>
</div>
</div>

<!-- Modal for Date Filter -->
<div id="dateFilterModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 10% auto; padding: 45px; width: 92%; max-width: 500px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('dateFilterModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 30px; text-align: center;">📅 فلترة حسب التاريخ</h3>

<div class="input-group">
<label>من تاريخ:</label>
<input type="date" id="filterFromDate" style="padding: 16px; border-radius: 12px; border: 2px solid var(--glass-border); width: 100%;">
</div>

<div class="input-group">
<label>إلى تاريخ:</label>
<input type="date" id="filterToDate" style="padding: 16px; border-radius: 12px; border: 2px solid var(--glass-border); width: 100%;">
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="applyDateFilterBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%); color: white;">✅ تطبيق الفلتر</button>
<button onclick="clearDateFilter()" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%); color: white;">🔄 إعادة تعيين</button>
</div>
</div>
</div>

<!-- Modal for Status Change -->
<div id="statusChangeModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 5% auto; padding: 45px; width: 92%; max-width: 550px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('statusChangeModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: #8e44ad; font-size: 1.8rem; margin-bottom: 30px; text-align: center;">🔄 تغيير حالة الطلب</h3>

<div class="input-group">
<label style="font-size: 1.1rem; color: #8e44ad;">اختر الحالة الجديدة:</label>
<select id="newStatusSelect" style="padding: 18px; border-radius: 12px; border: 3px solid #8e44ad; width: 100%; font-size: 1.1rem; font-weight: 700; color: #8e44ad;">
<option value="pending">⏳ قيد المراجعة</option>
<option value="approved">✓ تم القبول</option>
<option value="coded">✅ تم التكويد</option>
<option value="delivered">🎉 تم التسليم</option>
</select>
</div>

<div class="input-group">
<label style="font-size: 1.1rem; color: #8e44ad;">ملاحظة (اختياري):</label>
<textarea id="statusNote" rows="3" placeholder="أضف ملاحظة..." style="padding: 16px; border-radius: 12px; border: 2px solid var(--glass-border); width: 100%; font-size: 1rem;"></textarea>
</div>

<!-- WhatsApp Notification Checkbox -->
<div style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); padding: 20px; border-radius: 15px; margin: 25px 0; border: 2px solid rgba(37, 211, 102, 0.3);">
<label style="display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 1.1rem; color: #16a34a; font-weight: 700;">
<input type="checkbox" id="sendWhatsAppStatus" checked style="width: 24px; height: 24px; cursor: pointer; accent-color: #16a34a;">
<span>📱 إرسال إشعار واتساب للمواطن</span>
</label>
<small style="display: block; text-align: center; color: #666; margin-top: 10px; font-size: 0.9rem;">سيتم إرسال تحديث الحالة</small>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmStatusChangeBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white;">✅ تأكيد التغيير</button>
<button onclick="document.getElementById('statusChangeModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">❌ إلغاء</button>
</div>
</div>
</div>

<!-- Modal for Complaint Reply -->
<div id="complaintReplyModal" style="display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(15px); overflow-y: auto;">
<div style="background: white; margin: 5% auto; padding: 45px; width: 92%; max-width: 600px; border-radius: 35px; position: relative;">
<span onclick="document.getElementById('complaintReplyModal').style.display='none'" style="position: absolute; top: 20px; left: 25px; color: var(--danger); font-size: 45px; cursor: pointer;">&times;</span>
<h3 style="color: var(--secondary); font-size: 1.8rem; margin-bottom: 30px; text-align: center;">💬 الرد على الشكوى</h3>

<div class="input-group">
<label style="font-size: 1.1rem; color: var(--secondary);">نص الرد:</label>
<textarea id="complaintReplyText" rows="6" placeholder="اكتب الرد على الشكوى..." style="padding: 16px; border-radius: 12px; border: 3px solid var(--secondary); width: 100%; font-size: 1.05rem; line-height: 1.8;"></textarea>
</div>

<!-- WhatsApp Notification Checkbox -->
<div style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); padding: 20px; border-radius: 15px; margin: 25px 0; border: 2px solid rgba(37, 211, 102, 0.3);">
<label style="display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 1.1rem; color: #16a34a; font-weight: 700;">
<input type="checkbox" id="sendWhatsAppReply" checked style="width: 24px; height: 24px; cursor: pointer; accent-color: #16a34a;">
<span>📱 إرسال الرد عبر واتساب للمواطن</span>
</label>
<small style="display: block; text-align: center; color: #666; margin-top: 10px; font-size: 0.9rem;">سيتم إرسال نص الرد كاملاً</small>
</div>

<div style="display:flex; gap:15px; margin-top:35px;">
<button id="confirmComplaintReplyBtn" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); color: white;">✅ إرسال الرد</button>
<button onclick="document.getElementById('complaintReplyModal').style.display='none'" class="btn" style="flex:1; padding:18px; font-size: 1.1rem; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white;">❌ إلغاء</button>
</div>
</div>
</div>

</div>

<!-- Egyptian Flag Stripe -->
<div style="height: 8px; background: linear-gradient(90deg, #ce1126 0%, #ce1126 33.33%, #ffffff 33.33%, #ffffff 66.66%, #000000 66.66%, #000000 100%); box-shadow: 0 -2px 8px rgba(0,0,0,0.3);"></div>

<!-- Footer -->
<!-- Fixed Developer Credit - Bottom Right Corner -->
<div style="position: fixed; bottom: 8px; right: 8px; background: rgba(0,0,0,0.4); padding: 5px 12px; border-radius: 15px; font-size: 0.65rem; color: rgba(255,255,255,0.7); z-index: 9999; backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 300; letter-spacing: 0.5px; transition: all 0.3s ease;">
تطوير: م/ باهي التهامي | م/ مهند التهامي
</div>

<style>
/* Hover effect for developer credit */
div[style*="bottom: 8px; right: 8px"]:hover {
background: rgba(0,0,0,0.7) !important;
color: rgba(255,255,255,0.95) !important;
transform: scale(1.05);
}
</style>

<!-- JavaScript -->
<script>
console.log('═'.repeat(60));
console.log('✅ منظومة تكويد المركبات - كفر صقر');
console.log('🔒 نظام آمن - Supabase Authentication + RLS');
console.log('✅ آمن 100% للرفع على GitHub');
console.log('═'.repeat(60));

// Navigation Function
function openService(serviceId) {
console.log('🔄 فتح القسم:', serviceId);
document.getElementById('portalSection').style.display = 'none';
document.getElementById(serviceId).style.display = 'block';
document.getElementById('goPortalBtn').style.display = 'inline-flex';
}

// Fill Years
function fillYears() {
const select = document.getElementById('vYear');
if (!select) return;
for (let year = 2000; year <= 2030; year++) {
let opt = document.createElement('option');
opt.value = year;
opt.innerText = year;
select.appendChild(opt);
}
}
fillYears();

// Fill Years for Edit Modal
function fillEditYears() {
const select = document.getElementById('editVYear');
if (!select) return;
for (let year = 2000; year <= 2030; year++) {
let opt = document.createElement('option');
opt.value = year;
opt.innerText = year;
select.appendChild(opt);
}
}
fillEditYears();

// Vehicle Type Selection
function selectVehicleType(type) {
document.querySelectorAll('.vehicle-card').forEach(card => {
card.classList.remove('selected');
});
document.querySelector(`.vehicle-card[data-type="${type}"]`).classList.add('selected');
document.getElementById('vType').value = type;
document.getElementById('selectedVehicleType').innerText = type;
document.getElementById('vehicleTypeSelection').style.display = 'none';
document.getElementById('registrationForm').style.display = 'block';
}

function resetVehicleSelection() {
document.getElementById('vehicleTypeSelection').style.display = 'block';
document.getElementById('registrationForm').style.display = 'none';
document.querySelectorAll('.vehicle-card').forEach(card => {
card.classList.remove('selected');
});
}

// Validate National ID
function validateNationalId(input) {
const nid = input.value.replace(/[^0-9]/g, '');
input.value = nid;
const msgDiv = document.getElementById('nidValidation');

if (nid.length === 0) {
msgDiv.style.display = 'none';
input.style.borderColor = 'var(--glass-border)';
return false;
}

if (nid.length !== 14) {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(231, 76, 60, 0.1)';
msgDiv.style.color = 'var(--danger)';
msgDiv.innerText = '❌ الرقم القومي يجب أن يكون 14 رقم';
input.style.borderColor = 'var(--danger)';
return false;
}

const century = nid[0];
if (!['2', '3'].includes(century)) {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(231, 76, 60, 0.1)';
msgDiv.style.color = 'var(--danger)';
msgDiv.innerText = '❌ الرقم القومي غير صحيح (يجب أن يبدأ بـ 2 أو 3)';
input.style.borderColor = 'var(--danger)';
return false;
}

const year = parseInt((century === '2' ? '19' : '20') + nid.substring(1, 3));
const month = parseInt(nid.substring(3, 5));
const day = parseInt(nid.substring(5, 7));

if (month < 1 || month > 12 || day < 1 || day > 31) {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(231, 76, 60, 0.1)';
msgDiv.style.color = 'var(--danger)';
msgDiv.innerText = '❌ تاريخ الميلاد في الرقم القومي غير صحيح';
input.style.borderColor = 'var(--danger)';
return false;
}

// Don't show the extracted birth date - just confirm the ID is valid
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(39, 174, 96, 0.1)';
msgDiv.style.color = 'var(--secondary)';
msgDiv.innerText = '✅ الرقم القومي صحيح - الآن أدخل تاريخ ميلادك للتحقق';
input.style.borderColor = 'var(--secondary)';

// Don't auto-fill birth date - let user enter it manually
// This is intentional for verification purposes

return true;
}

// Verify Birth Date
function verifyBirthDate() {
const nid = document.getElementById('nationalId').value;
const birthInput = document.getElementById('birthDate').value;
const msgDiv = document.getElementById('birthValidation');

if (!nid || nid.length !== 14 || !birthInput) {
msgDiv.style.display = 'none';
document.getElementById('birthDate').style.borderColor = 'var(--glass-border)';
return;
}

const century = nid[0];
const year = parseInt((century === '2' ? '19' : '20') + nid.substring(1, 3));
const month = parseInt(nid.substring(3, 5));
const day = parseInt(nid.substring(5, 7));

const nidDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

if (birthInput === nidDate) {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(39, 174, 96, 0.1)';
msgDiv.style.color = 'var(--secondary)';
msgDiv.innerText = '✅ تاريخ الميلاد مطابق للرقم القومي - البيانات صحيحة';
document.getElementById('birthDate').style.borderColor = 'var(--secondary)';
return true;
} else {
msgDiv.style.display = 'block';
msgDiv.style.background = 'rgba(231, 76, 60, 0.1)';
msgDiv.style.color = 'var(--danger)';
msgDiv.innerText = '❌ تاريخ الميلاد غير مطابق للرقم القومي - تأكد من البيانات'; 
document.getElementById('birthDate').style.borderColor = 'var(--danger)';
return false;
}
}

// Make functions global
window.selectVehicleType = selectVehicleType;
window.resetVehicleSelection = resetVehicleSelection;
window.validateNationalId = validateNationalId;
window.verifyBirthDate = verifyBirthDate;
window.getStatusDisplay = function(status) {
const statusMap = {
pending: { text: 'قيد المراجعة', color: '#f39c12', icon: '⏳' },
approved: { text: 'تم القبول', color: '#3498db', icon: '✓' },
coded: { text: 'تم التكويد', color: '#27ae60', icon: '✅' },
delivered: { text: 'تم التسليم', color: '#16a085', icon: '🎉' }
};
return statusMap[status] || statusMap.pending;
};

// Update complaint images summary
function updateComplaintImagesSummary() {
const selfie = document.getElementById('compSelfie').files[0];
const idCard = document.getElementById('compIdCard').files[0];
const problemImages = document.getElementById('compProblemImage').files;
const vehicleImage = document.getElementById('compVehicleImage').files[0];

const summary = document.getElementById('compImagesSummary');
const list = document.getElementById('compImagesList');

let hasImages = selfie || idCard || problemImages.length > 0 || vehicleImage;

if (hasImages) {
summary.style.display = 'block';
let html = '';
if (selfie) html += `<div style="color: var(--secondary); font-weight: 600;">✅ صورة سيلفي: ${selfie.name}</div>`;
if (idCard) html += `<div style="color: var(--secondary); font-weight: 600;">✅ صورة البطاقة: ${idCard.name}</div>`;
if (problemImages.length > 0) html += `<div style="color: var(--secondary); font-weight: 600;">✅ صور المشكلة: ${problemImages.length} صورة</div>`;
if (vehicleImage) html += `<div style="color: var(--secondary); font-weight: 600;">✅ صورة المركبة: ${vehicleImage.name}</div>`;
list.innerHTML = html;
} else {
summary.style.display = 'none';
}
}; 
document.getElementById('compSelfie').onchange = updateComplaintImagesSummary; 
document.getElementById('compIdCard').onchange = updateComplaintImagesSummary; 
document.getElementById('compProblemImage').onchange = updateComplaintImagesSummary; 
document.getElementById('compVehicleImage').onchange = updateComplaintImagesSummary;

// Test: Check all sections exist
setTimeout(() => {
const sections = ['portalSection', 'citizenPage', 'inquiryPage', 'complaintsPage', 'complaintInquiryPage'];
sections.forEach(id => {
const el = document.getElementById(id);
console.log(el ? '✅ ' + id + ': موجود' : '❌ ' + id + ': مفقود');
});
}, 500);
</script>

<!-- Secure Configuration - EMBEDDED (لا يحتاج ملفات خارجية) -->
<script>
// ═══════════════════════════════════════════════════════════════
// Secure Configuration - مدمج في الملف
// ═══════════════════════════════════════════════════════════════

console.log('✅ نظام الأمان جاهز - Supabase Authentication');
</script>

<!-- Supabase Authentication SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Initialize Supabase Client
(function() {
    const SUPABASE_URL = 'https://xlieswavjjgqsnczesct.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaWVzd2F2ampncXNuY3plc2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDY3ODMsImV4cCI6MjA4NjkyMjc4M30.B5UvhsGQ80h86pOTFa9Yd9YOjK1DaY-8KPN1mtLBRbk';
    
    // Wait for DOM and Supabase SDK to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSupabase);
    } else {
        initSupabase();
    }
    
    function initSupabase() {
        // Check if Supabase SDK is loaded
        if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
            window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('🔐 Supabase Authentication initialized');
            
            // Check for existing session on page load
            checkExistingSession();
        } else {
            // Retry after a short delay if SDK not loaded yet
            setTimeout(initSupabase, 100);
        }
    }
    
    async function checkExistingSession() {
        const savedSession = sessionStorage.getItem('supabaseSession');
        const savedRole = sessionStorage.getItem('adminRole');
        const savedUsername = sessionStorage.getItem('adminUsername');
        
        if (savedSession && savedRole && savedUsername) {
            try {
                // Verify session is still valid
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();
                
                if (session && !error) {
                    console.log('🔄 استعادة الجلسة السابقة...');
                    
                    // Set global variables
                    window.currentUsername = savedUsername;
                    window.currentRole = savedRole;
                    window.userRole = savedRole;
                    
                    // Hide all pages first
                    const portalSection = document.getElementById('portalSection');
                    const citizenPage = document.getElementById('citizenPage');
                    const inquiryPage = document.getElementById('inquiryPage');
                    const complaintsPage = document.getElementById('complaintsPage');
                    const complaintInquiryPage = document.getElementById('complaintInquiryPage');
                    const adminPage = document.getElementById('adminPage');
                    const loginModal = document.getElementById('loginModal');
                    const loginBtn = document.getElementById('loginBtn');
                    const logoutBtn = document.getElementById('logoutBtn');
                    const goPortalBtn = document.getElementById('goPortalBtn');
                    
                    if (portalSection) portalSection.style.display = 'none';
                    if (citizenPage) citizenPage.style.display = 'none';
                    if (inquiryPage) inquiryPage.style.display = 'none';
                    if (complaintsPage) complaintsPage.style.display = 'none';
                    if (complaintInquiryPage) complaintInquiryPage.style.display = 'none';
                    if (loginModal) loginModal.style.display = 'none';
                    
                    // Show admin panel
                    if (adminPage) adminPage.style.display = 'block';
                    if (loginBtn) loginBtn.style.display = 'none';
                    if (logoutBtn) logoutBtn.style.display = 'inline-flex';
                    if (goPortalBtn) goPortalBtn.style.display = 'inline-flex';
                    
                    // Add role badge
                    const header = document.querySelector('header');
                    const existingBadge = document.getElementById('roleBadge');
                    if (existingBadge) existingBadge.remove();
                    
                    const roleBadge = savedRole === 'SUPER' ? '👑 مدير عام' : savedRole === 'ADMIN' ? '🔧 مشرف' : '👁️ عرض فقط';
                    const roleColor = savedRole === 'SUPER' ? '#e74c3c' : savedRole === 'ADMIN' ? '#3498db' : '#95a5a6';
                    
                    if (header) {
                        const badge = document.createElement('div');
                        badge.id = 'roleBadge';
                        badge.style.cssText = `background: ${roleColor}; color: white; padding: 8px 20px; border-radius: 12px; font-weight: bold; font-size: 0.9rem;`;
                        badge.innerText = roleBadge;
                        header.appendChild(badge);
                    }
                    
                    // Load data
                    if (typeof loadAdminData === 'function') {
                        await loadAdminData();
                    }
                    console.log('✅ تم استعادة الجلسة بنجاح');
                } else {
                    // Session expired, clear storage
                    sessionStorage.clear();
                    console.log('⚠️ انتهت صلاحية الجلسة');
                }
            } catch (err) {
                console.error('❌ خطأ في استعادة الجلسة:', err);
                sessionStorage.clear();
            }
        }
    }
})();
</script>

<!-- Supabase Storage Upload Function -->
<script type="module">
// Upload to Supabase Storage (Private)
const uploadToSupabaseStorage = async (file) => {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = async (e) => {
const img = new Image();
img.src = e.target.result;
img.onload = async () => {
const canvas = document.createElement('canvas');
const maxWidth = 800;
const scale = img.width > maxWidth ? maxWidth / img.width : 1;
canvas.width = img.width * scale;
canvas.height = img.height * scale;
const ctx = canvas.getContext('2d');
ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

canvas.toBlob(async (blob) => {
try {
const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
const filePath = `images/${fileName}`;

const { data, error } = await window.supabaseClient.storage
.from('vehicle-images')
.upload(filePath, blob, {
contentType: 'image/jpeg',
cacheControl: '3600',
upsert: false
});

if (error) {
reject(new Error(`فشل رفع الصورة: ${error.message}`));
return;
}

// Return file path only (not public URL)
resolve(filePath);
} catch (error) {
reject(new Error(`خطأ في الرفع: ${error.message}`));
}
}, 'image/jpeg', 0.70);
};
};
});
};

// Format DateTime
function formatDateTime(ts) {
if (!ts) return "-";
const d = new Date(ts);
return d.toLocaleDateString('ar-EG') + " " + d.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
}

// Make formatDateTime globally available
window.formatDateTime = formatDateTime;

// ═══════════════════════════════════════════════════════════════
// Supabase Helper Functions
// ═══════════════════════════════════════════════════════════════

// Add Order to Supabase
async function addOrderToSupabase(orderData) {
const { data, error } = await window.supabaseClient
.from('orders')
.insert([orderData])
.select();
if (error) throw error;
return data[0];
}

// Add Complaint to Supabase
async function addComplaintToSupabase(complaintData) {
const { data, error } = await window.supabaseClient
.from('complaints')
.insert([complaintData])
.select();
if (error) throw error;
return data[0];
}

// Add Admin Log to Supabase
async function logAdminActionToSupabase(username, role, action, details) {
const { data, error } = await window.supabaseClient
.from('admin_logs')
.insert([{
username,
role,
action,
details,
logged_at: Date.now(),
ip_address: 'N/A'
}]);
if (error) console.error('Log error:', error);
}

// Submit Vehicle Registration (WITH ENCRYPTION)
document.getElementById('submitBtn').onclick = async () => {
const btn = document.getElementById('submitBtn');
const files = document.getElementById('multiFiles').files;
const owner = document.getElementById('ownerName').value.trim();
const nid = document.getElementById('nationalId').value.trim();
const phone = document.getElementById('phone').value.trim();
const year = document.getElementById('vYear').value;
const address = document.getElementById('address').value.trim();
const vType = document.getElementById('vType').value;
const birthDate = document.getElementById('birthDate').value;

// التحقق من حجم الصور ونوعها
let totalSize = 0;
for (let file of files) {
  if (file.size > 5242880) { // 5MB
    alert(`❌ حجم الصورة "${file.name}" يتجاوز 5MB\nيرجى اختيار صور أصغر`);
    return;
  }
  totalSize += file.size;
  // التحقق من نوع الملف
  if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
    alert(`❌ الملف "${file.name}" غير صورة صحيحة\nيرجى استخدام JPG أو PNG أو WebP فقط`);
    return;
  }
}

// Validate National ID
if (!validateNationalId(document.getElementById('nationalId'))) {
alert("❌ يرجى إدخال رقم قومي صحيح (14 رقم)");
return;
}

// Verify Birth Date
if (!verifyBirthDate()) {
alert("❌ تاريخ الميلاد غير مطابق للرقم القومي");
return;
}

if (!owner || nid.length !== 14 || phone.length !== 11 || !year || !vType || files.length === 0 || !birthDate) {
alert("❌ يرجى إكمال جميع البيانات المطلوبة");
return;
}

// Check duplicate with birth date verification
 const checkSnap = { empty: true };
if (!checkSnap.empty) {
// Check if birth date matches
const existingData = checkSnap.s[0].data();
if (existingData.birthDate === birthDate) {
alert("❌ هذا الرقم القومي مسجل مسبقاً في المنظومة!");
return;
} else {
alert("⚠️ يوجد رقم قومي مشابه لكن تاريخ الميلاد مختلف. يرجى التحقق من البيانات.");
return;
}
}; 
document.getElementById('loadingSpinner').style.display = 'block';
btn.disabled = true;

try {
const imgUrls = [];
btn.innerText = "جاري رفع الصور...";
for (let i = 0; i < files.length; i++) {
const url = await uploadToSupabaseStorage(files[i]);
imgUrls.push(url);
btn.innerText = `جاري رفع الصورة ${i + 1} من ${files.length}...`;
}

const refNumber = 'KS-' + Date.now().toString().slice(-8);

// Prepare data with encryption for sensitive fields
let dataToSave = {
owner_name: owner,
national_id: nid,
phone,
vehicle_type: vType,
vehicle_year: year,
address,
images: imgUrls,
submitted_at: Date.now(),
ref_number: refNumber,
status: "pending",
code: ""
};

// Save to Supabase
await addOrderToSupabase(dataToSave); 
document.getElementById('loadingSpinner').style.display = 'none';
btn.disabled = false;
btn.innerText = '📋 تسجيل المركبة';

// Send confirmation WhatsApp to citizen
const confirmMessage = `✅ *تم تسجيل طلبك بنجاح!*\n\n` +
`👤 السيد/ة: ${owner}\n` +
`🚜 نوع المركبة: ${vType}\n` +
`📋 الرقم المرجعي: *${refNumber}*\n\n` +
`⚠️ احتفظ بهذا الرقم للاستعلام عن حالة طلبك\n\n` +
`⏳ سيتم مراجعة طلبك والتواصل معك قريباً\n\n` +
`📞 للاستفسار: 01021102607\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;

// Auto-send WhatsApp
if (phone && phone.length === 11) {
const whatsappUrl = `https://wa.me/2${phone}?text=${encodeURIComponent(confirmMessage)}`;
window.open(whatsappUrl, '_blank');
}

alert(`✅ تم تسجيل بياناتك بنجاح!\n\n📋 رقمك المرجعي: ${refNumber}\n\n⚠️ احتفظ بهذا الرقم للاستعلام عن حالة طلبك\n\n📱 سيتم فتح واتساب لإرسال تأكيد الاستلام`);
location.reload();
} catch (e) {
document.getElementById('loadingSpinner').style.display = 'none';
alert("❌ حدث خطأ: " + e.message);
btn.disabled = false;
btn.innerText = "إرسال الطلب ✅";
}
};

// Inquiry Button
document.getElementById('inquiryBtn').onclick = async () => {
const owner = document.getElementById('inqOwnerName').value.trim();
const nid = document.getElementById('inqNationalId').value.trim();
const phone = document.getElementById('inqPhone').value.trim();

if (!owner || nid.length !== 14 || phone.length !== 11) {
alert("❌ يرجى إكمال جميع البيانات بشكل صحيح");
return;
}; 
document.getElementById('loadingSpinner').style.display = 'block';

try {
// First, search in localStorage (imported data)
let localData = null;
try {
const stored = localStorage.getItem('vehicleOrders');
if (stored) {
const orders = JSON.parse(stored);
localData = orders.find(o => 
o.nationalId === nid && 
o.owner === owner && 
o.phone === phone
);
}
} catch (e) {
console.error('خطأ في قراءة LocalStorage:', e);
}

// If found in localStorage, display it
if (localData) {
const resultDiv = document.getElementById('inquiryResult');
resultDiv.style.display = 'block';
resultDiv.style.background = 'linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, rgba(46, 204, 113, 0.08) 100%)';
resultDiv.style.border = '3px solid var(--secondary)';
resultDiv.innerHTML = `
<div style="text-align: center;">
<i style="font-size: 90px; display: block; margin-bottom: 20px; animation: pulse 2s infinite;">✅</i>
<h3 style="color: var(--secondary); margin-bottom: 25px; font-size: 2rem; font-weight: 900;">تم التكويد بنجاح!</h3>
</div>

<div style="background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); padding: 35px; border-radius: 25px; margin: 25px 0; box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3); text-align: center;">
<p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin-bottom: 12px; font-weight: 600;">🔢 كود المركبة الخاص بك</p>
<h2 style="color: white; font-size: 4.5rem; font-weight: 900; margin: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.2); letter-spacing: 3px;">${localData.vCode || 'غير محدد'}</h2>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">نوع المركبة</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">🚜 ${localData.vType}</p>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">الموديل</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">📅 ${localData.vYear || 'غير محدد'}</p>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">العنوان</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0;">📍 ${localData.address || 'غير محدد'}</p>
</div>
</div>

<div style="background: white; padding: 25px; border-radius: 20px; margin: 25px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
<h4 style="color: var(--primary); margin: 0 0 20px 0; font-size: 1.3rem; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">📋 بيانات المركبة</h4>
<div style="display: grid; gap: 12px;">
<p style="margin: 0; color: #555; font-size: 1rem;"><strong>المالك:</strong> ${localData.owner}</p>
<p style="margin: 0; color: #555; font-size: 1rem;"><strong>الرقم القومي:</strong> ${localData.nationalId}</p>
<p style="margin: 0; color: #555; font-size: 1rem;"><strong>الهاتف:</strong> ${localData.phone}</p>
${localData.chassisNumber ? `<p style="margin: 0; color: #555; font-size: 1rem;"><strong>رقم الشاسيه:</strong> ${localData.chassisNumber}</p>` : ''}
${localData.motorNumber ? `<p style="margin: 0; color: #555; font-size: 1rem;"><strong>رقم الموتور:</strong> ${localData.motorNumber}</p>` : ''}
</div>
</div>

<div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(26, 82, 118, 0.1) 100%); padding: 20px; border-radius: 15px; border: 2px solid var(--info); text-align: center;">
<p style="margin: 0; color: var(--info); font-size: 1rem; line-height: 1.8;">
<strong>ℹ️ ملاحظة:</strong> هذه البيانات مستوردة من قاعدة البيانات المحلية
</p>
</div>
`; 
document.getElementById('loadingSpinner').style.display = 'none';
return;
}

// If not found in localStorage, search in Supabase
const { data: orders, error } = await window.supabaseClient
.from('orders')
.select('*')
.eq('national_id', nid)
.eq('owner_name', owner)
.eq('phone', phone);

if (error) throw error;

const data = orders && orders.length > 0 ? orders[0] : null;

const resultDiv = document.getElementById('inquiryResult');

if (!data) {
resultDiv.style.display = 'block';
resultDiv.style.background = 'linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.1) 100%)';
resultDiv.style.border = '3px solid var(--danger)';
resultDiv.innerHTML = `
<i style="font-size: 80px; display: block; margin-bottom: 20px;">❌</i>
<h3 style="color: var(--danger); margin-bottom: 15px; font-size: 1.8rem;">لا توجد بيانات مطابقة</h3>
<p style="color: #666; font-size: 1.1rem;">تأكد من صحة البيانات المدخلة</p>
`;
} else {
const statusInfo = window.getStatusDisplay(data.status || 'pending');

// Build status history HTML with admin info
let historyHTML = '';
if (data.statusHistory && data.statusHistory.length > 0) {
historyHTML = '<div style="background: white; padding: 25px; border-radius: 20px; margin: 25px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">';
historyHTML += '<h4 style="color: var(--primary); margin: 0 0 20px 0; font-size: 1.3rem; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">📋 سجل حالة الطلب</h4>';
historyHTML += '<div style="position: relative; padding-right: 30px;">';

data.statusHistory.forEach((log, index) => {
const logStatusInfo = window.getStatusDisplay(log.status);
const isLast = index === data.statusHistory.length - 1;

// Admin info
let adminInfo = '';
if (log.by) {
if (log.by === 'SUPER') {
adminInfo = '<span style="background: #e74c3c; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px;">👑 مدير عام</span>';
} else if (log.by === 'ADMIN') {
adminInfo = '<span style="background: #3498db; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px;">🔧 مشرف</span>';
} else if (log.by === 'system') {
adminInfo = '<span style="background: #95a5a6; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px;">🤖 النظام</span>';
} else {
adminInfo = `<span style="background: #7f8c8d; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px;">👤 ${log.by}</span>`;
}
}

historyHTML += `
<div style="position: relative; margin-bottom: ${isLast ? '0' : '25px'};">
<div style="position: absolute; right: -30px; top: 5px; width: 18px; height: 18px; background: ${logStatusInfo.color}; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 2;"></div>
${!isLast ? '<div style="position: absolute; right: -21px; top: 23px; width: 2px; height: calc(100% + 25px); background: #ddd; z-index: 1;"></div>' : ''}
<div style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(250,250,250,0.95) 100%); padding: 18px; border-radius: 12px; border-right: 4px solid ${logStatusInfo.color}; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;">
<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
<span style="background: ${logStatusInfo.color}; color: white; padding: 6px 14px; border-radius: 8px; font-weight: bold; font-size: 0.95rem;">${logStatusInfo.icon} ${logStatusInfo.text}</span>
${adminInfo}
</div>
<span style="color: #999; font-size: 0.85rem; font-weight: 600;">${window.formatDateTime(log.timestamp)}</span>
</div>
${log.note ? `<p style="margin: 10px 0 0 0; color: #555; line-height: 1.6; font-size: 0.95rem; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px;">💬 ${log.note}</p>` : ''}
</div>
</div>
`;
});

historyHTML += '</div></div>';
}

if (data.vCode && data.vCode !== "") {
resultDiv.style.display = 'block';
resultDiv.style.background = 'linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, rgba(46, 204, 113, 0.08) 100%)';
resultDiv.style.border = '3px solid var(--secondary)';
resultDiv.innerHTML = `
<div style="text-align: center;">
<i style="font-size: 90px; display: block; margin-bottom: 20px; animation: pulse 2s infinite;">✅</i>
<h3 style="color: var(--secondary); margin-bottom: 25px; font-size: 2rem; font-weight: 900;">تم التكويد بنجاح!</h3>
</div>

<div style="background: linear-gradient(135deg, var(--secondary) 0%, #229954 100%); padding: 35px; border-radius: 25px; margin: 25px 0; box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3); text-align: center;">
<p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin-bottom: 12px; font-weight: 600;">🔢 كود المركبة الخاص بك</p>
<h2 style="color: white; font-size: 4.5rem; font-weight: 900; margin: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.2); letter-spacing: 3px;">${data.vCode}</h2>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">نوع المركبة</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">🚜 ${data.vType}</p>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">الموديل</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">📅 ${data.vYear || 'غير محدد'}</p>
</div>

</div>

<div style="background: white; padding: 20px; border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
<div>
<p style="color: #999; font-size: 0.85rem; margin: 0 0 5px 0;">📋 الرقم المرجعي</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0; font-family: monospace;">${data.refNumber || 'N/A'}</p>
</div>
<div>
<p style="color: #999; font-size: 0.85rem; margin: 0 0 5px 0;">📅 تاريخ التكويد</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0;">${window.formatDateTime(data.codedAt)}</p>
</div>
</div>
</div>

${historyHTML}

<div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 2px solid rgba(52, 152, 219, 0.3); text-align: center;">
<p style="margin: 0; color: var(--info); font-size: 1rem; line-height: 1.8;">
<strong style="font-size: 1.1rem;">✅ يمكنك الآن استلام المركبة</strong><br>
<span style="font-size: 0.95rem;">توجه إلى مقر رئاسة المركز مع المستندات المطلوبة</span>
</p>
</div>
`;
} else {
resultDiv.style.display = 'block';
resultDiv.style.background = 'linear-gradient(135deg, rgba(243, 156, 18, 0.08) 0%, rgba(214, 137, 16, 0.08) 100%)';
resultDiv.style.border = '3px solid var(--warning)';
resultDiv.innerHTML = `
<div style="text-align: center;">
<i style="font-size: 90px; display: block; margin-bottom: 20px; animation: pulse 2s infinite;">${statusInfo.icon}</i>
<h3 style="color: var(--warning); margin-bottom: 20px; font-size: 2rem; font-weight: 900;">${statusInfo.text}</h3>
</div>

<div style="background: ${statusInfo.color}; color: white; padding: 25px; border-radius: 20px; margin: 25px 0; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
<p style="margin: 0; font-size: 1.3rem; font-weight: bold;">${statusInfo.icon} ${statusInfo.text}</p>
<p style="margin: 10px 0 0 0; font-size: 1rem; opacity: 0.95;">طلبك قيد المعالجة من قبل الإدارة</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">نوع المركبة</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">🚜 ${data.vType}</p>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<p style="color: #999; font-size: 0.9rem; margin: 0 0 8px 0;">الموديل</p>
<p style="color: var(--primary); font-size: 1.3rem; font-weight: bold; margin: 0;">📅 ${data.vYear || 'غير محدد'}</p>
</div>

</div>

<div style="background: white; padding: 20px; border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
<div>
<p style="color: #999; font-size: 0.85rem; margin: 0 0 5px 0;">📋 الرقم المرجعي</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0; font-family: monospace;">${data.refNumber || 'N/A'}</p>
</div>
<div>
<p style="color: #999; font-size: 0.85rem; margin: 0 0 5px 0;">📅 تاريخ التسجيل</p>
<p style="color: var(--primary); font-size: 1.1rem; font-weight: bold; margin: 0;">${window.formatDateTime(data.timestamp)}</p>
</div>
</div>
</div>

${historyHTML}

<div style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.1) 0%, rgba(214, 137, 16, 0.1) 100%); padding: 20px; border-radius: 15px; margin-top: 25px; border: 2px solid rgba(243, 156, 18, 0.3); text-align: center;">
<p style="margin: 0; color: var(--warning); font-size: 1rem; line-height: 1.8;">
<strong style="font-size: 1.1rem;">⏳ يرجى الانتظار</strong><br>
<span style="font-size: 0.95rem;">سيتم مراجعة طلبك والتواصل معك قريباً</span>
</p>
</div>
`;
}
}
document.getElementById('loadingSpinner').style.display = 'none';
} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
alert("❌ حدث خطأ: " + error.message);
}
};

// Submit Complaint
document.getElementById('submitCompBtn').onclick = async () => {
const btn = document.getElementById('submitCompBtn');
const ownerName = document.getElementById('compOwnerName').value.trim();
const nid = document.getElementById('compNationalId').value.trim();
const phone = document.getElementById('compPhone').value.trim();
const compType = document.getElementById('compType').value;
const details = document.getElementById('compDetails').value.trim();

// Get all image files
const selfie = document.getElementById('compSelfie').files[0];
const idCard = document.getElementById('compIdCard').files[0];
const problemImages = document.getElementById('compProblemImage').files;
const vehicleImage = document.getElementById('compVehicleImage').files[0];

if (!ownerName || nid.length !== 14 || phone.length !== 11 || !compType || !details) {
alert("❌ يرجى إكمال جميع البيانات المطلوبة");
return;
}

if (!selfie || !idCard || !vehicleImage) {
alert("❌ يرجى رفع الصور المطلوبة:\n• صورة سيلفي\n• صورة البطاقة\n• صورة المركبة/الكود");
return;
}; 
document.getElementById('loadingSpinner').style.display = 'block';
btn.disabled = true;
btn.innerText = "جاري الإرسال...";

try {
const imgUrls = {
selfie: '',
idCard: '',
problemImages: [],
vehicleImage: ''
};

// Upload selfie
btn.innerText = "جاري رفع صورة السيلفي...";
imgUrls.selfie = await uploadToSupabaseStorage(selfie);

// Upload ID card
btn.innerText = "جاري رفع صورة البطاقة...";
imgUrls.idCard = await uploadToSupabaseStorage(idCard);

// Upload vehicle image
btn.innerText = "جاري رفع صورة المركبة...";
imgUrls.vehicleImage = await uploadToSupabaseStorage(vehicleImage);

// Upload problem images
if (problemImages.length > 0) {
for (let i = 0; i < problemImages.length; i++) {
btn.innerText = `جاري رفع صورة المشكلة ${i + 1} من ${problemImages.length}...`;
const url = await uploadToSupabaseStorage(problemImages[i]);
imgUrls.problemImages.push(url);
}
}

await addComplaintToSupabase({
owner_name: ownerName,
national_id: nid,
phone,
complaint_type: compType,
details,
images: imgUrls,
status: 'pending',
reply: '',
submitted_at: Date.now()
}); 
document.getElementById('loadingSpinner').style.display = 'none';

// Send confirmation WhatsApp to citizen
const confirmMessage = `✅ *تم استلام شكواك بنجاح!*\n\n` +
`👤 السيد/ة: ${ownerName}\n` +
`📋 نوع الشكوى: ${compType}\n` +
`📸 تم رفع جميع الصور المطلوبة\n\n` +
`⏳ سيتم مراجعة شكواك والرد عليك في أقرب وقت\n\n` +
`📞 للاستفسار: 01021102607\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;

// Auto-send WhatsApp (no confirmation needed for citizen's own submission)
if (phone && phone.length === 11) {
const whatsappUrl = `https://wa.me/2${phone}?text=${encodeURIComponent(confirmMessage)}`;
window.open(whatsappUrl, '_blank');
}

alert("✅ تم إرسال شكواك بنجاح!\n\n📋 تم رفع جميع الصور المطلوبة\n⏳ سيتم المراجعة والرد في أقرب وقت.\n\n📱 سيتم فتح واتساب لإرسال تأكيد الاستلام");
location.reload();
} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
alert("❌ خطأ: " + error.message);
btn.disabled = false;
btn.innerText = "إرسال الشكوى ✉️";
}
};

// Complaint Inquiry
document.getElementById('complaintInquiryBtn').onclick = async () => {
const owner = document.getElementById('compInqOwnerName').value.trim();
const nid = document.getElementById('compInqNationalId').value.trim();
const phone = document.getElementById('compInqPhone').value.trim();

if (!owner || nid.length !== 14 || phone.length !== 11) {
alert("❌ يرجى إكمال جميع البيانات بشكل صحيح");
return;
}; 
document.getElementById('loadingSpinner').style.display = 'block';

try {
const q =(compRef("nationalId", "==", nid)("ownerName", "==", owner)("phone", "==", phone)("timestamp", "desc")
);

const snapshot = await(q);
const resultDiv = document.getElementById('complaintInquiryResult');

if (snapshot.empty) {
resultDiv.style.display = 'block';
resultDiv.innerHTML = `
<div style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.1) 100%); padding: 40px; border-radius: 25px; text-align: center; border: 3px solid var(--danger);">
<i style="font-size: 80px; display: block; margin-bottom: 20px;">❌</i>
<h3 style="color: var(--danger); margin-bottom: 15px; font-size: 1.8rem;">لا توجد شكاوى مطابقة</h3>
<p style="color: #666; font-size: 1.1rem;">تأكد من صحة البيانات المدخلة</p>
</div>
`;
} else {
let complaintsHTML = '';
snapshot.forEach((doc) => {
const data = doc.data();
const statusColor = data.status === 'replied' ? 'var(--secondary)' : 'var(--warning)';
const statusText = data.status === 'replied' ? '✅ تم الرد' : '⏳ قيد المراجعة';
const statusBg = data.status === 'replied' ? 'rgba(39, 174, 96, 0.15)' : 'rgba(243, 156, 18, 0.15)';

complaintsHTML += `
<div style="background: linear-gradient(135deg, ${statusBg} 0%, ${statusBg} 100%); padding: 30px; border-radius: 20px; margin-bottom: 20px; border: 3px solid ${statusColor};">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="color: ${statusColor}; margin: 0; font-size: 1.5rem;">${data.type}</h3>
<span style="background: ${statusColor}; color: white; padding: 8px 16px; border-radius: 10px; font-weight: bold;">${statusText}</span>
</div>
<div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
<p style="color: #666; margin: 0; line-height: 1.8;"><strong style="color: var(--primary);">التفاصيل:</strong><br>${data.details}</p>
</div>
<p style="color: #666; font-size: 0.9rem;"><strong>تاريخ التقديم:</strong> ${window.formatDateTime(data.timestamp)}</p>
${data.images ? `
<div style="margin: 15px 0;">
<button class="btn btn-view-inquiry-images" data-id="${doc.id}" style="background: rgba(211, 84, 0, 0.1); color: var(--accent); padding: 10px 20px; border-radius: 12px; font-weight: bold;">🖼️ عرض الصور المرفقة</button>
</div>
` : ''}
${data.status === 'replied' && data.reply ? `
<div style="background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(46, 204, 113, 0.1) 100%); padding: 20px; border-radius: 15px; border: 2px solid var(--secondary); margin-top: 15px;">
<p style="color: var(--secondary); margin: 0 0 10px 0; font-weight: bold; font-size: 1.1rem;">💬 الرد من الإدارة:</p>
<p style="color: #555; margin: 0; line-height: 1.8;">${data.reply}</p>
</div>
` : `
<div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px;">
<p style="color: var(--warning); margin: 0; font-weight: bold;">⏳ شكواك قيد المراجعة، سيتم الرد في أقرب وقت</p>
</div>
`}
</div>
`;
});

resultDiv.style.display = 'block';
resultDiv.innerHTML = `
<h3 style="text-align: center; color: var(--primary); margin-bottom: 30px; font-size: 1.8rem;">شكاويك (${snapshot.size})</h3>
${complaintsHTML}
`;

// Add event listeners for image viewing buttons
const complaintsData = {};
snapshot.forEach((doc) => {
complaintsData[doc.id] = doc.data();
});

resultDiv.querySelectorAll('.btn-view-inquiry-images').forEach(btn => {
btn.onclick = () => {
constId = btn.getAttribute('data--id');
const data = complaintsData[Id];
if (data && data.images) {
if (typeof data.images === 'object' && !Array.isArray(data.images)) {
// New format: categorized images
showCategorizedImages(data.images);
} else if (Array.isArray(data.images)) {
// Old format: array of images
viewImages(data.images);
}
} else {
alert("⚠️ لا توجد صور متاحة للعرض");
}
};
});
}
document.getElementById('loadingSpinner').style.display = 'none';
} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
alert("❌ حدث خطأ: " + error.message);
console.error(error);
}
};
</script>

<!-- Admin Panel JavaScript -->
<script>
// Admin Panel - Supabase Only
let currentEditId = "";
let userRole = "";
let currentUsername = "";

// Log Admin Action to Supabase
async function logAdminAction(username, action, details) {
try {
await window.supabaseClient
.from('admin_logs')
.insert([{
username: username,
role: userRole,
action: action,
details: details,
logged_at: Date.now(),
ip_address: 'N/A'
}]);
} catch (error) {
console.error("Error logging action:", error);
}
}

window.logAdminAction = logAdminAction;

// Send WhatsApp Notification Function
async function sendWhatsAppNotification(phone, message, confirmMessage = "هل تريد إرسال إشعار واتساب للمواطن؟") {
if (!phone || phone.length !== 11) {
return false;
}

const whatsappUrl = `https://wa.me/2${phone}?text=${encodeURIComponent(message)}`;

if (confirm(confirmMessage)) {
window.open(whatsappUrl, '_blank');
return true;
}
return false;
}

window.sendWhatsAppNotification = sendWhatsAppNotification;

// Get Smart Next Code from Supabase
async function getSmartNextCode() {
try {
const { data, error } = await window.supabaseClient
.from('orders')
.select('code')
.not('code', 'is', null)
.order('code', { ascending: false })
.limit(1);

if (error) throw error;

let maxCode = 100;
if (data && data.length > 0 && data[0].code) {
const code = parseInt(data[0].code);
if (!isNaN(code) && code > maxCode) maxCode = code;
}
return { last: maxCode, next: maxCode + 1 };
} catch (error) {
console.error('Error getting next code:', error);
return { last: 100, next: 101 };
}
}

// Make getSmartNextCode global
window.getSmartNextCode = getSmartNextCode;

// Login (SECURE VERSION)
document.getElementById('loginBtn').onclick = () => {
document.getElementById('loginModal').style.display = 'block';
document.getElementById('loginUsername').value = '';
document.getElementById('loginPassword').value = '';
document.getElementById('loginUsername').focus();
}; 
document.getElementById('confirmLoginBtn').onclick = async () => {
const email = document.getElementById('loginUsername').value.trim();
const password = document.getElementById('loginPassword').value.trim();

if (!email || !password) {
alert("❌ يرجى إدخال البريد الإلكتروني وكلمة المرور");
return;
}

// Show loading
const btn = document.getElementById('confirmLoginBtn');
const originalText = btn.innerText;
btn.innerText = '⏳ جاري التحقق...';
btn.disabled = true;

try {
// Sign in with Supabase Authentication
const { data, error } = await window.supabaseClient.auth.signInWithPassword({
email: email,
password: password
});

if (error) {
alert("❌ البريد الإلكتروني أو كلمة المرور غير صحيحة");
btn.innerText = originalText;
btn.disabled = false;
console.error('Supabase login error:', error);
return;
}

// Successful login
const user = data.user;
userRole = 'SUPER'; // All authenticated users are SUPER
currentUsername = user.email.split('@')[0];

// Save session
sessionStorage.setItem('supabaseSession', JSON.stringify(data.session));
sessionStorage.setItem('adminRole', userRole);
sessionStorage.setItem('adminUsername', currentUsername);

// Hide login modal
document.getElementById('loginModal').style.display = 'none';

// Log admin login
await logAdminAction(currentUsername, 'تسجيل دخول', `دخول آمن عبر Supabase Authentication`);

// Show role badge
const roleBadge = userRole === "SUPER" ? "👑 مدير عام" : userRole === "ADMIN" ? "🔧 مشرف" : "👁️ عرض فقط";
const roleColor = userRole === "SUPER" ? "#e74c3c" : userRole === "ADMIN" ? "#3498db" : "#95a5a6";

document.getElementById('portalSection').style.display = 'none';
document.getElementById('citizenPage').style.display = 'none';
document.getElementById('inquiryPage').style.display = 'none';
document.getElementById('complaintsPage').style.display = 'none';
document.getElementById('complaintInquiryPage').style.display = 'none';
document.getElementById('adminPage').style.display = 'block';
document.getElementById('goPortalBtn').style.display = 'inline-flex';
document.getElementById('logoutBtn').style.display = 'inline-flex';
document.getElementById('loginBtn').style.display = 'none';

// Show toggle columns button on mobile only
const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
if (isMobileDevice) {
document.getElementById('toggleColumnsBtn').style.display = 'inline-block';
}

// Add role badge to header
const header = document.querySelector('header');
const existingBadge = document.getElementById('roleBadge');
if (existingBadge) existingBadge.remove();
const badge = document.createElement('div');
badge.id = 'roleBadge';
badge.style.cssText = `background: ${roleColor}; color: white; padding: 8px 20px; border-radius: 12px; font-weight: bold; font-size: 0.9rem;`;
badge.innerText = roleBadge;
header.appendChild(badge);

loadAdminData();
loadComplaints();

// Hide buttons based on role
const bulkImportBtn = document.getElementById('bulkImportBtn');
if (userRole === 'VIEWER' && bulkImportBtn) {
bulkImportBtn.style.display = 'none';
}
const cleanupBtn = document.getElementById('cleanupDuplicatesBtn');
if (userRole === 'SUPER' && cleanupBtn) {
cleanupBtn.style.display = 'inline-flex';
}
} catch (error) {
console.error('❌ خطأ في تسجيل الدخول:', error);
alert("❌ حدث خطأ في تسجيل الدخول");
btn.innerText = originalText;
btn.disabled = false;
btn.innerText = originalText;
btn.disabled = false;
}
};

// Get Signed URL for Private Images
async function getSignedUrl(filePath) {
if (!filePath) return '';

// If it's already a full URL, return it
if (filePath.startsWith('http')) return filePath;

try {
const { data, error } = await window.supabaseClient.storage
.from('vehicle-images')
.createSignedUrl(filePath, 3600); // Valid for 1 hour

if (error) {
console.error('Error getting signed URL:', error);
return filePath;
}

return data.signedUrl;
} catch (err) {
console.error('Error:', err);
return filePath;
}
}

// View Images
async function viewImages(images) {
const modal = document.getElementById("imgModal");
const mainImg = document.getElementById("mainViewImg");
const thumbContainer = document.getElementById("modalThumbnails");

thumbContainer.innerHTML = '';

// Get signed URLs for all images
const signedUrls = await Promise.all(images.map(img => getSignedUrl(img)));
mainImg.src = signedUrls[0];

signedUrls.forEach(src => {
const img = document.createElement('img');
img.src = src;
img.style.width = "80px";
img.style.height = "80px";
img.style.cursor = "pointer";
img.style.objectFit = "cover";
img.style.borderRadius = "15px";
img.style.border = "3px solid white";
img.onclick = () => mainImg.src = src;
thumbContainer.appendChild(img);
});

modal.style.display = "block";
}

// View Categorized Images (for complaints)
async function showCategorizedImages(images) {
const modal = document.getElementById("imgModal");
const mainImg = document.getElementById("mainViewImg");
const thumbContainer = document.getElementById("modalThumbnails");

thumbContainer.innerHTML = '';

// Collect all images with labels
const allImages = [];

if (images.selfie) {
const url = await getSignedUrl(images.selfie);
allImages.push({ url, label: '📸 صورة سيلفي' });
}
if (images.idCard) {
const url = await getSignedUrl(images.idCard);
allImages.push({ url, label: '🪪 صورة البطاقة' });
}
if (images.vehicleImage) {
const url = await getSignedUrl(images.vehicleImage);
allImages.push({ url, label: '🚜 صورة المركبة/الكود' });
}
if (images.problemImages && images.problemImages.length > 0) {
images.problemImages.forEach((url, index) => {
allImages.push({ url: url, label: `📷 صورة المشكلة ${index + 1}` });
});
}

if (allImages.length === 0) {
alert("⚠️ لا توجد صور متاحة للعرض");
return;
}

// Set first image
mainImg.src = allImages[0].url;

// Create thumbnails with labels
allImages.forEach(imgData => {
const container = document.createElement('div');
container.style.textAlign = 'center';

const img = document.createElement('img');
img.src = imgData.url;
img.style.width = "80px";
img.style.height = "80px";
img.style.cursor = "pointer";
img.style.objectFit = "cover";
img.style.borderRadius = "15px";
img.style.border = "3px solid white";
img.onclick = () => mainImg.src = imgData.url;

const label = document.createElement('div');
label.innerText = imgData.label;
label.style.color = 'white';
label.style.fontSize = '0.75rem';
label.style.marginTop = '5px';
label.style.fontWeight = 'bold';

container.appendChild(img);
container.appendChild(label);
thumbContainer.appendChild(container);
});

modal.style.display = "block";
}

// Logout function
window.logoutAdmin = async function() {
if (confirm('هل تريد تسجيل الخروج من لوحة التحكم؟')) {
// Sign out from Supabase
await window.supabaseClient.auth.signOut();
  
sessionStorage.removeItem('supabaseSession');
sessionStorage.removeItem('adminRole');
sessionStorage.removeItem('adminUsername');
document.getElementById('adminPage').style.display = 'none';
document.getElementById('portalSection').style.display = 'block';
document.getElementById('goPortalBtn').style.display = 'none';
document.getElementById('logoutBtn').style.display = 'none';
document.getElementById('loginBtn').style.display = 'inline-flex';
const badge = document.getElementById('roleBadge');
if (badge) badge.remove();
  
console.log('✅ تم تسجيل الخروج من Supabase');
location.reload();
}
};

async function loadAdminData() {
console.log('📥 جاري تحميل البيانات من Supabase...');

const tbody = document.getElementById('dataTable');
tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:20px; font-size:1rem; color:#666;">⏳ جاري تحميل البيانات...</td></tr>';

try {
// Load ALL data from Supabase (no limit)
const { data: orders, error } = await window.supabaseClient
.from('orders')
.select('*')
.order('submitted_at', { ascending: false });

if (error) throw error;

console.log(`✅ تم تحميل ${orders ? orders.length : 0} سجل من Supabase`);

let total = 0, coded = 0, pending = 0;

if (orders && orders.length > 0) {
orders.forEach(item => {
total++;
if (item.status === 'coded' || item.status === 'delivered') {
coded++;
} else if (item.status === 'pending' || item.status === 'approved' || !item.status) {
pending++;
}
});
}

// Convert Supabase data to match expected format
const supabaseOrders = (orders || []).map(item => ({
id: item.id,
owner: item.owner_name || 'غير محدد',
nationalId: item.national_id || '',
phone: item.phone || '',
vType: item.vehicle_type || 'غير محدد',
vYear: item.vehicle_year || '',
chassisNumber: item.chassis_number || '',
motorNumber: item.motor_number || '',
address: item.address || '',
vCode: item.code || '',
refNumber: item.ref_number || '',
timestamp: item.submitted_at || Date.now(),
status: item.status || 'pending',
images: item.images || [],
source: 'supabase'
}));

// Load from LocalStorage
let localOrders = [];
try {
const stored = localStorage.getItem('vehicleOrders');
if (stored) {
const parsed = JSON.parse(stored);
localOrders = parsed.map((item, index) => ({
...item,
id: item.id || `local-${index}`,
source: 'localStorage',
owner: item.owner || item.name || 'غير محدد',
vType: item.vType || 'غير محدد',
nationalId: item.nationalId || '',
phone: item.phone || '',
address: item.address || '',
chassisNumber: item.chassisNumber || '',
motorNumber: item.motorNumber || '',
vCode: item.vCode || '',
vYear: item.vYear || '',
vColor: item.vColor || '',
refNumber: item.refNumber || `REF-${Date.now()}-${index}`,
timestamp: item.timestamp || Date.now(),
status: item.status || 'pending',
images: item.images || []
}));
}
} catch (e) {
console.error('خطأ في قراءة LocalStorage:', e);
}

// Combine both sources (remove duplicates by nationalId AND refNumber)
const allOrders = [...supabaseOrders];
const existingNIDs = new Set(supabaseOrders.map(o => o.nationalId).filter(nid => nid));
const existingRefs = new Set(supabaseOrders.map(o => o.refNumber).filter(ref => ref));

localOrders.forEach(order => {
// Skip if duplicate by nationalId OR refNumber
const isDuplicateNID = order.nationalId && existingNIDs.has(order.nationalId);
const isDuplicateRef = order.refNumber && existingRefs.has(order.refNumber);
  
if (!isDuplicateNID && !isDuplicateRef) {
allOrders.push(order);
if (order.nationalId) existingNIDs.add(order.nationalId);
if (order.refNumber) existingRefs.add(order.refNumber);
total++;
if (order.status === 'coded' || order.status === 'delivered') {
coded++;
} else {
pending++;
}
}
});

console.log(`📊 تم تحميل ${supabaseOrders.length} من Supabase و ${localOrders.length} من LocalStorage (إجمالي: ${allOrders.length} بعد إزالة التكرار)`);

// Save all data to LocalStorage for faster loading next time
try {
const dataToSave = allOrders.map(order => ({
id: order.id,
owner: order.owner,
nationalId: order.nationalId,
phone: order.phone,
address: order.address,
vType: order.vType,
vCode: order.vCode,
vYear: order.vYear,
chassisNumber: order.chassisNumber,
motorNumber: order.motorNumber,
refNumber: order.refNumber,
timestamp: order.timestamp,
status: order.status,
images: order.images || []
}));
localStorage.setItem('vehicleOrders', JSON.stringify(dataToSave));
console.log(`💾 تم حفظ ${dataToSave.length} سجل في LocalStorage للتحميل السريع`);
} catch (e) {
console.warn('⚠️ لم يتم الحفظ في LocalStorage:', e);
}

// Sort by vCode (numeric) - codes first, then non-coded at end
allOrders.sort((a, b) => {
const codeA = a.vCode ? parseInt(a.vCode) : 999999;
const codeB = b.vCode ? parseInt(b.vCode) : 999999;
return codeA - codeB;
});

// Clear table before progressive rendering
const tbodyElement = document.getElementById('dataTable');
if (tbodyElement) {
tbodyElement.innerHTML = '';
}

// Build table rows and render progressively
const ordersArray = [];
tbody.innerHTML = ''; // Clear existing rows

// Detect mobile device
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

// On mobile: render progressively (show first 10 immediately, then load more)
if (isMobile) {
console.log('📱 وضع الموبايل: عرض تدريجي سريع');

// Show first 10 rows IMMEDIATELY
const quickShowCount = Math.min(10, allOrders.length);
const quickFragment = document.createDocumentFragment();

for (let i = 0; i < quickShowCount; i++) {
const item = allOrders[i];
const tr = document.createElement('tr');
tr.innerHTML = `
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:600; font-size:0.7rem;">${item.owner}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-weight:500; font-size:0.65rem;">${item.nationalId}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:500; font-size:0.65rem;">${item.phone || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85);"><span style="background:linear-gradient(135deg, var(--info) 0%, var(--primary) 100%); color:white; padding:2px 4px; border-radius:4px; font-weight:600; font-size:0.65rem;">${item.vType}</span></td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:500; color:#555; font-size:0.65rem;">${item.vYear || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-size:0.6rem; color:${item.chassisNumber ? '#27ae60' : '#999'}; font-weight:500;">${item.chassisNumber || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-size:0.6rem; color:${item.motorNumber ? '#27ae60' : '#999'}; font-weight:500;">${item.motorNumber || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color:#555; font-size:0.65rem;" title="${item.address || '-'}">${item.address || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-size:0.6rem; color:#666;">${window.formatDateTime(item.timestamp)}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:bold; font-size:0.85rem; color:${item.vCode ? 'var(--secondary)' : 'var(--danger)'}">${item.vCode || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85);">🖼️ (${item.images ? item.images.length : 0})</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-size:0.6rem; color:#999;">عرض فقط</td>
`;
quickFragment.appendChild(tr);
ordersArray.push({ element: tr, item: item, id: item.id });
}

tbody.appendChild(quickFragment);
console.log(`⚡ تم عرض أول ${quickShowCount} صف فوراً`);

// Now load the rest progressively (10 at a time)
let currentIndex = quickShowCount;
const batchSize = 10;
const maxRows = Math.min(allOrders.length, 200); // Limit to 200 on mobile

function loadNextBatch() {
if (currentIndex >= maxRows) {
console.log(`✅ تم عرض ${currentIndex} سجل`);
initializePagination(ordersArray);
return;
}

const endIndex = Math.min(currentIndex + batchSize, maxRows);
const fragment = document.createDocumentFragment();

for (let i = currentIndex; i < endIndex; i++) {
const item = allOrders[i];
const tr = document.createElement('tr');
tr.innerHTML = `
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:600; font-size:0.7rem;">${item.owner}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-weight:500; font-size:0.65rem;">${item.nationalId}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:500; font-size:0.65rem;">${item.phone || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85);"><span style="background:linear-gradient(135deg, var(--info) 0%, var(--primary) 100%); color:white; padding:2px 4px; border-radius:4px; font-weight:600; font-size:0.65rem;">${item.vType}</span></td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:500; color:#555; font-size:0.65rem;">${item.vYear || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-size:0.6rem; color:${item.chassisNumber ? '#27ae60' : '#999'}; font-weight:500;">${item.chassisNumber || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-size:0.6rem; color:${item.motorNumber ? '#27ae60' : '#999'}; font-weight:500;">${item.motorNumber || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color:#555; font-size:0.65rem;" title="${item.address || '-'}">${item.address || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-size:0.6rem; color:#666;">${window.formatDateTime(item.timestamp)}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:bold; font-size:0.85rem; color:${item.vCode ? 'var(--secondary)' : 'var(--danger)'}">${item.vCode || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85);">🖼️ (${item.images ? item.images.length : 0})</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-size:0.6rem; color:#999;">عرض فقط</td>
`;
fragment.appendChild(tr);
ordersArray.push({ element: tr, item: item, id: item.id });
}

tbody.appendChild(fragment);
currentIndex = endIndex;

if (currentIndex % 50 === 0) {
console.log(`📊 تم عرض ${currentIndex} من ${maxRows} سجل`);
}

// Continue loading
setTimeout(loadNextBatch, 100); // Load next batch after 100ms
}

// Start loading more after showing first 10
setTimeout(loadNextBatch, 100);

} else {
// Desktop: Progressive rendering
console.log('💻 وضع الكمبيوتر: عرض تدريجي');

// Function to render rows in batches
let renderIndex = 0;
const batchSize = 10;
const renderDelay = 200;
const maxInitialRows = allOrders.length;
const maxIndex = Math.min(maxInitialRows, allOrders.length);

function renderNextBatch() {
try {
// On mobile, stop at 100 rows initially
const endIndex = Math.min(renderIndex + batchSize, maxIndex);
const fragment = document.createDocumentFragment();

for (let i = renderIndex; i < endIndex; i++) {
const item = allOrders[i];
const id = item.id;

const statusInfo = window.getStatusDisplay(item.status || 'pending');
const tr = document.createElement('tr');
tr.innerHTML = `
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:600; font-size:0.7rem;">${item.owner}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-weight:500; font-size:0.65rem;">${item.nationalId}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:500; font-size:0.65rem;">${item.phone || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85);"><span style="background:linear-gradient(135deg, var(--info) 0%, var(--primary) 100%); color:white; padding:2px 4px; border-radius:4px; font-weight:600; font-size:0.65rem;">${item.vType}</span></td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:500; color:#555; font-size:0.65rem;">${item.vYear || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-size:0.6rem; color:${item.chassisNumber ? '#27ae60' : '#999'}; font-weight:500;">${item.chassisNumber || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-size:0.6rem; color:${item.motorNumber ? '#27ae60' : '#999'}; font-weight:500;">${item.motorNumber || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color:#555; font-size:0.65rem;" title="${item.address || '-'}">${item.address || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-size:0.6rem; color:#666;">${window.formatDateTime(item.timestamp)}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:bold; font-size:0.85rem; color:${item.vCode ? 'var(--secondary)' : 'var(--danger)'}">${item.vCode || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85);"><button class="btn view-btn" style="background:rgba(26, 82, 118, 0.12); color:var(--primary); padding:3px 6px; font-weight:600; font-size:0.6rem;">🖼️ (${item.images ? item.images.length : 0})</button></td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); display:flex; gap:2px; flex-wrap:wrap;">
<button class="btn btn-status" title="تغيير الحالة" style="padding:3px 5px; background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'}; font-size:0.65rem;">🔄</button>
<button class="btn btn-code" title="تكويد" style="padding:3px 5px; background: linear-gradient(135deg, var(--info) 0%, #2874a6 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'}; font-size:0.65rem;">🔢</button>
<button class="btn btn-edit" title="تعديل" style="padding:3px 5px; background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'}; font-size:0.65rem;">✏️</button>
<button class="btn btn-del" title="حذف" style="padding:3px 5px; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white; display: ${userRole === 'SUPER' ? 'inline-flex' : 'none'}; font-size:0.65rem;">🗑️</button>
<button class="btn btn-log" title="سجل العمليات" style="padding:3px 5px; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white; font-size:0.65rem;">📋</button>
</td>
`;

tr.querySelector('.btn-status').onclick = async () => {
document.getElementById('statusChangeModal').style.display = 'block';
document.getElementById('newStatusSelect').value = item.status || 'pending';
document.getElementById('statusNote').value = '';
document.getElementById('sendWhatsAppStatus').checked = true;
window.currentStatusChangeItem = { item, id };
};

tr.querySelector('.btn-code').onclick = async () => {
if (item.vCode) {
alert("⚠️ المركبة مكودة بالفعل برقم: " + item.vCode);
return;
}
const info = await getSmartNextCode();
document.getElementById('codeHint').innerText = `آخر كود في النظام: (${info.last}) | الكود المقترح: (${info.next})`;
document.getElementById('manualCodeInput').value = info.next;
document.getElementById('codeModal').style.display = 'block';
document.getElementById('confirmCodeBtn').onclick = async () => {
const newCode = document.getElementById('manualCodeInput').value;
if (!newCode) {
alert("❌ يرجى إدخال كود صحيح");
return;
}
document.getElementById('loadingSpinner').style.display = 'block';
const { error } = await window.supabaseClient
.from('orders')
.update({
vCode: newCode.toString(),
codedAt: Date.now(),
status: "coded",
statusHistory: [...(item.statusHistory || []), {
status: "coded",
timestamp: Date.now(),
note: `تم التكويد برقم: ${newCode}`,
by: userRole
}]
})
.eq('id', id);
if (error) throw error;
await logAdminAction(currentUsername, 'تكويد مركبة', `تم تكويد مركبة ${item.vType} للمالك: ${item.owner} بالكود: ${newCode}`);
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('codeModal').style.display = 'none';
const sendWhatsApp = document.getElementById('sendWhatsAppCode').checked;
if (sendWhatsApp) {
const message = `🎉 *تم تكويد مركبتك بنجاح!*\n\n` +
`👤 السيد/ة: ${item.owner}\n` +
`🔢 كود المركبة: *${newCode}*\n` +
`🚜 نوع المركبة: ${item.vType}\n` +
`📋 الرقم المرجعي: ${item.refNumber}\n\n` +
`✅ يمكنك الآن استلام المركبة من المقر\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;
if (item.phone && item.phone.length === 11) {
const whatsappUrl = `https://wa.me/2${item.phone}?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl, '_blank');
}
}
alert("✅ تم التكويد بنجاح!" + (sendWhatsApp && item.phone && item.phone.length === 11 ? "\n📱 تم فتح واتساب لإرسال الإشعار" : ""));
};
};

tr.querySelector('.btn-edit').onclick = async () => {
document.getElementById('editOwnerName').value = item.owner;
document.getElementById('editPhone').value = item.phone || '';
document.getElementById('editVType').value = item.vType;
document.getElementById('editVYear').value = item.vYear || '';
document.getElementById('editAddress').value = item.address || '';
document.getElementById('editModal').style.display = 'block';
document.getElementById('confirmEditBtn').onclick = async () => {
const newOwner = document.getElementById('editOwnerName').value.trim();
const newPhone = document.getElementById('editPhone').value.trim();
const newVType = document.getElementById('editVType').value;
const newVYear = document.getElementById('editVYear').value;
const newAddress = document.getElementById('editAddress').value.trim();
if (!newOwner || !newPhone || newPhone.length !== 11) {
alert("❌ يرجى إكمال البيانات الأساسية بشكل صحيح");
return;
}
document.getElementById('loadingSpinner').style.display = 'block';
const { error: editError2 } = await window.supabaseClient
.from('orders')
.update({
owner: newOwner,
phone: newPhone,
vType: newVType,
vYear: newVYear,
vDesc: `موديل ${newVYear}`,
address: newAddress,
statusHistory: [...(item.statusHistory || []), {
status: item.status || 'pending',
timestamp: Date.now(),
note: "تم تعديل البيانات",
by: userRole
}]
})
.eq('id', id);
if (editError2) throw editError2;
await logAdminAction(currentUsername, 'تعديل بيانات', `تم تعديل بيانات مركبة ${item.vType} للمالك: ${item.owner} (الرقم المرجعي: ${item.refNumber})`);
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('editModal').style.display = 'none';
alert("✅ تم التعديل بنجاح!");
};
};

tr.querySelector('.btn-del').onclick = async () => {
if (confirm("⚠️ هل أنت متأكد من حذف هذا الطلب نهائياً؟")) {
try {
console.log("DEL:",id);if(!id||id.toString().startsWith("local-")){const s=localStorage.getItem("vehicleOrders");if(s){localStorage.setItem("vehicleOrders",JSON.stringify(JSON.parse(s).filter(x=>x.nationalId!==item.nationalId)));}alert("تم الحذف");await loadAdminData();return;}const s2=localStorage.getItem("vehicleOrders");if(s2){localStorage.setItem("vehicleOrders",JSON.stringify(JSON.parse(s2).filter(x=>x.nationalId!==item.nationalId)));}const{error}=await window.supabaseClient.from("orders").delete().eq("id",id);
if (error) {
console.error('❌ خطأ في الحذف:', error);
alert("❌ فشل الحذف: " + error.message);
return;
}
await logAdminAction(currentUsername, 'حذف طلب', `تم حذف طلب مركبة ${item.vType} للمالك: ${item.owner} (الرقم المرجعي: ${item.refNumber})`);
alert("✅ تم الحذف بنجاح");
await loadAdminData();
} catch (err) {
console.error('❌ خطأ في عملية الحذف:', err);
alert("❌ حدث خطأ أثناء الحذف");
}
}
};

tr.querySelector('.btn-log').onclick = () => {
showActivityLog(item);
};

tr.querySelector('.view-btn').onclick = () => {
if (item.images && item.images.length > 0) {
viewImages(item.images);
} else {
alert("⚠️ لا توجد صور متاحة للعرض");
}
};

fragment.appendChild(tr);
ordersArray.push({ element: tr, item: item, id: id });
}

// Add batch to DOM
tbody.appendChild(fragment);
renderIndex = endIndex;

// Progress update
if (renderIndex % 100 === 0 || renderIndex === maxIndex) {
console.log(`📊 تم عرض ${renderIndex} من ${maxIndex} سجل`);
}

// Continue rendering
if (renderIndex < maxIndex) {
setTimeout(renderNextBatch, renderDelay);
} else {
console.log('✅ تم عرض ' + renderIndex + ' سجل');
initializePagination(ordersArray);
}
} catch (error) {
console.error('❌ خطأ في عرض السجلات:', error);
if (renderIndex < maxIndex) {
setTimeout(renderNextBatch, 500);
}
}
}

// Start progressive rendering
console.log('🚀 بدء العرض التدريجي: ' + allOrders.length + ' سجل');
renderNextBatch();
}; 
document.getElementById('statTotal').innerText = total; 
document.getElementById('statCoded').innerText = coded; 
document.getElementById('statPending').innerText = pending;

console.log('✅ تم تحميل ' + allOrders.length + ' سجل بعد إزالة التكرار');
console.log('🔍 البحث يعمل على كل الـ ' + allOrders.length + ' سجل');

// Show "Load All Data" button if there might be more data
if (supabaseOrders.length >= 50) {document.getElementById('loadAllDataBtn').style.display = 'inline-block';
}
} catch (error) {
console.error('❌ خطأ في تحميل البيانات:', error); 
document.getElementById('dataTable').innerHTML = '<tr><td colspan="12" style="text-align:center; padding:20px; color:var(--danger);">❌ حدث خطأ في تحميل البيانات</td></tr>';
}
}

// Load All Data function
window.loadAllData = async function() {
if (window.isLoadingAll) {
console.log('⏳ التحميل قيد التنفيذ...');
return;
}
window.isLoadingAll = true; 
document.getElementById('loadAllDataBtn').style.display = 'none'; 
document.getElementById('loadingMoreInfo').style.display = 'inline-block';

console.log('📥 جاري تحميل كل البيانات...');

try {

// Load ALL data without

console.log(`✅ تم تحميل كل البيانات: ${supabaseOrders.length} سجل`);

// Process data (same as loadAdminData)
let localOrders = [];
try {
const stored = localStorage.getItem('vehicleOrders');
if (stored) {
const parsed = JSON.parse(stored);
localOrders = parsed.map((item, index) => ({
...item,
id: item.id || `local-${index}`,
source: 'localStorage',
owner: item.owner || item.name || 'غير محدد',
vType: item.vType || 'غير محدد',
nationalId: item.nationalId || '',
phone: item.phone || '',
address: item.address || '',
chassisNumber: item.chassisNumber || '',
motorNumber: item.motorNumber || '',
vCode: item.vCode || '',
vYear: item.vYear || '',
refNumber: item.refNumber || `REF-${Date.now()}-${index}`,
timestamp: item.timestamp || Date.now(),
status: item.status || 'pending',
images: item.images || []
}));
}
} catch (e) {
console.error('خطأ في قراءة LocalStorage:', e);
}

const allOrders = [...supabaseOrders];
const existingNIDs = new Set(supabaseOrders.map(o => o.nationalId).filter(nid => nid));
const existingRefs = new Set(supabaseOrders.map(o => o.refNumber).filter(ref => ref));

localOrders.forEach(order => {
const isDuplicateNID = order.nationalId && existingNIDs.has(order.nationalId);
const isDuplicateRef = order.refNumber && existingRefs.has(order.refNumber);
  
if (!isDuplicateNID && !isDuplicateRef) {
allOrders.push(order);
if (order.nationalId) existingNIDs.add(order.nationalId);
if (order.refNumber) existingRefs.add(order.refNumber);
total++;
if (order.status === 'coded' || order.status === 'delivered') coded++;
else pending++;
}
});

allOrders.sort((a, b) => {
const codeA = a.vCode ? parseInt(a.vCode) : 999999;
const codeB = b.vCode ? parseInt(b.vCode) : 999999;
return codeA - codeB;
});

// Rebuild table with all data
const ordersArray = [];
allOrders.forEach(item => {
const id = item.id;
const statusInfo = window.getStatusDisplay(item.status || 'pending');
const tr = document.createElement('tr');
tr.innerHTML = `
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:600; font-size:0.7rem;">${item.owner}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-weight:500; font-size:0.65rem;">${item.nationalId}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:500; font-size:0.65rem;">${item.phone || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85);"><span style="background:linear-gradient(135deg, var(--info) 0%, var(--primary) 100%); color:white; padding:2px 4px; border-radius:4px; font-weight:600; font-size:0.65rem;">${item.vType}</span></td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:500; color:#555; font-size:0.65rem;">${item.vYear || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-size:0.6rem; color:${item.chassisNumber ? '#27ae60' : '#999'}; font-weight:500;">${item.chassisNumber || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-family:monospace; font-size:0.6rem; color:${item.motorNumber ? '#27ae60' : '#999'}; font-weight:500;">${item.motorNumber || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color:#555; font-size:0.65rem;" title="${item.address || '-'}">${item.address || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-size:0.6rem; color:#666;">${window.formatDateTime(item.timestamp)}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); font-weight:bold; font-size:0.85rem; color:${item.vCode ? 'var(--secondary)' : 'var(--danger)'}">${item.vCode || '-'}</td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85);"><button class="btn view-btn" style="background:rgba(26, 82, 118, 0.12); color:var(--primary); padding:3px 6px; font-weight:600; font-size:0.6rem;">🖼️ (${item.images ? item.images.length : 0})</button></td>
<td style="padding: 3px 2px; background: rgba(255, 255, 255, 0.85); display:flex; gap:2px; flex-wrap:wrap;">
<button class="btn btn-status" title="تغيير الحالة" style="padding:3px 5px; background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'}; font-size:0.65rem;">🔄</button>
<button class="btn btn-code" title="تكويد" style="padding:3px 5px; background: linear-gradient(135deg, var(--info) 0%, #2874a6 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'}; font-size:0.65rem;">🔢</button>
<button class="btn btn-edit" title="تعديل" style="padding:3px 5px; background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%); color: white; display: ${userRole === 'VIEWER' ? 'none' : 'inline-flex'}; font-size:0.65rem;">✏️</button>
<button class="btn btn-del" title="حذف" style="padding:3px 5px; background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white; display: ${userRole === 'SUPER' ? 'inline-flex' : 'none'}; font-size:0.65rem;">🗑️</button>
<button class="btn btn-log" title="سجل العمليات" style="padding:3px 5px; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white; font-size:0.65rem;">📋</button>
</td>
`;

// Attach button handlers
tr.querySelector('.btn-status').onclick = async () => {
document.getElementById('statusChangeModal').style.display = 'block';
document.getElementById('newStatusSelect').value = item.status || 'pending';
document.getElementById('statusNote').value = '';
document.getElementById('sendWhatsAppStatus').checked = true;
window.currentStatusChangeItem = { item, id };
};

tr.querySelector('.btn-code').onclick = async () => {
if (item.vCode) {
alert("⚠️ المركبة مكودة بالفعل برقم: " + item.vCode);
return;
}
const info = await getSmartNextCode();
document.getElementById('codeHint').innerText = `آخر كود في النظام: (${info.last}) | الكود المقترح: (${info.next})`;
document.getElementById('manualCodeInput').value = info.next;
document.getElementById('codeModal').style.display = 'block';
document.getElementById('confirmCodeBtn').onclick = async () => {
const newCode = document.getElementById('manualCodeInput').value;
if (!newCode) {
alert("❌ يرجى إدخال كود صحيح");
return;
}
document.getElementById('loadingSpinner').style.display = 'block';
const { error: codeError2 } = await window.supabaseClient
.from('orders')
.update({
vCode: newCode.toString(),
codedAt: Date.now(),
status: "coded",
statusHistory: [...(item.statusHistory || []), {
status: "coded",
timestamp: Date.now(),
note: `تم التكويد برقم: ${newCode}`,
by: userRole
}]
})
.eq('id', id);
if (codeError2) throw codeError2;
await logAdminAction(currentUsername, 'تكويد مركبة', `تم تكويد مركبة ${item.vType} للمالك: ${item.owner} بالكود: ${newCode}`);
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('codeModal').style.display = 'none';
const sendWhatsApp = document.getElementById('sendWhatsAppCode').checked;
if (sendWhatsApp) {
const message = `🎉 *تم تكويد مركبتك بنجاح!*\n\n` +
`👤 السيد/ة: ${item.owner}\n` +
`🔢 كود المركبة: *${newCode}*\n` +
`🚜 نوع المركبة: ${item.vType}\n` +
`📋 الرقم المرجعي: ${item.refNumber}\n\n` +
`✅ يمكنك الآن استلام المركبة من المقر\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;
if (item.phone && item.phone.length === 11) {
const whatsappUrl = `https://wa.me/2${item.phone}?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl, '_blank');
}
}
alert("✅ تم التكويد بنجاح!" + (sendWhatsApp && item.phone && item.phone.length === 11 ? "\n📱 تم فتح واتساب لإرسال الإشعار" : ""));
};
};

tr.querySelector('.btn-edit').onclick = async () => {
document.getElementById('editOwnerName').value = item.owner;
document.getElementById('editPhone').value = item.phone || '';
document.getElementById('editVType').value = item.vType;
document.getElementById('editVYear').value = item.vYear || '';
document.getElementById('editAddress').value = item.address || '';
document.getElementById('editModal').style.display = 'block';
document.getElementById('confirmEditBtn').onclick = async () => {
const newOwner = document.getElementById('editOwnerName').value.trim();
const newPhone = document.getElementById('editPhone').value.trim();
const newVType = document.getElementById('editVType').value;
const newVYear = document.getElementById('editVYear').value;
const newAddress = document.getElementById('editAddress').value.trim();
if (!newOwner || !newPhone || newPhone.length !== 11) {
alert("❌ يرجى إكمال البيانات الأساسية بشكل صحيح");
return;
}
document.getElementById('loadingSpinner').style.display = 'block';
const { error: editError3 } = await window.supabaseClient
.from('orders')
.update({
owner: newOwner,
phone: newPhone,
vType: newVType,
vYear: newVYear,
vDesc: `موديل ${newVYear}`,
address: newAddress,
statusHistory: [...(item.statusHistory || []), {
status: item.status || 'pending',
timestamp: Date.now(),
note: "تم تعديل البيانات",
by: userRole
}]
})
.eq('id', id);
if (editError3) throw editError3;
await logAdminAction(currentUsername, 'تعديل بيانات', `تم تعديل بيانات مركبة ${item.vType} للمالك: ${item.owner} (الرقم المرجعي: ${item.refNumber})`);
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('editModal').style.display = 'none';
alert("✅ تم التعديل بنجاح!");
};
};

tr.querySelector('.btn-del').onclick = async () => {
if (confirm("⚠️ هل أنت متأكد من حذف هذا الطلب نهائياً؟")) {
try {
console.log("DEL:",id);if(!id||id.toString().startsWith("local-")){const s=localStorage.getItem("vehicleOrders");if(s){localStorage.setItem("vehicleOrders",JSON.stringify(JSON.parse(s).filter(x=>x.nationalId!==item.nationalId)));}alert("تم الحذف");await loadAdminData();return;}const s2=localStorage.getItem("vehicleOrders");if(s2){localStorage.setItem("vehicleOrders",JSON.stringify(JSON.parse(s2).filter(x=>x.nationalId!==item.nationalId)));}const{error}=await window.supabaseClient.from("orders").delete().eq("id",id);
if (error) {
console.error('❌ خطأ في الحذف:', error);
alert("❌ فشل الحذف: " + error.message);
return;
}
await logAdminAction(currentUsername, 'حذف طلب', `تم حذف طلب مركبة ${item.vType} للمالك: ${item.owner} (الرقم المرجعي: ${item.refNumber})`);
alert("✅ تم الحذف بنجاح");
await loadAdminData();
} catch (err) {
console.error('❌ خطأ في عملية الحذف:', err);
alert("❌ حدث خطأ أثناء الحذف");
}
}
};

tr.querySelector('.btn-log').onclick = () => {
showActivityLog(item);
};

tr.querySelector('.view-btn').onclick = () => {
if (item.images && item.images.length > 0) {
viewImages(item.images);
} else {
alert("⚠️ لا توجد صور متاحة للعرض");
}
};

ordersArray.push({ element: tr, item: item, id: id });
});
document.getElementById('statTotal').innerText = total;
document.getElementById('statCoded').innerText = coded;
document.getElementById('statPending').innerText = pending;
document.getElementById('loadingMoreInfo').style.display = 'none';

initializePagination(ordersArray);
console.log(`🎉 تم تحميل كل البيانات بنجاح: ${allOrders.length} سجل`);
window.isLoadingAll = false;

} catch (error) {
console.error('❌ خطأ في تحميل البيانات:', error);
document.getElementById('loadingMoreInfo').style.display = 'none';
document.getElementById('loadAllDataBtn').style.display = 'inline-block';
window.isLoadingAll = false;
alert('حدث خطأ في تحميل البيانات');
}
};

// Load Complaints
function loadComplaints() {
}

// Show Orders/Complaints
document.getElementById('showOrdersBtn').onclick = () => {
document.getElementById('ordersTableContainer').style.display = 'block';
document.getElementById('complaintsTableContainer').style.display = 'none';
document.getElementById('adminLogsTableContainer').style.display = 'none';
showAllOrdersInTable();
};

// Status Change Modal Handler
document.getElementById('confirmStatusChangeBtn').onclick = async () => {
if (!window.currentStatusChangeItem) return;

const { item, id } = window.currentStatusChangeItem;
const newStatus = document.getElementById('newStatusSelect').value;
const note = document.getElementById('statusNote').value.trim();
const sendWhatsApp = document.getElementById('sendWhatsAppStatus').checked;

const statusNames = {
"pending": "قيد المراجعة",
"approved": "تم القبول",
"coded": "تم التكويد",
"delivered": "تم التسليم"
};
document.getElementById('loadingSpinner').style.display = 'block';

const { error: statusError } = await window.supabaseClient
.from('orders')
.update({
status: newStatus,
statusHistory: [...(item.statusHistory || []), {
status: newStatus,
timestamp: Date.now(),
note: note || "",
by: userRole
}]
})
.eq('id', id);
if (statusError) throw statusError;

// Log status change action
await logAdminAction(currentUsername, 'تغيير حالة', `تم تغيير حالة مركبة ${item.vType} للمالك: ${item.owner} إلى: ${statusNames[newStatus]} (الرقم المرجعي: ${item.refNumber})`);

// Send WhatsApp notification if checkbox is checked
if (sendWhatsApp && item.phone && item.phone.length === 11) {
let message = '';
const statusName = statusNames[newStatus];

if (newStatus === 'approved') {
message = `✅ *تم قبول طلبك!*\n\n` +
`👤 السيد/ة: ${item.owner}\n` +
`🚜 نوع المركبة: ${item.vType}\n` +
`📋 الرقم المرجعي: ${item.refNumber}\n\n` +
`✅ الحالة: ${statusName}\n` +
`⏳ طلبك قيد التكويد، سيتم التواصل معك قريباً\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;
} else if (newStatus === 'delivered') {
message = `🎉 *تم تسليم المركبة!*\n\n` +
`👤 السيد/ة: ${item.owner}\n` +
`🚜 نوع المركبة: ${item.vType}\n` +
`🔢 الكود: ${item.vCode || 'غير متوفر'}\n` +
`📋 الرقم المرجعي: ${item.refNumber}\n\n` +
`✅ الحالة: ${statusName}\n` +
`🎊 شكراً لاستخدامكم منظومة التكويد\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;
} else if (newStatus === 'pending') {
message = `⏳ *تحديث حالة الطلب*\n\n` +
`👤 السيد/ة: ${item.owner}\n` +
`🚜 نوع المركبة: ${item.vType}\n` +
`📋 الرقم المرجعي: ${item.refNumber}\n\n` +
`⏳ الحالة: ${statusName}\n` +
`📝 طلبك قيد المراجعة من قبل الإدارة\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;
} else if (newStatus === 'coded') {
message = `✅ *تم تكويد مركبتك!*\n\n` +
`👤 السيد/ة: ${item.owner}\n` +
`🚜 نوع المركبة: ${item.vType}\n` +
`🔢 الكود: ${item.vCode || 'سيتم إبلاغك قريباً'}\n` +
`📋 الرقم المرجعي: ${item.refNumber}\n\n` +
`✅ الحالة: ${statusName}\n` +
`📞 للاستفسار: 01021102607\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;
}

if (message) {
const whatsappUrl = `https://wa.me/2${item.phone}?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl, '_blank');
}
}
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('statusChangeModal').style.display = 'none';
alert("✅ تم تحديث الحالة بنجاح!" + (sendWhatsApp && item.phone && item.phone.length === 11 ? "\n📱 تم فتح واتساب لإرسال الإشعار" : ""));
};

document.getElementById('showComplaintsBtn').onclick = () => {
document.getElementById('ordersTableContainer').style.display = 'none';
document.getElementById('complaintsTableContainer').style.display = 'block';
document.getElementById('adminLogsTableContainer').style.display = 'none';
loadComplaints();
};

// Complaint Reply Modal Handler
document.getElementById('confirmComplaintReplyBtn').onclick = async () => {
if (!window.currentComplaintReply) return;

const { item, id } = window.currentComplaintReply;
const reply = document.getElementById('complaintReplyText').value.trim();
const sendWhatsApp = document.getElementById('sendWhatsAppReply').checked;

if (!reply) {
alert("❌ يرجى كتابة نص الرد");
return;
}
document.getElementById('loadingSpinner').style.display = 'block';

const { error } = await window.supabaseClient
.from('complaints')
.update({
reply: reply,
status: 'replied',
repliedAt: Date.now()
})
.eq('id', id);
if (error) throw error;

// Log complaint reply action
await logAdminAction(currentUsername, 'الرد على شكوى', `تم الرد على شكوى من نوع: ${item.type} للمواطن: ${item.ownerName}`);

// Send WhatsApp notification if checkbox is checked
if (sendWhatsApp && item.phone && item.phone.length === 11) {
const message = `✅ *تم الرد على شكواك!*\n\n` +
`👤 السيد/ة: ${item.ownerName}\n` +
`📋 نوع الشكوى: ${item.type}\n\n` +
`💬 *الرد من الإدارة:*\n${reply}\n\n` +
`📞 للاستفسار: 01021102607\n\n` +
`_رئاسة مركز ومدينة كفر صقر_`;

const whatsappUrl = `https://wa.me/2${item.phone}?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl, '_blank');
}
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('complaintReplyModal').style.display = 'none';
alert("✅ تم حفظ الرد بنجاح!" + (sendWhatsApp && item.phone && item.phone.length === 11 ? "\n📱 تم فتح واتساب لإرسال الرد" : ""));
};

document.getElementById('showAdminLogsBtn').onclick = () => {
document.getElementById('ordersTableContainer').style.display = 'none';
document.getElementById('complaintsTableContainer').style.display = 'none';
document.getElementById('adminLogsTableContainer').style.display = 'block';
loadAdminLogs();
};

// Filter functions for stat cards
function showAllOrders() {
    filteredOrdersData = allOrdersData;
    currentPage = 1;
    renderCurrentPage();
    const ordersContainer = document.getElementById('ordersTableContainer');
    const complaintsContainer = document.getElementById('complaintsTableContainer');
    const logsContainer = document.getElementById('adminLogsContainer');
    
    if (ordersContainer) ordersContainer.style.display = 'block';
    if (complaintsContainer) complaintsContainer.style.display = 'none';
    if (logsContainer) logsContainer.style.display = 'none';
}

function showAllOrdersInTable() {
    // OLD FUNCTION - Replaced by showAllOrders with Pagination
    showAllOrders();
}

function showCodedOrders() {
    filteredOrdersData = allOrdersData.filter(orderData => {
        const item = orderData.item;
        return item.status === 'coded' || item.status === 'delivered';
    });
    currentPage = 1;
    renderCurrentPage();
    const ordersContainer = document.getElementById('ordersTableContainer');
    const complaintsContainer = document.getElementById('complaintsTableContainer');
    const logsContainer = document.getElementById('adminLogsContainer');
    if (ordersContainer) ordersContainer.style.display = 'block';
    if (complaintsContainer) complaintsContainer.style.display = 'none';
    if (logsContainer) logsContainer.style.display = 'none';
}

function showPendingOrders() {
    filteredOrdersData = allOrdersData.filter(orderData => {
        const item = orderData.item;
        return item.status === 'pending' || item.status === 'approved' || !item.status;
    });
    currentPage = 1;
    renderCurrentPage();
    const ordersContainer = document.getElementById('ordersTableContainer');
    const complaintsContainer = document.getElementById('complaintsTableContainer');
    const logsContainer = document.getElementById('adminLogsContainer');
    if (ordersContainer) ordersContainer.style.display = 'block';
    if (complaintsContainer) complaintsContainer.style.display = 'none';
    if (logsContainer) logsContainer.style.display = 'none';
}

function showComplaintsTable() {
    const ordersContainer = document.getElementById('ordersTableContainer');
    const complaintsContainer = document.getElementById('complaintsTableContainer');
    const filterStatus = document.getElementById('filterStatus');
    if (ordersContainer) ordersContainer.style.display = 'none';
    if (complaintsContainer) complaintsContainer.style.display = 'block';
    if (filterStatus) filterStatus.style.display = 'none';
    loadComplaints();
}

// Make functions global
window.showAllOrders = showAllOrders;
window.showCodedOrders = showCodedOrders;
window.showPendingOrders = showPendingOrders;
window.showComplaintsTable = showComplaintsTable;

// Show Activity Log
function showActivityLog(item) {
const modal = document.getElementById('activityLogModal');
const content = document.getElementById('activityLogContent');
const history = item.statusHistory || [];

let html = `
<div style="background: linear-gradient(135deg, rgba(52, 73, 94, 0.1) 0%, rgba(44, 62, 80, 0.1) 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #34495e;">
<h4 style="color: #34495e; margin: 0 0 10px 0;">معلومات الطلب:</h4>
<p style="margin: 5px 0;"><strong>المالك:</strong> ${item.owner}</p>
<p style="margin: 5px 0;"><strong>الرقم المرجعي:</strong> ${item.refNumber || 'N/A'}</p>
<p style="margin: 5px 0;"><strong>نوع المركبة:</strong> ${item.vType}</p>
</div>
`;

if (history.length === 0) {
html += '<p style="text-align: center; color: #999; padding: 40px;">لا يوجد سجل عمليات</p>';
} else {
html += '<div style="position: relative; padding-right: 30px;">';
history.forEach((log, index) => {
const statusInfo = window.getStatusDisplay(log.status);
const isLast = index === history.length - 1;
html += `
<div style="position: relative; margin-bottom: 25px;">
<div style="position: absolute; right: -30px; top: 0; width: 20px; height: 20px; background: ${statusInfo.color}; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
${!isLast ? '<div style="position: absolute; right: -21px; top: 20px; width: 2px; height: calc(100% + 25px); background: #ddd;"></div>' : ''}
<div style="background: white; padding: 20px; border-radius: 15px; border: 2px solid ${statusInfo.color}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<span style="background: ${statusInfo.color}; color: white; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 0.9rem;">${statusInfo.icon} ${statusInfo.text}</span>
<span style="color: #999; font-size: 0.85rem;">${window.formatDateTime(log.timestamp)}</span>
</div>
${log.note ? `<p style="margin: 10px 0 0 0; color: #555; line-height: 1.6;">${log.note}</p>` : ''}
${log.by ? `<p style="margin: 10px 0 0 0; color: #999; font-size: 0.85rem;">بواسطة: ${log.by === 'SUPER' ? '👑 مدير عام' : log.by === 'ADMIN' ? '🔧 مشرف' : log.by}</p>` : ''}
</div>
</div>
`;
});
html += '</div>';
}

content.innerHTML = html;
modal.style.display = 'block';
}

window.showActivityLog = showActivityLog;

// Date Filter
let dateFilterActive = false;
let filterFromTimestamp = null;
let filterToTimestamp = null; 
document.getElementById('dateFilterBtn').onclick = () => {document.getElementById('dateFilterModal').style.display = 'block';
};

// Toggle columns button (mobile only)
document.getElementById('toggleColumnsBtn').onclick = () => {
const table = document.querySelector('#dataTable').parentElement.parentElement.querySelector('table');
if (table.classList.contains('show-all-columns')) {
table.classList.remove('show-all-columns');
document.getElementById('toggleColumnsBtn').innerHTML = '👁️ إظهار كل الأعمدة';
} else {
table.classList.add('show-all-columns');
document.getElementById('toggleColumnsBtn').innerHTML = '👁️ إخفاء الأعمدة الزيادة';
}
};

document.getElementById('applyDateFilterBtn').onclick = () => {
const fromDate = document.getElementById('filterFromDate').value;
const toDate = document.getElementById('filterToDate').value;

if (!fromDate || !toDate) {
alert("❌ يرجى اختيار التاريخ من والى");
return;
}

filterFromTimestamp = new Date(fromDate).setHours(0, 0, 0, 0);
filterToTimestamp = new Date(toDate).setHours(23, 59, 59, 999);
dateFilterActive = true;
document.getElementById('dateFilterModal').style.display = 'none';
document.getElementById('filterStatus').style.display = 'block';
document.getElementById('filterStatusText').innerText = `📅 عرض الطلبات من ${fromDate} إلى ${toDate}`;

applyDateFilter();
};

function clearDateFilter() {
dateFilterActive = false;
filterFromTimestamp = null;
filterToTimestamp = null; 
document.getElementById('filterFromDate').value = ''; 
document.getElementById('filterToDate').value = ''; 
document.getElementById('dateFilterModal').style.display = 'none'; 
document.getElementById('filterStatus').style.display = 'none';
showAllOrdersInTable();
}

window.clearDateFilter = clearDateFilter;

function applyDateFilter() {
let count = 0;
document.querySelectorAll('#dataTable tr').forEach(row => {
const timestampCell = row.cells[5]; // Date column
if (timestampCell) {
const dateText = timestampCell.innerText;
// Try to parse the date - this is approximate
const rowDate = new Date(dateText.split(' ')[0].split('/').reverse().join('-'));
const rowTimestamp = rowDate.getTime();

if (rowTimestamp >= filterFromTimestamp && rowTimestamp <= filterToTimestamp) {
row.style.display = '';
count++;
} else {
row.style.display = 'none';
}
}
}); 
document.getElementById('filterStatusText').innerText = `📅 عرض الطلبات المفلترة (${count} طلب)`;
}

// Load Admin Logs
function loadAdminLogs() {
// Unsubscribe from previous listener if exists
if (adminLogsUnsubscribe && typeof adminLogsUnsubscribe === 'function') {
adminLogsUnsubscribe();
}

adminLogsUnsubscribe =((adminLogsRef("timestamp", "desc")(200)), (snap) => {
const tableBody = document.getElementById('adminLogsTableBody');
tableBody.innerHTML = '';

if (snap.empty) {
tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">لا يوجد سجل عمليات</td></tr>';
return;
}

snap.forEach(s => {
const item = s.data();
const roleIcon = item.role === 'SUPER' ? '👑' : item.role === 'ADMIN' ? '🔧' : '👁️';
const roleText = item.role === 'SUPER' ? 'مدير عام' : item.role === 'ADMIN' ? 'مشرف' : 'عرض فقط';

const tr = document.createElement('tr');
tr.innerHTML = `
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:bold;">
<span style="background: ${item.role === 'SUPER' ? '#e74c3c' : item.role === 'ADMIN' ? '#3498db' : '#95a5a6'}; color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.9rem;">
${roleIcon} ${item.username}
</span>
<br><small style="color: #999; font-size: 0.85rem;">${roleText}</small>
</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-weight:600; color: var(--primary);">${item.action}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); color: #555;">${item.details}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-size:0.9rem; color:#666;">${window.formatDateTime(item.timestamp)}</td>
<td style="padding: 18px; background: rgba(255, 255, 255, 0.85); font-family: monospace; color: #999;">${item.ipAddress || 'N/A'}</td>
`;
tableBody.appendChild(tr);
});
});
}

// Export Excel
document.getElementById('exportExcelBtn').onclick = () => {
const wb = XLSX.utils.table_to_book(document.getElementById("excelTable"));
XLSX.writeFile(wb, `منظومة_كفر_صقر_${new Date().toLocaleDateString('ar-EG')}.xlsx`);
alert("✅ تم تصدير البيانات بنجاح");
};

// Search - استخدام نظام Pagination الجديد
// تم نقل دالة البحث إلى نظام Pagination

// Make functions and variables global
window.viewImages = viewImages;

// Bulk Import - Open Modal instead of new page
document.getElementById('bulkImportBtn').onclick = () => {
document.getElementById('bulkImportModal').style.display = 'block';
document.getElementById('bulkImportFile').value = '';
document.getElementById('importPreview').style.display = 'none';
document.getElementById('importPreview').innerHTML = '';
};

// Upload LocalStorage to Supabase
const uploadBtn = document.getElementById('uploadLocalToSupabaseBtn');
if (uploadBtn) {
uploadBtn.onclick = async () => {
if (!confirm('⚠️ هل تريد رفع كل البيانات المحلية إلى Supabase؟\n\nهذا سيضمن ظهور كل البيانات على جميع الأجهزة.')) {
return;
}

const localData = localStorage.getItem('vehicleOrders');
if (!localData) {
alert('❌ لا توجد بيانات محلية!');
return;
}

const orders = JSON.parse(localData);
alert(`📊 تم العثور على ${orders.length} سجل\n\nسيتم الرفع بسرعة...`); 
document.getElementById('loadingSpinner').style.display = 'block';
let uploaded = 0;
let skipped = 0;
const batchSize = 200; // Upload 200 at a time for maximum speed

console.log(`🚀 بدء الرفع السريع: ${orders.length} سجل`);

for (let i = 0; i < orders.length; i += batchSize) {
const batch = orders.slice(i, Math.min(i + batchSize, orders.length));

// Upload without checking duplicates (faster!)
const promises = batch.map(async (order) => {
try {

uploaded++;
if (uploaded % 100 === 0) {
console.log(`✅ تم رفع ${uploaded} من ${orders.length}`);
}
} catch (err) {
console.error('خطأ:', err);
skipped++;
}
});

await Promise.all(promises);
}
document.getElementById('loadingSpinner').style.display = 'none';
alert(`✅ تم الرفع بنجاح!\n\n📤 تم رفع: ${uploaded} سجل\n❌ فشل: ${skipped} سجل\n\nافتح الموقع من التلفون الآن!`);
};
}

// Cleanup Duplicates Button Handler
if (document.getElementById('cleanupDuplicatesBtn')) {
document.getElementById('cleanupDuplicatesBtn').onclick = async () => {
if (!confirm('⚠️ هل أنت متأكد من تنظيف البيانات المتكررة؟\n\nسيتم:\n✅ حذف السجلات المتكررة من Supabase\n✅ حذف السجلات المتكررة من LocalStorage\n✅ الاحتفاظ بأول سجل فقط لكل رقم قومي\n\n⚠️ هذه العملية لا يمكن التراجع عنها!')) {
return;
}
document.getElementById('loadingSpinner').style.display = 'block';

try {
console.log('🧹 بدء تنظيف البيانات المتكررة...');

// Step 1: Load all data from Supabase
const { data: allSupabaseOrders, error: loadError } = await window.supabaseClient
.from('orders')
.select('*');

if (loadError) throw loadError;

console.log(`📊 تم تحميل ${allSupabaseOrders.length} سجل من Supabase`);

// Step 2: Find duplicates by nationalId and refNumber
const seenNIDs = new Map(); // nationalId -> first record
const seenRefs = new Map(); // refNumber -> first record
const duplicatesToDelete = [];

allSupabaseOrders.forEach(order => {
let isDuplicate = false;

// Check nationalId duplicate
if (order.nationalId) {
if (seenNIDs.has(order.nationalId)) {
isDuplicate = true;
duplicatesToDelete.push({ id: order.id, reason: `رقم قومي مكرر: ${order.nationalId}` });
} else {
seenNIDs.set(order.nationalId, order);
}
}

// Check refNumber duplicate (only if not already marked as duplicate)
if (!isDuplicate && order.refNumber) {
if (seenRefs.has(order.refNumber)) {
isDuplicate = true;
duplicatesToDelete.push({ id: order.id, reason: `رقم مرجعي مكرر: ${order.refNumber}` });
} else {
seenRefs.set(order.refNumber, order);
}
}
});

console.log(`🔍 تم العثور على ${duplicatesToDelete.length} سجل مكرر`);

if (duplicatesToDelete.length === 0) {
alert('✅ لا توجد بيانات متكررة!\n\nقاعدة البيانات نظيفة بالفعل.'); 
document.getElementById('loadingSpinner').style.display = 'none';
return;
}

// Step 3: Delete duplicates from Supabase
let deletedCount = 0;
for (const dup of duplicatesToDelete) {
try {
const { error } = await window.supabaseClient
.from('orders')
.delete()
.eq('id', dup.id);
if (error) throw error;
deletedCount++;
console.log(`✅ تم حذف: ${dup.reason}`);
} catch (e) {
console.error(`❌ فشل حذف ${dup.id}:`, e);
}
}

// Step 4: Clean LocalStorage
try {
const stored = localStorage.getItem('vehicleOrders');
if (stored) {
const localOrders = JSON.parse(stored);
const cleanedLocal = [];
const localSeenNIDs = new Set();
const localSeenRefs = new Set();

localOrders.forEach(order => {
const isDupNID = order.nationalId && localSeenNIDs.has(order.nationalId);
const isDupRef = order.refNumber && localSeenRefs.has(order.refNumber);

if (!isDupNID && !isDupRef) {
cleanedLocal.push(order);
if (order.nationalId) localSeenNIDs.add(order.nationalId);
if (order.refNumber) localSeenRefs.add(order.refNumber);
}
});

const localDeletedCount = localOrders.length - cleanedLocal.length;
localStorage.setItem('vehicleOrders', JSON.stringify(cleanedLocal));
console.log(`🧹 تم حذف ${localDeletedCount} سجل مكرر من LocalStorage`);
}
} catch (e) {
console.error('خطأ في تنظيف LocalStorage:', e);
}

// Step 5: Log the action
await logAdminAction(currentUsername, 'تنظيف البيانات المتكررة', `تم حذف ${deletedCount} سجل مكرر من Supabase`); 
document.getElementById('loadingSpinner').style.display = 'none';
alert(`✅ تم تنظيف البيانات بنجاح!\n\n📊 الإحصائيات:\n🗑️ تم حذف ${deletedCount} سجل مكرر من Supabase\n💾 تم تنظيف LocalStorage\n\n🔄 سيتم تحديث الصفحة الآن...`);
location.reload();

} catch (error) {
console.error('❌ خطأ في تنظيف البيانات:', error);
document.getElementById('loadingSpinner').style.display = 'none';
alert('❌ حدث خطأ أثناء تنظيف البيانات:\n' + error.message);
}
};
}

// Download Template
document.getElementById('downloadTemplateBtn').onclick = () => {
const templateData = [
['الاسم الرباعي', 'الرقم القومي', 'رقم الهاتف', 'نوع المركبة', 'موديل السنة', 'اللون', 'العنوان', 'كود المركبة'],
['محمد أحمد علي حسن', '29501011234567', '01012345678', 'توكتوك', '2020', 'أحمر', 'كفر صقر - حي النصر', ''],
['فاطمة محمود سعيد إبراهيم', '29601021234568', '01098765432', 'موتوسيكل', '2021', 'أسود', 'البوها - شارع الجلاء', '']
];

const ws = XLSX.utils.aoa_to_sheet(templateData);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'نموذج البيانات');
XLSX.writeFile(wb, 'نموذج_استيراد_المركبات.xlsx');
};

// Clean Duplicates Button
document.getElementById('cleanDuplicatesBtn').onclick = async () => {
if (!confirm('🧹 هل تريد تنظيف السجلات المكررة؟\n\nسيتم:\n✅ حذف التكرار من Supabase\n✅ حذف التكرار من LocalStorage\n✅ الاحتفاظ بأحدث سجل فقط')) {
return;
}

const loadingDiv = document.createElement('div');
loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:10000;text-align:center;';
loadingDiv.innerHTML = '<div style="font-size:3rem;margin-bottom:15px;">🧹</div><div style="font-size:1.2rem;color:#333;font-weight:600;">جاري تنظيف السجلات المكررة...</div><div style="margin-top:10px;color:#666;">يرجى الانتظار</div>';
document.body.appendChild(loadingDiv);

try {
// 1. Load all data from Supabase
console.log('📥 جاري تحميل كل البيانات من Supabase...');
const { data: allOrders, error: loadError } = await window.supabaseClient
.from('orders')
.select('*')
.order('submitted_at', { ascending: false });

if (loadError) throw loadError;

console.log(`📊 تم تحميل ${allOrders.length} سجل من Supabase`);

// 2. Find duplicates by national_id
const seenNIDs = new Map(); // national_id -> latest record
const duplicateIds = []; // IDs to delete

allOrders.forEach(order => {
if (!order.national_id) return; // Skip records without national_id

if (seenNIDs.has(order.national_id)) {
// Found duplicate - keep the newer one
const existing = seenNIDs.get(order.national_id);
const existingDate = new Date(existing.submitted_at || 0);
const currentDate = new Date(order.submitted_at || 0);

if (currentDate > existingDate) {
// Current is newer - delete existing, keep current
duplicateIds.push(existing.id);
seenNIDs.set(order.national_id, order);
} else {
// Existing is newer - delete current
duplicateIds.push(order.id);
}
} else {
// First occurrence - keep it
seenNIDs.set(order.national_id, order);
}
});

console.log(`🔍 وجدت ${duplicateIds.length} سجل مكرر`);

if (duplicateIds.length === 0) {
loadingDiv.remove();
alert('✅ لا توجد سجلات مكررة!\n\nجميع السجلات فريدة.');
return;
}

// 3. Delete duplicates from Supabase in batches
console.log('🗑️ جاري حذف السجلات المكررة من Supabase...');
const batchSize = 50;
let deletedCount = 0;

for (let i = 0; i < duplicateIds.length; i += batchSize) {
const batch = duplicateIds.slice(i, i + batchSize);
const { error: deleteError } = await window.supabaseClient
.from('orders')
.delete()
.in('id', batch);

if (deleteError) {
console.error('خطأ في حذف دفعة:', deleteError);
} else {
deletedCount += batch.length;
console.log(`✅ تم حذف ${deletedCount} من ${duplicateIds.length}`);
}
}

// 4. Clean LocalStorage
console.log('🧹 جاري تنظيف LocalStorage...');
const uniqueOrders = Array.from(seenNIDs.values()).map(order => ({
id: order.id,
owner: order.owner_name,
nationalId: order.national_id,
phone: order.phone,
address: order.address,
vType: order.vehicle_type,
vCode: order.code || '',
vYear: order.vehicle_year,
chassisNumber: order.chassis_number,
motorNumber: order.motor_number,
refNumber: order.ref_number,
timestamp: order.submitted_at,
status: order.status,
images: order.images || []
}));

localStorage.setItem('vehicleOrders', JSON.stringify(uniqueOrders));
console.log(`💾 تم حفظ ${uniqueOrders.length} سجل فريد في LocalStorage`);

// 5. Reload data
loadingDiv.remove();
alert(`✅ تم تنظيف السجلات المكررة بنجاح!\n\n📊 الإحصائيات:\n• تم حذف: ${deletedCount} سجل مكرر\n• المتبقي: ${uniqueOrders.length} سجل فريد\n\nسيتم تحديث الجدول الآن...`);
await loadAdminData();

} catch (error) {
loadingDiv.remove();
console.error('❌ خطأ في تنظيف السجلات:', error);
alert(`❌ حدث خطأ أثناء تنظيف السجلات:\n\n${error.message}`);
}
};

let importedData = [];

// Read Excel File
document.getElementById('bulkImportFile').onchange = async (e) => {
const file = e.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = (event) => {
try {
const data = new Uint8Array(event.target.result);
const workbook = XLSX.read(data, { type: 'array' });
const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

if (jsonData.length < 2) {
alert('❌ الملف فارغ أو لا يحتوي على بيانات');
return;
}

console.log('📋 عدد الصفوف:', jsonData.length);
console.log('📋 الصف الأول (Header):', jsonData[0]);
console.log('📋 الصف الثاني:', jsonData[1]);

// Try Fixed Columns First (B-H format)
let useFixedColumns = false;
const columnMap = {};
let dataStartRow = 1; // Default: data starts from row 1

// الترتيب الثابت للأعمدة (نفس import_excel.html):
// A=0 (رقم تسلسلي أو فاضي)
// B=1 (الكود), C=2 (الاسم), D=3 (الرقم القومي), E=4 (العنوان), 
// F=5 (الشاسيه), G=6 (الموتور), H=7 (رقم التليفون)

// Check if data follows fixed column format
// Look for actual data (skip header rows)
let foundFixedFormat = false;
for (let i = 1; i < Math.min(jsonData.length, 5); i++) {
if (jsonData[i] && jsonData[i].length >= 4) {
const colC = jsonData[i][2]; // Column C - الاسم
const colD = jsonData[i][3]; // Column D - الرقم القومي

// Skip if row looks like header
const colCStr = String(colC || '').trim();
const colDStr = String(colD || '').trim();
if (colCStr.includes('اسم') || colCStr.includes('الاسم') || 
    colDStr.includes('قومي') || colDStr.includes('الرقم') ||
    colCStr.includes('name') || colDStr.includes('national')) {
continue; // Skip header row
}

// Check if C has name and D has national ID
if (colC && colD) {
const nameStr = String(colC).trim();
const nidStr = String(colD).replace(/[^0-9]/g, '');

// If C looks like a name (length > 2) and D has digits
if (nameStr.length > 2 && nidStr.length >= 10) {
foundFixedFormat = true;
dataStartRow = i;
console.log('📍 وجدت بيانات في الصف ' + (i + 1));
break;
}
}
}
}

if (foundFixedFormat) {
useFixedColumns = true;
console.log('📍 استخدام الأعمدة الثابتة (B-H)، البيانات تبدأ من الصف ' + (dataStartRow + 1));
}

if (useFixedColumns) {
// Fixed columns: B=1, C=2, D=3, E=4, F=5, G=6, H=7
// نفس الترتيب في import_excel.html
columnMap.vCode = 1;        // B - الكود
columnMap.owner = 2;        // C - الاسم
columnMap.nationalId = 3;   // D - الرقم القومي
columnMap.address = 4;      // E - العنوان
columnMap.chassisNumber = 5; // F - الشاسيه
columnMap.motorNumber = 6;   // G - الموتور
columnMap.phone = 7;         // H - رقم التليفون
console.log('✅ تم تحديد الأعمدة الثابتة:', columnMap);
} else {
// Smart Column Detection
const headers = jsonData[0].map(h => String(h).toLowerCase().trim());

const patterns = {
owner: ['اسم', 'الاسم', 'المالك', 'name', 'owner'],
nationalId: ['رقم قومي', 'القومي', 'بطاقة', 'national', 'id'],
phone: ['هاتف', 'تليفون', 'موبايل', 'phone', 'mobile'],
vType: ['نوع', 'المركبة', 'type', 'vehicle'],
vYear: ['موديل', 'سنة', 'year', 'model'],
vColor: ['لون', 'color'],
address: ['عنوان', 'address', 'العنوان'],
vCode: ['كود', 'code', 'الكود'],
chassisNumber: ['شاسيه', 'chassis', 'الشاسيه'],
motorNumber: ['موتور', 'motor', 'الموتور']
};

// Match columns automatically
for (let i = 0; i < headers.length; i++) {
const header = headers[i];
for (const [key, keywords] of Object.entries(patterns)) {
if (keywords.some(kw => header.includes(kw))) {
columnMap[key] = i;
break;
}
}
}

console.log('🧠 استخدام الاكتشاف التلقائي');
}

// Check required columns
if (columnMap.owner === undefined || columnMap.nationalId === undefined) {
alert('❌ لم يتم العثور على الأعمدة الأساسية (الاسم والرقم القومي)\n\nتأكد من:\n• استخدام الترتيب الصحيح للأعمدة (B-H)\n• أو وضع أسماء الأعمدة في الصف الأول');
return;
}

importedData = [];
const preview = document.getElementById('importPreview');

// Determine starting row for data processing
const startRow = useFixedColumns ? dataStartRow : 1;

let previewHTML = `<h4 style="color: #8e44ad; margin-top: 0;">معاينة البيانات المستوردة (${jsonData.length - startRow} سجل):</h4>
<p style="color: #666; margin-bottom: 15px;">✅ ${useFixedColumns ? 'تم استخدام الأعمدة الثابتة (B-H)' : 'تم اكتشاف الأعمدة تلقائياً'}</p>
<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
<thead>
<tr style="background: #8e44ad; color: white;">
<th style="padding: 8px; border: 1px solid #ddd;">#</th>
<th style="padding: 8px; border: 1px solid #ddd;">الكود</th>
<th style="padding: 8px; border: 1px solid #ddd;">الاسم</th>
<th style="padding: 8px; border: 1px solid #ddd;">الرقم القومي</th>
<th style="padding: 8px; border: 1px solid #ddd;">الهاتف</th>
<th style="padding: 8px; border: 1px solid #ddd;">الشاسيه</th>
<th style="padding: 8px; border: 1px solid #ddd;">الموتور</th>
<th style="padding: 8px; border: 1px solid #ddd;">الحالة</th>
</tr>
</thead>
<tbody>`;

for (let i = startRow; i < jsonData.length; i++) {
const row = jsonData[i];
if (!row || row.length === 0) continue;

// Skip empty rows (check if any cell has data)
const hasData = row.some(cell => cell !== null && cell !== undefined && String(cell).trim() !== '');
if (!hasData) continue;

// Skip if no owner or national ID
if (!row[columnMap.owner] || !row[columnMap.nationalId]) continue;

const record = {
owner: String(row[columnMap.owner] || '').trim(),
nationalId: String(row[columnMap.nationalId] || '').replace(/[^0-9]/g, ''),
phone: String(row[columnMap.phone] || '').replace(/[^0-9]/g, ''),
vType: row[columnMap.vType] || 'توكتوك',
vYear: row[columnMap.vYear] || new Date().getFullYear(),
vColor: row[columnMap.vColor] || '',
address: row[columnMap.address] || '',
vCode: row[columnMap.vCode] ? String(row[columnMap.vCode]).trim() : '',
chassisNumber: row[columnMap.chassisNumber] ? String(row[columnMap.chassisNumber]).trim() : '',
motorNumber: row[columnMap.motorNumber] ? String(row[columnMap.motorNumber]).trim() : ''
};

// Validation (more lenient like import_excel.html)
const isValid = record.owner.length >= 3 && record.nationalId.length >= 10 && (!record.phone || record.phone.length === 11);
importedData.push(record);

const rowNumber = i - startRow + 1; // Calculate correct row number
previewHTML += `<tr style="background: ${isValid ? 'rgba(39, 174, 96, 0.1)' : 'rgba(231, 76, 60, 0.1)'};">
<td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${rowNumber}</td>
<td style="padding: 6px; border: 1px solid #ddd; font-weight: bold; color: ${record.vCode ? '#3498db' : '#999'};">${record.vCode || '-'}</td>
<td style="padding: 6px; border: 1px solid #ddd;">${record.owner}</td>
<td style="padding: 6px; border: 1px solid #ddd; font-family: monospace; font-size: 0.85rem;">${record.nationalId}</td>
<td style="padding: 6px; border: 1px solid #ddd; font-family: monospace;">${record.phone || '-'}</td>
<td style="padding: 6px; border: 1px solid #ddd; font-family: monospace; font-size: 0.8rem; color: ${record.chassisNumber ? '#27ae60' : '#999'};">${record.chassisNumber || '-'}</td>
<td style="padding: 6px; border: 1px solid #ddd; font-family: monospace; font-size: 0.8rem; color: ${record.motorNumber ? '#27ae60' : '#999'};">${record.motorNumber || '-'}</td>
<td style="padding: 6px; border: 1px solid #ddd; font-weight: bold; color: ${isValid ? 'var(--secondary)' : 'var(--danger)'};">${isValid ? '✅' : '❌'}</td>
</tr>`;
}

previewHTML += '</tbody></table>';
preview.innerHTML = previewHTML;
preview.style.display = 'block';

alert(`✅ تم قراءة ${importedData.length} سجل من الملف\n${useFixedColumns ? '📍 تم استخدام الأعمدة الثابتة (B-H)' : '🧠 تم اكتشاف الأعمدة تلقائياً'}`);
} catch (error) {
alert('❌ خطأ في قراءة الملف: ' + error.message);
console.error(error);
}
};
reader.readAsArrayBuffer(file);
};

// Confirm Import
document.getElementById('confirmImportBtn').onclick = async () => {
if (importedData.length === 0) {
alert('❌ لا توجد بيانات للاستيراد');
return;
}

if (!confirm(`هل أنت متأكد من استيراد ${importedData.length} سجل إلى قاعدة البيانات؟\n\n⚠️ سيتم إضافة السجلات الجديدة فقط (لن يتم تعديل السجلات الموجودة)`)) {
return;
}
document.getElementById('loadingSpinner').style.display = 'block';
document.getElementById('importProgress').style.display = 'block';
document.getElementById('confirmImportBtn').disabled = true;

let successCount = 0;
let errorCount = 0;
let duplicateCount = 0;
const errors = [];

// Helper function to update progress
const updateProgress = (current, total, status) => {
const percent = Math.round((current / total) * 100); 
document.getElementById('progressBar').style.width = percent + '%'; 
document.getElementById('progressText').textContent = percent + '%'; 
document.getElementById('progressStatus').textContent = status;
};

try {
// Load existing data from Supabase (not LocalStorage) for accurate duplicate check
updateProgress(0, 100, '⏳ جاري تحميل البيانات من Supabase...');
console.log('📥 جاري تحميل البيانات من Supabase للتحقق من التكرار...');

const { data: existingOrders, error: loadError } = await window.supabaseClient
.from('orders')
.select('national_id')
.not('national_id', 'is', null);

if (loadError) {
console.error('خطأ في تحميل البيانات:', loadError);
throw loadError;
}

console.log(`✅ تم تحميل ${existingOrders.length} سجل من Supabase`);

// Create a Set of existing national IDs for fast lookup
const existingNIDs = new Set(existingOrders.map(o => o.national_id));
console.log(`🔍 عدد الأرقام القومية الموجودة: ${existingNIDs.size}`);

updateProgress(10, 100, '⏳ جاري معالجة البيانات...');
const codeInfo = await getSmartNextCode();
let nextCode = codeInfo.next;

// Process all records
const recordsToAdd = [];
const totalRecords = importedData.length;

for (let i = 0; i < totalRecords; i++) {
const record = importedData[i];

// Update progress every 10 records
if (i % 10 === 0) {
const progress = 10 + Math.round((i / totalRecords) * 40); // 10-50%
updateProgress(progress, 100, `⏳ معالجة السجل ${i + 1} من ${totalRecords}...`);
}

// More lenient validation (like import_excel.html)
if (!record.owner || record.owner.length < 3) {
errorCount++;
errors.push(`السجل ${i + 1}: اسم غير صحيح`);
continue;
}

if (!record.nationalId || record.nationalId.length < 10) {
errorCount++;
errors.push(`السجل ${i + 1}: رقم قومي غير صحيح`);
continue;
}

// Check duplicate in localStorage (much faster)
if (existingNIDs.has(record.nationalId)) {
duplicateCount++;
continue;
}

// Only use code if it exists in Excel, don't auto-generate
const finalCode = record.vCode || null;

const refNumber = 'KS-IMP-' + Date.now().toString().slice(-8) + '-' + i;

const newRecord = {
owner: record.owner,
nationalId: record.nationalId,
phone: record.phone || '',
vType: record.vType,
vYear: record.vYear,
vColor: record.vColor || '',
vDesc: `موديل ${record.vYear}${record.vColor ? ' - لون ' + record.vColor : ''}`,
address: record.address || '',
chassisNumber: record.chassisNumber || '',
motorNumber: record.motorNumber || '',
images: [],
timestamp: Date.now(),
codedAt: record.vCode ? Date.now() : null,
vCode: finalCode,
refNumber: refNumber,
importedBy: 'admin',
importedAt: Date.now(),
status: record.vCode ? "coded" : "pending",
statusHistory: [{
status: record.vCode ? "coded" : "pending",
timestamp: Date.now(),
note: record.vCode ? `استيراد مع كود: ${finalCode}` : "استيراد من Excel - بانتظار التكويد",
by: userRole
}]
};

recordsToAdd.push(newRecord);
existingNIDs.add(record.nationalId); // Add to set to prevent duplicates within import
successCount++;
}

// Save to Supabase first (primary storage)
updateProgress(50, 100, '☁️ جاري الحفظ في Supabase...');
console.log('⏳ جاري الحفظ في Supabase...');
const batchSize = 50; // Supabase batchis 500, we use 50 for safety
for (let i = 0; i < recordsToAdd.length; i += batchSize) {
const batch = recordsToAdd.slice(i, i + batchSize);

// Update progress
const progress = 60 + Math.round((i / recordsToAdd.length) * 35); // 60-95%
updateProgress(progress, 100, `☁️ حفظ ${Math.min(i + batchSize, recordsToAdd.length)} من ${recordsToAdd.length} في Supabase...`);

// Save batch to Supabase in parallel (much faster!)
const savePromises = batch.map(async (record) => {
try {
const { error } = await window.supabaseClient
.from('orders')
.insert([{
owner_name: record.owner,
national_id: record.nationalId,
phone: record.phone,
vehicle_type: record.vType,
vehicle_year: record.vYear,
address: record.address,
chassis_number: record.chassisNumber,
motor_number: record.motorNumber,
images: record.images || [],
submitted_at: record.timestamp,
ref_number: record.refNumber,
status: record.status,
code: record.vCode || '',
coded_at: record.codedAt
}]);
if (error) throw error;
return true;
} catch (e) {
console.error('خطأ في حفظ السجل:', e);
return null;
}
});
await Promise.all(savePromises);

console.log(`✅ تم حفظ ${Math.min(i + batchSize, recordsToAdd.length)} من ${recordsToAdd.length} في Supabase`);
}

// Update LocalStorage cache after successful Supabase save
updateProgress(95, 100, '💾 جاري تحديث الذاكرة المحلية...');
await loadAdminData(); // Reload from Supabase to update LocalStorage

updateProgress(100, 100, '✅ اكتمل الاستيراد!');
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('importProgress').style.display = 'none';
document.getElementById('bulkImportModal').style.display = 'none';

let resultMsg = `✅ اكتمل الاستيراد!\n\n📊 الإحصائيات:\n✅ نجح: ${successCount} سجل\n⚠️ مكرر (تم تخطيه): ${duplicateCount} سجل\n❌ فشل: ${errorCount} سجل\n\n📁 إجمالي السجلات المعالجة: ${importedData.length}\n\n☁️ تم الحفظ في Supabase بنجاح`;
if (errors.length > 0 && errors.length <= 5) {
resultMsg += '\n\n❌ الأخطاء:\n' + errors.slice(0, 5).join('\n');
if (errors.length > 5) {
resultMsg += `\n... و ${errors.length - 5} أخطاء أخرى`;
}
}
alert(resultMsg);

} catch (error) {
document.getElementById('loadingSpinner').style.display = 'none';
document.getElementById('importProgress').style.display = 'none';
document.getElementById('confirmImportBtn').disabled = false;
alert('❌ حدث خطأ أثناء الاستيراد: ' + error.message);
console.error('Import error:', error);
}
};

// On page load - check for existing admin session
(function() {
const savedAuth = sessionStorage.getItem('adminAuth');
const savedRole = sessionStorage.getItem('adminRole');
const savedUsername = sessionStorage.getItem('adminUsername');

if (savedAuth === 'true' && savedRole && savedUsername) {
// Auto-restore admin session
userRole = savedRole;
currentUsername = savedUsername; 
document.getElementById('portalSection').style.display = 'none'; 
document.getElementById('adminPage').style.display = 'block'; 
document.getElementById('goPortalBtn').style.display = 'inline-flex'; 
document.getElementById('logoutBtn').style.display = 'inline-flex'; 
document.getElementById('loginBtn').style.display = 'none';

// Restore badge
const header = document.querySelector('header');
const roleBadge = userRole === 'SUPER' ? '👑 مدير عام' : userRole === 'ADMIN' ? '🔧 مشرف' : '👁️ عرض فقط';
const roleColor = userRole === 'SUPER' ? '#e74c3c' : userRole === 'ADMIN' ? '#3498db' : '#95a5a6';
const badge = document.createElement('div');
badge.id = 'roleBadge';
badge.style.cssText = `background: ${roleColor}; color: white; padding: 8px 20px; border-radius: 12px; font-weight: bold; font-size: 0.9rem;`;
badge.innerText = roleBadge;
header.appendChild(badge);

console.log(`✅ تم استعادة جلسة الدخول: ${currentUsername} (${userRole})`);
}
})();

// ============================================
// PAGINATION SYSTEM
// ============================================
let currentPage = 1;
let recordsPerPage = 100;
let allOrdersData = [];
let filteredOrdersData = [];

window.searchOrders = function() {
const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
const searchType = document.getElementById('searchType') ?document.getElementById('searchType').value : 'all';

if (!searchTerm) {
filteredOrdersData = allOrdersData;
} else {
filteredOrdersData = allOrdersData.filter(orderData => {
const item = orderData.item;

if (searchType === 'all') {
return (
(item.owner && item.owner.toLowerCase().includes(searchTerm)) ||
(item.name && item.name.toLowerCase().includes(searchTerm)) ||
(item.vCode && item.vCode.toString().toLowerCase().includes(searchTerm)) ||
(item.nationalId && item.nationalId.toLowerCase().includes(searchTerm)) ||
(item.phone && item.phone.includes(searchTerm)) ||
(item.refNumber && item.refNumber.toLowerCase().includes(searchTerm)) ||
(item.address && item.address.toLowerCase().includes(searchTerm)) ||
(item.chassisNumber && item.chassisNumber.toLowerCase().includes(searchTerm)) ||
(item.motorNumber && item.motorNumber.toLowerCase().includes(searchTerm))
);
} else if (searchType === 'name') {
return (item.owner && item.owner.toLowerCase().includes(searchTerm)) || (item.name && item.name.toLowerCase().includes(searchTerm));
} else if (searchType === 'code') {
return item.vCode && item.vCode.toString().toLowerCase().includes(searchTerm);
} else if (searchType === 'nationalId') {
return item.nationalId && item.nationalId.includes(searchTerm);
} else if (searchType === 'phone') {
return item.phone && item.phone.includes(searchTerm);
} else if (searchType === 'chassis') {
return item.chassisNumber && item.chassisNumber.toLowerCase().includes(searchTerm);
} else if (searchType === 'motor') {
return item.motorNumber && item.motorNumber.toLowerCase().includes(searchTerm);
}
return false;
});
}
currentPage = 1;
renderCurrentPage();
const resultMsg = filteredOrdersData.length === allOrdersData.length ? 
`🔍 عرض كل السجلات: ${allOrdersData.length}` : 
`🔍 البحث (${searchType}) عن: "${searchTerm}" - النتائج: ${filteredOrdersData.length} من ${allOrdersData.length}`;
console.log(resultMsg);
};

window.changePage = function(direction) {
const totalPages = Math.ceil(filteredOrdersData.length / recordsPerPage) || 1;
currentPage += direction;
if (currentPage < 1) currentPage = 1;
if (currentPage > totalPages) currentPage = totalPages;
renderCurrentPage();
};

window.changeRecordsPerPage = function() {
recordsPerPage = parseInt(document.getElementById('recordsPerPage').value);
currentPage = 1;
renderCurrentPage();
};

function renderCurrentPage() {
const startIndex = (currentPage - 1) * recordsPerPage;
const endIndex = startIndex + recordsPerPage;
const pageData = filteredOrdersData.slice(startIndex, endIndex);
const totalPages = Math.ceil(filteredOrdersData.length / recordsPerPage) || 1; 
document.getElementById('pageInfo').textContent = `صفحة ${currentPage} من ${totalPages}`; 
document.getElementById('totalRecordsInfo').textContent = `إجمالي: ${filteredOrdersData.length} سجل`;

const tableBody = document.getElementById('dataTable');
tableBody.innerHTML = '';

pageData.forEach(orderData => {
const tr = orderData.element;
tableBody.appendChild(tr);
});

const actualEnd = Math.min(endIndex, filteredOrdersData.length);
console.log(`📄 عرض الصفحة ${currentPage}/${totalPages}: السجلات ${startIndex + 1}-${actualEnd} من ${filteredOrdersData.length}`);
}

function initializePagination(ordersArray) {
allOrdersData = ordersArray;
filteredOrdersData = ordersArray;
currentPage = 1;
renderCurrentPage();
}

console.log('✅ نظام Pagination جاهز');

</script>

</body>
</html>

